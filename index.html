<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #1e3a8a; --accent: #3b82f6; --success: #10b981; 
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: var(--dark); display: flex; flex-direction: column; min-height: 100vh; }
        .navbar { background: var(--primary); color: white; padding: 25px; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; border-bottom: 4px solid var(--accent); }
        .container { padding: 30px; max-width: 1300px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: var(--white); padding: 35px 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .menu-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .menu-card .icon { font-size: 50px; margin-bottom: 15px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; border-top: 5px solid var(--accent); }
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn-blue { background: var(--accent); } .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-orange { background: var(--warning); } .btn-dark { background: var(--dark); }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .field { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
        label { font-size: 11px; font-weight: 800; margin-bottom: 5px; color: #64748b; }
        input, select, textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .table-res { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 12px; color: var(--primary); font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .hidden-form { display: none; margin-top: 20px; padding: 15px; border: 2px dashed #3b82f6; border-radius: 12px; }
        .history-container { display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #cbd5e1; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        
        /* New Styles for Quiz */
        .quiz-option { display: block; padding: 10px; margin: 5px 0; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; }
        .quiz-option:hover { background: #eff6ff; }
        
        @media print {
            .navbar, .btn, .btn-group, .form-group, .dashboard-grid, .no-print, #back-area, .btn-orange, .btn-green, .semester-switcher { display: none !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            #print-footer { display: block !important; margin-top: 40px; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body { background: white; }
            table { font-size: 10px; width: 100%; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; }
            .print-footer-table { width: 100%; border: none !important; margin-top: 30px; }
            .print-footer-table td { border: none !important; text-align: center; width: 50% !important; vertical-align: top; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlayCeklok"></div>
<div id="modalCeklok">
    <span style="font-size: 50px;">üìç</span>
    <h4>PRESENSI GURU</h4>
    <p id="statusLokasi" style="font-size: 12px; color: #64748b;">Mendeteksi lokasi Anda...</p>
    <div id="infoWaktu" style="margin-bottom: 15px; font-weight: bold; color: var(--primary);"></div>
    <button id="btnKirimAbsen" disabled onclick="submitCeklok()" class="btn btn-green" style="width: 100%; justify-content: center; padding: 15px;">CEKLOK SEKARANG</button>
    <button onclick="submitIzinSakit()" class="btn btn-orange" style="width: 100%; justify-content: center; padding: 10px; margin-top: 5px;">LAPOR IZIN / SAKIT</button>
    <button onclick="closeModalCeklok()" style="margin-top: 15px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold;">TUTUP</button>
</div>

<div id="print-header" style="display:none;">
    <h1 id="pSekolah">NAMA SEKOLAH</h1>
    <h2 id="pTitle">LAPORAN CAPAIAN HASIL BELAJAR</h2>
    <hr>
</div>

<div class="navbar">
    <h2 id="main-title">üöÄ ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</h2>
</div>

<div class="container">
    <div id="tab-login" class="tab-content" style="display: block;">
        <h3 style="text-align:center">Silakan Pilih Akun:</h3>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="selectRole('GK1', 'üè´ KELAS 1', 'SITI ROKAYAH,S.Pd')"><span class="icon">üè´</span><h3>KELAS 1</h3><p>SITI ROKAYAH,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK2', 'üè´ KELAS 2', 'VIKA NURATIKA,S.Pd')"><span class="icon">üè´</span><h3>KELAS 2</h3><p>VIKA NURATIKA,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK3', 'üè´ KELAS 3', 'RISKA WIDIA ROSANA,S.PD')"><span class="icon">üè´</span><h3>KELAS 3</h3><p>RISKA WIDIA ROSANA,S.PD</p></div>
            <div class="menu-card" onclick="selectRole('GK4', 'üè´ KELAS 4', 'DEDE YUDIASTUTI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 4</h3><p>DEDE YUDIASTUTI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK5', 'üè´ KELAS 5', 'SILVYRA RISMAWATI,S.Pd.SD')"><span class="icon">üè´</span><h3>KELAS 5</h3><p>SILVYRA RISMAWATI,S.Pd.SD</p></div>
            <div class="menu-card" onclick="selectRole('GK6', 'üè´ KELAS 6', 'ESIH IMAWATI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 6</h3><p>ESIH IMAWATI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PJOK', 'üèÉ‚Äç‚ôÇÔ∏è GURU PJOK', 'INDRA SETIAWAN,S.Pd')"><span class="icon">üèÉ‚Äç‚ôÇÔ∏è</span><h3>GURU PJOK</h3><p>INDRA SETIAWAN,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PAI', 'üïå GURU PAI', 'YATI NOVIYATI,S.Pd.I')"><span class="icon">üïå</span><h3>GURU PAI</h3><p>YATI NOVIYATI,S.Pd.I</p></div>
            <div class="menu-card" onclick="selectRole('KEPSEK', 'üë®‚Äçüíº KEPALA SEKOLAH', 'KARYADI, S.Pd')" style="background: #fdf2f2;"><span class="icon">üë®‚Äçüíº</span><h3>KEPALA SEKOLAH</h3><p>KARYADI, S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('OPS', 'üõ†Ô∏è OPERATOR', 'ADMIN OPS')" style="background: #f0fdf4;"><span class="icon">üõ†Ô∏è</span><h3>OPERATOR</h3><p>Admin Sistem</p></div>
            <div class="menu-card" onclick="openLoginSiswa()" style="background: #eef2ff;"><span class="icon">üéì</span><h3>SISWA</h3><p>Masuk Ujian</p></div>
        </div>
    </div>

    <div id="back-area" style="display: none; margin-bottom: 20px;">
        <button class="btn btn-dark" onclick="switchTab('tab-home')">üè† MENU UTAMA</button>
        <button class="btn btn-red" onclick="location.reload()">üö™ GANTI AKUN</button>
    </div>

    <div id="tab-ops" class="tab-content">
        <div class="card">
            <h3>üõ†Ô∏è Panel Operator Sekolah</h3>
            <p>Kelola data master siswa dan bank soal ulangan.</p>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="downloadTemplateSiswa()">üì• Template Siswa</button>
                <input type="file" id="importSiswa" style="display:none" onchange="importExcelSiswa(this)">
                <button class="btn btn-green" onclick="document.getElementById('importSiswa').click()">üì§ Import Siswa</button>
            </div>
            <hr>
            <h3>üìù Distribusi Soal Ulangan</h3>
            <div class="form-group">
                <div class="field"><label>Mata Pelajaran</label><input type="text" id="soalMapel" placeholder="Contoh: Matematika"></div>
                <div class="field"><label>Untuk Kelas</label><select id="soalKls"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="downloadTemplateSoal()">üì• Template Soal</button>
                <input type="file" id="importSoal" style="display:none" onchange="importExcelSoal(this)">
                <button class="btn btn-orange" onclick="document.getElementById('importSoal').click()">üì§ Import & Kirim Soal</button>
            </div>
        </div>
    </div>

    <div id="tab-siswa-ujian" class="tab-content">
        <div class="card" id="area-pilih-ujian">
            <h3>Pilih Ulangan Hari Ini</h3>
            <div id="list-ujian-tersedia" class="dashboard-grid"></div>
        </div>
        <div class="card" id="area-kerjakan-soal" style="display:none">
            <h3 id="judul-ujian"></h3>
            <div id="konten-soal"></div>
            <button class="btn btn-green" onclick="submitJawabanSiswa()" style="width:100%; padding:20px; font-size:18px; margin-top:20px;">KIRIM JAWABAN</button>
        </div>
    </div>

    <div id="tab-home" class="tab-content">
        <div class="dashboard-grid" id="guru-menu">
            <div class="menu-card" onclick="openModalCeklok()" style="background: #f0fdf4; border: 2px solid var(--success);"><span class="icon">üìç</span><h4>CEKLOK ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>IDENTITAS</h4></div>
            <div class="menu-card" onclick="switchTab('tab-siswa')"><span class="icon">üë•</span><h4>SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-master')"><span class="icon">üéØ</span><h4>CP, TP, ATP</h4></div>
            <div class="menu-card" onclick="switchTab('tab-modul')"><span class="icon">üìñ</span><h4>MODUL AJAR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-agenda')"><span class="icon">üìù</span><h4>AGENDA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-absensi')"><span class="icon">‚úÖ</span><h4>ABSENSI SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-rekap-absen')"><span class="icon">üìä</span><h4>REKAP ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-raport')"><span class="icon">üìú</span><h4>RAPOR & NILAI</h4></div>
            <div class="menu-card" onclick="renderRekapNilaiUjian()"><span class="icon">üìù</span><h4>HASIL UJIAN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kegiatan')"><span class="icon">üèÜ</span><h4>EKSKUL/KOKUL</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kosp')"><span class="icon">üìÇ</span><h4>KOSP & LINK</h4></div>
        </div>
        <div class="dashboard-grid" id="kepsek-menu" style="display: none;">
            <div class="menu-card" onclick="renderMonitorAgenda()"><span class="icon">üìã</span><h4>PERSETUJUAN AGENDA</h4></div>
            <div class="menu-card" onclick="renderMonitorKegiatan()"><span class="icon">üèÜ</span><h4>PERSETUJUAN KEGIATAN</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenGuru()"><span class="icon">üë®‚Äçüè´</span><h4>PRESENSI GURU</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenSiswa()"><span class="icon">üìä</span><h4>MONITOR ABSEN SISWA</h4></div>
            <div class="menu-card" onclick="renderMonitorLinkGuru()"><span class="icon">üìÇ</span><h4>DOKUMEN & CP/TP</h4></div>
            <div class="menu-card" onclick="renderMonitorNilai()"><span class="icon">üìú</span><h4>MONITOR NILAI & RAPOR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>PENGATURAN KEPSEK</h4></div>
        </div>
    </div>

    <div id="tab-setup" class="tab-content">
        <div class="card">
            <h3>‚öôÔ∏è Identitas & Foto Profil</h3>
            <div class="profile-photo-container">
                <div class="photo-preview" id="photo-preview-box">
                    <span id="photo-placeholder">üì∏ No Photo</span>
                    <img id="photo-img" src="" style="display:none;">
                </div>
                <input type="file" id="input-foto" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this)">
                <button class="btn btn-dark" onclick="document.getElementById('input-foto').click()">üì§ UPLOAD FOTO PROFIL</button>
            </div>
            <div class="form-group"><div class="field"><label>Nama Sekolah</label><input type="text" id="sSekolah"></div></div>
            <div class="form-group">
                <div class="field"><label>Nama Pengguna</label><input type="text" id="sGuru"></div>
                <div class="field"><label>NIP Pengguna</label><input type="text" id="snipGuru"></div>
                <div class="field"><label>WA Pribadi (628...)</label><input type="text" id="sWaGuru" placeholder="62812345678"></div>
            </div>
            <div id="kepsek-wa-management" class="admin-wa-box" style="display:none;">
                <h4>üõ†Ô∏è Panel Admin: Atur Nomor HP Guru</h4>
                <div id="list-wa-guru-inputs"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Nama Kepala Sekolah</label><input type="text" id="sKepsek"></div>
                <div class="field"><label>NIP Kepala Sekolah</label><input type="text" id="snipKepsek"></div>
                <div class="field"><label>WA Kepsek (628...)</label><input type="text" id="sWaKepsek" placeholder="62812345678"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="saveSetup()">üíæ SIMPAN PERUBAHAN</button>
            </div>
        </div>
    </div>

    <div id="tab-raport" class="tab-content">
        <div class="card">
            <h3>üìú Input Nilai & Rapor</h3>
            <div class="semester-switcher">
                <button id="btnSem1" class="sem-btn active" onclick="setSemester(1)">SEMESTER 1 (GANJIL)</button>
                <button id="btnSem2" class="sem-btn" onclick="setSemester(2)">SEMESTER 2 (GENAP)</button>
            </div>
            <div class="form-group">
                <div class="field">
                    <label>Pilih Kelas</label>
                    <select id="rpKls" onchange="updateMapelFilter('rpMapel', this.value); renderRaport()">
                        <option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option>
                        <option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>
                    </select>
                </div>
                <div class="field">
                    <label>Pilih Mata Pelajaran</label>
                    <select id="rpMapel" onchange="renderRaport()"></select>
                </div>
            </div>
            <button class="btn btn-green" onclick="window.print()">üñ®Ô∏è CETAK RAPOR</button>
            <div class="table-res">
                <table>
                    <thead id="headRaport"></thead>
                    <tbody id="bodyRaport"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-master" class="tab-content">
        <div class="card">
            <h3>üéØ Master CP, TP, ATP</h3>
            <div class="form-group">
                <div class="field">
                    <label>Pilih Kelas</label>
                    <select id="masterKls" onchange="updateMapelFilter('masterMapel', this.value); renderSemuaMaster()">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field">
                    <label>Pilih Mata Pelajaran</label>
                    <select id="masterMapel" onchange="renderSemuaMaster()"></select>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="showMasterForm('formCP')">‚ûï CP</button>
                <button class="btn btn-green" onclick="showMasterForm('formTP')">‚ûï TP</button>
                <button class="btn btn-orange" onclick="showMasterForm('formATP')">‚ûï ATP</button>
                <button class="btn btn-dark" onclick="toggleVisibility('history-master')">üëÅÔ∏è LIHAT RIWAYAT</button>
            </div>
            <div id="formCP" class="hidden-form">
                <h4>A. Capaian Pembelajaran (CP)</h4>
                <div class="form-group"><div class="field"><label>Elemen</label><input type="text" id="cpElemen"></div><div class="field" style="flex:2"><label>Isi CP</label><input type="text" id="cpIsi"></div><div class="field"><label>Kompetensi</label><input type="text" id="cpKompetensi"></div><div class="field"><label>Konten</label><input type="text" id="cpKonten"></div><button class="btn btn-blue" onclick="saveMaster('CP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formTP" class="hidden-form">
                <h4>B. Tujuan Pembelajaran (TP)</h4>
                <div class="form-group"><div class="field"><label>Kode TP</label><input type="text" id="tpKode"></div><div class="field" style="flex:2"><label>Isi TP</label><input type="text" id="tpIsi"></div><div class="field"><label>KKTP</label><input type="text" id="tpKktp"></div><button class="btn btn-green" onclick="saveMaster('TP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formATP" class="hidden-form">
                <h4>C. Alur Tujuan Pembelajaran (ATP)</h4>
                <div class="form-group"><div class="field" style="flex:2"><label>Isi ATP</label><input type="text" id="atpIsi"></div><div class="field"><label>Waktu</label><input type="text" id="atpWaktu"></div><div class="field"><label>Dimensi PPP</label><input type="text" id="atpDimensi"></div><div class="field"><label>Asesmen</label><input type="text" id="atpAsesmen"></div><button class="btn btn-orange" onclick="saveMaster('ATP')">üíæ SIMPAN</button></div>
            </div>
            <div id="history-master" class="history-container">
                <div class="table-res"><table><thead><tr><th>Elemen</th><th>CP</th><th>Kompetensi</th><th>Konten</th><th>AKSI</th></tr></thead><tbody id="bodyCPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>Kode TP</th><th>TP</th><th>KKTP</th><th>AKSI</th></tr></thead><tbody id="bodyTPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>No</th><th>ATP</th><th>Waktu</th><th>Asesmen</th><th>AKSI</th></tr></thead><tbody id="bodyATPNew"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-siswa" class="tab-content">
        <div class="card">
            <h3>üë• Data Siswa</h3>
            <div class="form-group">
                <div class="field"><label>Kelas</label><select id="swKls" onchange="renderSiswa()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                <div class="field"><label>NISN</label><input type="text" id="swNisn"></div>
                <div class="field"><label>NIS</label><input type="text" id="swNis"></div>
                <div class="field"><label>Nama</label><input type="text" id="swNama"></div>
                <button class="btn btn-blue" onclick="saveSiswa()">‚ûï TAMBAH</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-green" onclick="exportSiswaExcel()">üìä EKSPOR EXCEL</button>
                <button class="btn btn-dark" onclick="toggleVisibility('history-siswa')">üëÅÔ∏è LIHAT DATA</button>
            </div>
            <div id="history-siswa" class="history-container">
                <div class="table-res"><table><thead><tr><th>NO</th><th>NISN</th><th>NIS</th><th>NAMA</th><th class="no-print">AKSI</th></tr></thead><tbody id="bodySiswa"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-modul" class="tab-content">
        <div class="card">
            <h3>üìñ Modul Ajar</h3>
            <div class="form-group">
                <div class="field">
                    <label>Kelas</label>
                    <select id="mdKls" onchange="updateMapelFilter('mdMapel', this.value); updateMdTP()">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field"><label>Mata Pelajaran</label><select id="mdMapel" onchange="updateMdTP()"></select></div>
                <div class="field"><label>Pilih TP</label><select id="mdTP" onchange="loadModulDetail()"></select></div>
            </div>
            <div class="card" style="background: #f8fafc;">
                <div class="form-group"><div class="field"><label>Alokasi Waktu</label><input type="text" id="mdWaktu"></div><div class="field"><label>Metode</label><input type="text" id="mdMetode"></div></div>
                <div class="field"><label>Langkah-Langkah</label><textarea id="mdLangkah" rows="8"></textarea></div>
                <div class="form-group"><div class="field"><label>Media</label><input type="text" id="mdMedia"></div><div class="field"><label>Asesmen</label><input type="text" id="mdAsesmen"></div></div>
                <button class="btn btn-blue" onclick="saveModul()" style="width:100%">üíæ SIMPAN MODUL</button>
            </div>
        </div>
    </div>

    <div id="tab-agenda" class="tab-content">
        <div class="card">
            <h3>üìù Agenda Harian</h3>
            <div class="form-group">
                <div class="field">
                    <label>Kelas</label>
                    <select id="agKls" onchange="updateMapelFilter('agMapel', this.value); updateAgTP(); renderAgenda();">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field"><label>Mata Pelajaran</label><select id="agMapel" onchange="updateAgTP()"></select></div>
                <div class="field"><label>Tanggal</label><input type="date" id="agTgl"></div>
                <div class="field"><label>TP</label><select id="agTP"></select></div>
                <div class="field"><label>Materi</label><input type="text" id="agMateri"></div>
                <div class="field"><label>Foto (Opsional)</label><input type="file" id="agFoto" accept="image/*" onchange="processAgendaPhoto(this)"></div>
                <button class="btn btn-blue" onclick="saveAgenda()">üíæ SIMPAN</button>
            </div>
            <div class="table-res"><table><thead><tr><th>TGL</th><th>TP</th><th>MATERI</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead><tbody id="bodyAgenda"></tbody></table></div>
        </div>
    </div>

    <div id="tab-absensi" class="tab-content">
        <div class="card">
            <h3>‚úÖ Absensi Harian Siswa</h3>
            <div class="form-group">
                <select id="abKls" onchange="renderAbsensi()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                <input type="date" id="abTgl" onchange="renderAbsensi()">
            </div>
            <div class="table-res"><table><thead><tr><th>NO</th><th>NAMA</th><th>STATUS</th></tr></thead><tbody id="bodyAbsensi"></tbody></table></div>
        </div>
    </div>

    <div id="tab-rekap-absen" class="tab-content">
        <div class="card">
            <h3>üìä Rekap Bulanan</h3>
            <div class="form-group">
                <select id="rekKls" onchange="renderRekapAbsen()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                <input type="month" id="rekBulan" onchange="renderRekapAbsen()">
            </div>
            <div class="table-res"><table><thead id="headRekap"></thead><tbody id="bodyRekap"></tbody></table></div>
        </div>
    </div>

    <div id="tab-kegiatan" class="tab-content">
        <div class="card">
            <h3>üèÜ Kegiatan Ekstrakulikuler & Kokulikuler</h3>
            <div class="form-group">
                <div class="field"><label>Jenis</label><select id="kgJenis"><option value="Ekstrakulikuler">Ekstrakulikuler</option><option value="Kokulikuler">Kokulikuler</option></select></div>
                <div class="field"><label>Nama Kegiatan</label><input type="text" id="kgNama"></div>
                <div class="field"><label>Tanggal</label><input type="date" id="kgTgl"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Deskripsi</label><textarea id="kgKet"></textarea></div>
                <div class="field"><label>Foto Kegiatan</label><input type="file" id="kgFoto" accept="image/*" onchange="processKegiatanPhoto(this)"></div>
            </div>
            <button class="btn btn-blue" onclick="saveKegiatan()">üíæ AJUKAN KE KEPSEK</button>
            <div class="table-res" style="margin-top:15px;">
                <table><thead><tr><th>JENIS</th><th>NAMA</th><th>TGL</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead>
                <tbody id="bodyKegiatan"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-kosp" class="tab-content">
        <div class="card">
            <h3>üìÇ Link Dokumen KOSP & Perangkat</h3>
            <div class="form-group">
                <div class="field"><label>Nama Dokumen</label><input type="text" id="ksNama" placeholder="KOSP / Prota / Promes"></div>
                <div class="field"><label>Link URL Drive</label><input type="text" id="ksLink"></div>
                <button class="btn btn-blue" onclick="saveKosp()">üîó SIMPAN LINK</button>
            </div>
            <div class="table-res"><table><thead><tr><th>DOKUMEN</th><th>LINK</th><th>AKSI</th></tr></thead><tbody id="bodyKosp"></tbody></table></div>
        </div>
    </div>

    <div id="tab-kepsek" class="tab-content">
        <div class="card">
            <h3 id="monitor-title">Monitoring</h3>
            <div id="area-monitor-kepsek"></div>
        </div>
    </div>

    <div id="print-footer" style="display:none;">
        <table class="print-footer-table">
            <tr>
                <td>Mengetahui,<br>Kepala Sekolah<br><br><br><br><b id="fKepsek">KARYADI, S.Pd</b><br>NIP. <span id="fnipKepsek"></span></td>
                <td><span id="fTanggal"></span><br><span id="fRoleLabel">Guru</span><br><br><br><br><b id="fGuru"></b><br>NIP. <span id="fnipGuru"></span></td>
            </tr>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ",
        authDomain: "adminsitrasi-guru-de394.firebaseapp.com",
        databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "adminsitrasi-guru-de394",
        storageBucket: "adminsitrasi-guru-de394.firebasestorage.app",
        messagingSenderId: "1056567544540",
        appId: "1:1056567544540:web:d612d0c9eccb758c87c219"
    };

    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    let currentRole = '';
    let currentSemester = 1;
    let currentSiswa = null;
    let currentUjian = null;
    let db = { cfg:{}, siswa:[], cp:[], agenda:[], absensi:{}, nilai:{}, modul:[], kegiatan:[], kosp:[] };
    let tempAgendaPhoto = "";
    let tempKegiatanPhoto = "";
    
    const SEKO_LAT = -6.8352517; 
    const SEKO_LNG = 108.2408433;
    const MAX_DISTANCE = 100;

    const mapelData = {
        rendah: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda"],
        tinggi: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda", "IPAS", "B.Inggris"]
    };

    const allGurus = [
        {id: 'GK1', nama: 'SITI ROKAYAH,S.Pd', pw: '12345'},
        {id: 'GK2', nama: 'VIKA NURATIKA,S.Pd', pw: '12345'},
        {id: 'GK3', nama: 'RISKA WIDIA ROSANA,S.PD', pw: '12345'},
        {id: 'GK4', nama: 'DEDE YUDIASTUTI,S.Pd', pw: '12345'},
        {id: 'GK5', nama: 'SILVYRA RISMAWATI,S.Pd.SD', pw: '12345'},
        {id: 'GK6', nama: 'ESIH IMAWATI,S.Pd', pw: '12345'},
        {id: 'PJOK', nama: 'INDRA SETIAWAN,S.Pd', pw: '12345'},
        {id: 'PAI', nama: 'YATI NOVIYATI,S.Pd.I', pw: '12345'},
        {id: 'KEPSEK', nama: 'KARYADI, S.Pd', pw: 'admin2026'},
        {id: 'OPS', nama: 'OPERATOR SEKOLAH', pw: 'ops2026'}
    ];

    const sindiranPagi = [
        "Matahari sudah bangun, masa kamu belum 'ceklok'?",
        "Tombol absennya kesepian nih. Udah mau jam 06.30.",
        "Lari pagi itu sehat, tapi ngejar absen jam 06.30 itu senam jantung.",
        "Wah, pemandangan sekolah sudah cantik, lebih cantik lagi kalau status absenmu hijau.",
        "Sudah hampir jam 06.30, jangan biarkan namamu 'nongkrong' di HP Kepala Sekolah."
    ];

    // --- FUNGSI BARU OPS & UJIAN ---

    function downloadTemplateSiswa() {
        const data = [{ NISN: "12345", NIS: "1001", NAMA: "Budi Santoso", KELAS: "1" }];
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siswa");
        XLSX.writeFile(wb, "Template_Import_Siswa.xlsx");
    }

    function importExcelSiswa(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            // Masukkan ke database berdasarkan kelas masing-masing
            json.forEach(row => {
                const klsKey = 'gk' + row.KELAS;
                rtdb.ref(`sekolah_wetan/${klsKey}/siswa`).once('value', snap => {
                    let sData = snap.val() || [];
                    sData.push({ id: 's' + Date.now() + Math.random(), kls: row.KELAS.toString(), nisn: row.NISN, nis: row.NIS, nama: row.NAMA });
                    rtdb.ref(`sekolah_wetan/${klsKey}/siswa`).set(sData);
                });
            });
            alert("Berhasil Impor " + json.length + " Siswa!");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function downloadTemplateSoal() {
        const data = [{ NO: 1, PERTANYAAN: "Apa Ibukota Indonesia?", A: "Jakarta", B: "Bandung", C: "Surabaya", D: "Medan", KUNCI: "A" }];
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Soal");
        XLSX.writeFile(wb, "Template_Bank_Soal.xlsx");
    }

    function importExcelSoal(input) {
        const mapel = document.getElementById('soalMapel').value;
        const kls = document.getElementById('soalKls').value;
        if(!mapel) return alert("Isi Nama Mapel!");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            const paketSoal = { id: 'exam_' + Date.now(), mapel: mapel, kls: kls, butir: json, aktif: true };
            rtdb.ref('bank_soal').push(paketSoal);
            alert("Soal berhasil didistribusikan ke Siswa Kelas " + kls);
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function openLoginSiswa() {
        const kls = prompt("Masukkan Kelas Anda (1-6):");
        if(!kls) return;
        
        rtdb.ref('sekolah_wetan/gk' + kls + '/siswa').once('value', snap => {
            const siswaList = snap.val();
            if(!siswaList) return alert("Data siswa kelas ini belum ada!");
            
            let menu = "PILIH NAMA ANDA (Ketik Angka):\n";
            siswaList.forEach((s, i) => menu += `${i+1}. ${s.nama}\n`);
            
            const pilih = prompt(menu);
            const idx = parseInt(pilih) - 1;
            if(siswaList[idx]) {
                currentSiswa = siswaList[idx];
                alert("Halo " + currentSiswa.nama + ", selamat mengerjakan ujian.");
                switchTab('tab-siswa-ujian');
                loadDaftarUjianSiswa(kls);
            } else {
                alert("Pilihan tidak valid.");
            }
        });
    }

    function loadDaftarUjianSiswa(kls) {
        rtdb.ref('bank_soal').once('value', snap => {
            const soalAll = snap.val();
            let html = "";
            for(let id in soalAll) {
                if(soalAll[id].kls == kls) {
                    html += `<div class="menu-card" onclick="mulaiUjian('${id}')">
                                <span class="icon">üìù</span>
                                <h3>${soalAll[id].mapel}</h3>
                                <p>Klik untuk mengerjakan</p>
                             </div>`;
                }
            }
            document.getElementById('list-ujian-tersedia').innerHTML = html || "Belum ada ujian untuk kelas Anda.";
        });
    }

    function mulaiUjian(id) {
        rtdb.ref('bank_soal/' + id).once('value', snap => {
            currentUjian = snap.val();
            currentUjian.key = id;
            document.getElementById('area-pilih-ujian').style.display = 'none';
            document.getElementById('area-kerjakan-soal').style.display = 'block';
            document.getElementById('judul-ujian').innerText = "UJIAN: " + currentUjian.mapel;
            
            let html = "";
            currentUjian.butir.forEach((s, i) => {
                html += `
                <div class="card" style="text-align:left">
                    <p><b>${i+1}. ${s.PERTANYAAN}</b></p>
                    <label class="quiz-option"><input type="radio" name="q${i}" value="A"> A. ${s.A}</label>
                    <label class="quiz-option"><input type="radio" name="q${i}" value="B"> B. ${s.B}</label>
                    <label class="quiz-option"><input type="radio" name="q${i}" value="C"> C. ${s.C}</label>
                    <label class="quiz-option"><input type="radio" name="q${i}" value="D"> D. ${s.D}</label>
                </div>`;
            });
            document.getElementById('konten-soal').innerHTML = html;
        });
    }

    function submitJawabanSiswa() {
        if(!confirm("Kirim jawaban sekarang?")) return;
        let benar = 0;
        currentUjian.butir.forEach((s, i) => {
            const userAns = document.querySelector(`input[name="q${i}"]:checked`)?.value;
            if(userAns === s.KUNCI) benar++;
        });
        
        const nilai = Math.round((benar / currentUjian.butir.length) * 100);
        const hasil = {
            nama: currentSiswa.nama,
            kls: currentSiswa.kls,
            mapel: currentUjian.mapel,
            nilai: nilai,
            waktu: new Date().toLocaleString()
        };
        
        rtdb.ref('hasil_ujian').push(hasil).then(() => {
            alert("Ujian Selesai! Nilai Anda: " + nilai);
            location.reload();
        });
    }

    function renderRekapNilaiUjian() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üìä Hasil Ujian Online';
        rtdb.ref('hasil_ujian').once('value', snap => {
            const data = snap.val();
            let html = '<div class="table-res"><table><thead><tr><th>NAMA</th><th>KELAS</th><th>MAPEL</th><th>NILAI</th><th>WAKTU</th></tr></thead><tbody>';
            for(let id in data) {
                // Jika guru kelas, filter hanya kelasnya
                if(currentRole.startsWith('GK') && data[id].kls != currentRole.replace('GK','')) continue;
                
                html += `<tr><td>${data[id].nama}</td><td>${data[id].kls}</td><td>${data[id].mapel}</td><td><b>${data[id].nilai}</b></td><td>${data[id].waktu}</td></tr>`;
            }
            document.getElementById('area-monitor-kepsek').innerHTML = html + '</tbody></table></div>';
        });
    }

    // --- FUNGSI ASLI YANG DIPERTAHANKAN ---

    function getTodayISO() { return new Date().toLocaleDateString('en-CA'); }
    function getNamaHari(tglStr) { const hari = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"]; const d = tglStr ? new Date(tglStr) : new Date(); return hari[d.getDay()]; }

    function updateMapelFilter(elementId, kls) {
        const select = document.getElementById(elementId);
        if(!select) return;
        let list = [];
        if(currentRole === 'PJOK') { list = ["PJOK"]; } 
        else if(currentRole === 'PAI') { list = ["PAI"]; } 
        else { list = (kls == 1 || kls == 2) ? mapelData.rendah : mapelData.tinggi; }
        select.innerHTML = list.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function filterKelasBerdasarkanRole(role) {
        const listSelectKelas = ['rpKls', 'masterKls', 'swKls', 'mdKls', 'agKls', 'abKls', 'rekKls'];
        listSelectKelas.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            if (role.startsWith('GK')) {
                const klsTujuan = role.replace('GK', ''); 
                select.innerHTML = `<option value="${klsTujuan}">Kelas ${klsTujuan}</option>`;
                select.disabled = true; 
            } else {
                select.innerHTML = `<option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>`;
                select.disabled = false;
            }
        });
    }

    function selectRole(role, title, name) {
        const guruData = allGurus.find(g => g.id === role);
        const inputPw = prompt(`Ketik Password di bawah ini\nUntuk Akun: ${name}\n----------------------------------`);
        if (inputPw !== guruData.pw) { alert("Password Salah!"); return; }
        currentRole = role;
        document.getElementById('main-title').innerText = title + " - " + name;
        filterKelasBerdasarkanRole(role);
        
        if(role === 'OPS') {
            switchTab('tab-ops');
        } else if(role === 'KEPSEK') {
            document.getElementById('guru-menu').style.display = 'none';
            document.getElementById('kepsek-menu').style.display = 'grid';
            loadDB(name);
            switchTab('tab-home');
        } else {
            document.getElementById('guru-menu').style.display = 'grid';
            document.getElementById('kepsek-menu').style.display = 'none';
            loadDB(name);
            startReminderSystem();
            switchTab('tab-home');
        }
        
        const defaultKls = role.startsWith('GK') ? role.replace('GK', '') : '1';
        updateMapelFilter('masterMapel', defaultKls);
        updateMapelFilter('rpMapel', defaultKls);
        updateMapelFilter('mdMapel', defaultKls);
        updateMapelFilter('agMapel', defaultKls);
    }

    // [BAGIAN FUNGSI SISWA, SETUP, RAPOR, DLL TETAP SAMA SEPERTI KODE ASLI ANDA]
    // ... (Fungsi-fungsi asli di bawah ini disatukan tanpa perubahan logika) ...

    function setSemester(sem) {
        currentSemester = sem;
        document.getElementById('btnSem1').classList.toggle('active', sem === 1);
        document.getElementById('btnSem2').classList.toggle('active', sem === 2);
        renderRaport();
    }

    function openModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'block';
        document.getElementById('modalCeklok').style.display = 'block';
        document.getElementById('statusLokasi').innerText = "Sedang mencari GPS...";
        document.getElementById('btnKirimAbsen').disabled = true;
        const skrg = new Date();
        const tglISO = getTodayISO();
        document.getElementById('infoWaktu').innerHTML = `<div style="font-size:14px;">${getNamaHari(tglISO)}, ${tglISO}</div><div style="font-size:24px; margin-top:5px;">${skrg.getHours().toString().padStart(2,'0')}:${skrg.getMinutes().toString().padStart(2,'0')} WIB</div>`;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, SEKO_LAT, SEKO_LNG);
                if(dist <= MAX_DISTANCE) {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:green">üìç Lokasi Sesuai (${Math.round(dist)}m)</span>`;
                    document.getElementById('btnKirimAbsen').disabled = false;
                } else {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:red">üìç Terlalu jauh! (${Math.round(dist)}m dari sekolah)</span>`;
                }
            }, err => { document.getElementById('statusLokasi').innerText = "Gagal akses GPS. Aktifkan lokasi HP!"; });
        }
    }

    function closeModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'none';
        document.getElementById('modalCeklok').style.display = 'none';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function submitCeklok() {
        const skrg = new Date();
        const tgl = getTodayISO();
        const statusAbsen = (skrg.getHours() > 6 || (skrg.getHours() === 6 && skrg.getMinutes() > 30)) ? "TERLAMBAT" : "HADIR";
        await rtdb.ref(`presensi_guru/${tgl}/${currentRole}`).set({ nama: db.cfg.guru, waktu: skrg.toLocaleTimeString(), status: statusAbsen, ket: "-" });
        alert("Ceklok Berhasil!");
        closeModalCeklok();
    }

    function loadDB(name) {
        const path = 'sekolah_wetan/' + currentRole.toLowerCase();
        rtdb.ref(path).on('value', (snapshot) => {
            const data = snapshot.val();
            db = data || { cfg: { sekolah: '', guru: name, nipGuru: '', waGuru:'', kepsek: 'KARYADI, S.Pd', nipKepsek: '', waKepsek:'' }, siswa: [], cp: [], agenda: [], absensi: {}, nilai: {}, modul: [], kegiatan:[], kosp:[] };
            fillSetupForm();
        });
    }

    function fillSetupForm() {
        document.getElementById('sSekolah').value = db.cfg.sekolah || '';
        document.getElementById('sGuru').value = db.cfg.guru || '';
        document.getElementById('snipGuru').value = db.cfg.nipGuru || '';
        document.getElementById('sWaGuru').value = db.cfg.waGuru || '';
        document.getElementById('sKepsek').value = db.cfg.kepsek || '';
        document.getElementById('snipKepsek').value = db.cfg.nipKepsek || '';
        document.getElementById('sWaKepsek').value = db.cfg.waKepsek || '';
    }

    function saveToFirebase() { rtdb.ref('sekolah_wetan/' + currentRole.toLowerCase()).set(db); }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('back-area').style.display = (id === 'tab-login' ? 'none' : 'block');
        const tgl = getTodayISO();
        if(id==='tab-siswa') renderSiswa();
        if(id==='tab-agenda') { document.getElementById('agTgl').value = tgl; renderAgenda(); }
        if(id==='tab-absensi') { document.getElementById('abTgl').value = tgl; renderAbsensi(); }
    }

    // Fungsi-fungsi CRUD Master, Siswa, Modul, Agenda, dll tetap ada di bawah ini sesuai kode asli
    function saveSiswa() { if(!db.siswa) db.siswa=[]; db.siswa.push({id:'s'+Date.now(), kls:document.getElementById('swKls').value, nisn:document.getElementById('swNisn').value, nis:document.getElementById('swNis').value, nama:document.getElementById('swNama').value}); saveToFirebase(); renderSiswa(); }
    function renderSiswa() { const k = document.getElementById('swKls').value; const f = db.siswa ? db.siswa.filter(s=>s.kls==k) : []; document.getElementById('bodySiswa').innerHTML = f.map((s,i)=>`<tr><td>${i+1}</td><td>${s.nisn}</td><td>${s.nis}</td><td style="text-align:left">${s.nama}</td><td class="no-print"><button class="btn btn-red" onclick="hS('${s.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function hS(id){ if(confirm('Hapus?')){ db.siswa=db.siswa.filter(x=>x.id!=id); saveToFirebase(); renderSiswa(); }}
    function saveSetup() { 
        db.cfg.sekolah = document.getElementById('sSekolah').value; db.cfg.guru = document.getElementById('sGuru').value; 
        db.cfg.nipGuru = document.getElementById('snipGuru').value; db.cfg.waGuru = document.getElementById('sWaGuru').value; 
        db.cfg.kepsek = document.getElementById('sKepsek').value; db.cfg.nipKepsek = document.getElementById('snipKepsek').value; 
        db.cfg.waKepsek = document.getElementById('sWaKepsek').value; saveToFirebase(); alert('Disimpan!'); 
    }
    function previewProfilePhoto(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('photo-img').src = e.target.result; document.getElementById('photo-img').style.display = 'block'; document.getElementById('photo-placeholder').style.display = 'none'; db.cfg.foto = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
    function saveMaster(tipe) { if(!db.cp) db.cp=[]; const kls = document.getElementById('masterKls').value; const mpl = document.getElementById('masterMapel').value; let d = { id: Date.now(), kls: kls, mapel: mpl, tipe: tipe }; if(tipe==='CP'){ d.elemen=document.getElementById('cpElemen').value; d.isi=document.getElementById('cpIsi').value; d.kompetensi=document.getElementById('cpKompetensi').value; d.konten=document.getElementById('cpKonten').value; } else if(tipe==='TP'){ d.kode=document.getElementById('tpKode').value; d.isi=document.getElementById('tpIsi').value; d.kktp=document.getElementById('tpKktp').value; } else if(tipe==='ATP'){ d.isi=document.getElementById('atpIsi').value; d.waktu=document.getElementById('atpWaktu').value; d.dimensi=document.getElementById('atpDimensi').value; d.asesmen=document.getElementById('atpAsesmen').value; } db.cp.push(d); saveToFirebase(); renderSemuaMaster(); }
    function renderSemuaMaster() { const k = document.getElementById('masterKls').value; const m = document.getElementById('masterMapel').value; const all = db.cp ? db.cp.filter(x=>x.kls==k && x.mapel==m) : []; document.getElementById('bodyCPNew').innerHTML = all.filter(x=>x.tipe==='CP').map(x=>`<tr><td>${x.elemen}</td><td>${x.isi}</td><td>${x.kompetensi}</td><td>${x.konten}</td><td><button onclick="hM('${x.id}')">üóëÔ∏è</button></td></tr>`).join(''); document.getElementById('bodyTPNew').innerHTML = all.filter(x=>x.tipe==='TP').map(x=>`<tr><td>${x.kode}</td><td>${x.isi}</td><td>${x.kktp}</td><td><button onclick="hM('${x.id}')">üóëÔ∏è</button></td></tr>`).join(''); document.getElementById('bodyATPNew').innerHTML = all.filter(x=>x.tipe==='ATP').map((x,i)=>`<tr><td>${i+1}</td><td>${x.isi}</td><td>${x.waktu}</td><td>${x.asesmen}</td><td><button onclick="hM('${x.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function hM(id){ db.cp=db.cp.filter(x=>x.id!=id); saveToFirebase(); renderSemuaMaster(); }
    function updateMdTP() { const k = document.getElementById('mdKls').value; const m = document.getElementById('mdMapel').value; const tps = db.cp ? db.cp.filter(x=>x.kls==k && x.mapel==m && x.tipe=='TP') : []; document.getElementById('mdTP').innerHTML = tps.map(t=>`<option value="${t.id}">${t.isi}</option>`).join(''); }
    function saveModul() { if(!db.modul) db.modul=[]; const tid = document.getElementById('mdTP').value; const d = { tpId: tid, kls: document.getElementById('mdKls').value, mapel: document.getElementById('mdMapel').value, waktu: document.getElementById('mdWaktu').value, metode: document.getElementById('mdMetode').value, langkah: document.getElementById('mdLangkah').value, media: document.getElementById('mdMedia').value, asesmen: document.getElementById('mdAsesmen').value }; const idx = db.modul.findIndex(x=>x.tpId == tid); if(idx>-1) db.modul[idx]=d; else db.modul.push(d); saveToFirebase(); alert('Disimpan'); }
    function updateAgTP() { const k = document.getElementById('agKls').value; const m = document.getElementById('agMapel').value; const tps = db.cp ? db.cp.filter(x=>x.kls==k && x.mapel==m && x.tipe=='TP') : []; document.getElementById('agTP').innerHTML = tps.map(t=>`<option value="${t.isi}">${t.isi}</option>`).join(''); }
    function saveAgenda() { if(!db.agenda) db.agenda=[]; db.agenda.push({id:Date.now(), kls:document.getElementById('agKls').value, tgl:document.getElementById('agTgl').value, mapel:document.getElementById('agMapel').value, tp:document.getElementById('agTP').value, materi:document.getElementById('agMateri').value, foto: tempAgendaPhoto, status:'‚è≥ Pending'}); tempAgendaPhoto = ""; saveToFirebase(); renderAgenda(); }
    function renderAgenda() { const k = document.getElementById('agKls').value; const listAg = db.agenda ? db.agenda.filter(a=>a.kls==k) : []; document.getElementById('bodyAgenda').innerHTML = listAg.map(a=>`<tr><td><b>${getNamaHari(a.tgl)}</b><br>${a.tgl}</td><td>${a.tp}</td><td>${a.materi}</td><td>${a.foto?'<img src="'+a.foto+'" style="width:30px">':'-'}</td><td>${a.status||'‚è≥ Pending'}</td><td><button onclick="hAg('${a.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function renderAbsensi() { const k = document.getElementById('abKls').value; const t = document.getElementById('abTgl').value; if(!t) return; const list = db.siswa ? db.siswa.filter(s=>s.kls==k) : []; document.getElementById('bodyAbsensi').innerHTML = list.map((s,i)=>{ let st = (db.absensi || {})[t+'_'+s.id] || 'H'; return `<tr><td>${i+1}</td><td>${s.nama}</td><td><select onchange="uAbs('${t}','${s.id}',this.value)"><option value="H" ${st=='H'?'selected':''}>H</option><option value="S" ${st=='S'?'selected':''}>S</option><option value="I" ${st=='I'?'selected':''}>I</option><option value="A" ${st=='A'?'selected':''}>A</option></select></td></tr>`; }).join(''); }
    function uAbs(t, sid, v) { if(!db.absensi) db.absensi={}; db.absensi[t+'_'+sid] = v; saveToFirebase(); }
    function renderRekapAbsen() { const k = document.getElementById('rekKls').value; const bul = document.getElementById('rekBulan').value; if(!bul) return; let h = `<tr><th>NAMA</th>`; for(let d=1; d<=31; d++) h += `<th>${d}</th>`; h += `</tr>`; document.getElementById('headRekap').innerHTML = h; const list = db.siswa ? db.siswa.filter(s=>s.kls==k) : []; document.getElementById('bodyRekap').innerHTML = list.map(s=>{ let row = `<tr><td>${s.nama}</td>`; for(let d=1; d<=31; d++){ let day = d<10?'0'+d:d; row += `<td>${(db.absensi || {})[bul+'-'+day+'_'+s.id] || '-'}</td>`; } return row + `</tr>`; }).join(''); }
    function saveKegiatan() { if(!db.kegiatan) db.kegiatan = []; db.kegiatan.push({id: Date.now(), jenis: document.getElementById('kgJenis').value, nama: document.getElementById('kgNama').value, tgl: document.getElementById('kgTgl').value, ket: document.getElementById('kgKet').value, foto: tempKegiatanPhoto, status: '‚è≥ Menunggu'}); tempKegiatanPhoto = ""; saveToFirebase(); renderKegiatan(); alert('Diajukan!'); }
    function renderKegiatan() { const b = document.getElementById('bodyKegiatan'); if(!db.kegiatan) return b.innerHTML = ""; b.innerHTML = db.kegiatan.map(k=>`<tr><td>${k.jenis}</td><td>${k.nama}</td><td><b>${getNamaHari(k.tgl)}</b><br>${k.tgl}</td><td>${k.foto?'<img src="'+k.foto+'" style="width:30px">':'-'}</td><td><span class="status-badge" style="background:${k.status==='‚úÖ Disetujui'?'#dcfce7':'#fee2e2'}">${k.status}</span></td><td><button onclick="hKeg('${k.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function saveKosp(){ if(!db.kosp) db.kosp=[]; db.kosp.push({id:Date.now(), nama:document.getElementById('ksNama').value, link:document.getElementById('ksLink').value}); saveToFirebase(); renderKosp(); }
    function renderKosp(){ const b = document.getElementById('bodyKosp'); if(!db.kosp) return b.innerHTML=""; b.innerHTML=db.kosp.map(k=>`<tr><td>${k.nama}</td><td><a href="${k.link}" target="_blank">Buka</a></td><td><button onclick="hKosp('${k.id}')">üóëÔ∏è</button></td></tr>`).join(''); }
    function toggleVisibility(id) { const x = document.getElementById(id); x.style.display = (x.style.display==='none'?'block':'none'); }
    function exportSiswaExcel() { const ws = XLSX.utils.json_to_sheet(db.siswa || []); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Siswa"); XLSX.writeFile(wb, `SISWA_${currentRole}.xlsx`); }

    // Kepsek Monitoring Functions
    function renderMonitorAgenda() { switchTab('tab-kepsek'); document.getElementById('monitor-title').innerText = 'üìã Persetujuan Agenda'; const area = document.getElementById('area-monitor-kepsek'); rtdb.ref('sekolah_wetan').once('value', snapshot => { const all = snapshot.val(); let html = '<div class="table-res"><table><thead><tr><th>GURU</th><th>MAPEL</th><th>TGL</th><th>AKSI</th></tr></thead><tbody>'; for(let r in all) { if(all[r].agenda) all[r].agenda.forEach((a,i)=>{ if(a.status!=='‚úÖ Disetujui') html += `<tr><td>${all[r].cfg.guru||r}</td><td>${a.mapel}</td><td>${a.tgl}</td><td><button class="btn btn-green" onclick="appAg('${r}',${i})">Setujui</button></td></tr>`; }); } area.innerHTML = html + '</tbody></table></div>'; }); }
    function appAg(r,i){ rtdb.ref(`sekolah_wetan/${r}/agenda/${i}/status`).set('‚úÖ Disetujui'); alert('Disetujui'); renderMonitorAgenda(); }
    function renderMonitorAbsenGuru() { switchTab('tab-kepsek'); document.getElementById('monitor-title').innerText = 'üë®‚Äçüè´ Monitor Presensi Guru'; const area = document.getElementById('area-monitor-kepsek'); const tgl = getTodayISO(); rtdb.ref(`presensi_guru/${tgl}`).on('value', snap => { const dataHadir = snap.val() || {}; let html = '<div class="table-res"><table><thead><tr><th>NAMA</th><th>STATUS</th><th>WAKTU</th></tr></thead><tbody>'; allGurus.forEach(g => { const h = dataHadir[g.id] || { status: 'üî¥ Belum Absen', waktu: '-' }; html += `<tr><td>${g.nama}</td><td><b>${h.status}</b></td><td>${h.waktu}</td></tr>`; }); area.innerHTML = html + '</tbody></table></div>'; }); }

</script>
</body>
</html>
