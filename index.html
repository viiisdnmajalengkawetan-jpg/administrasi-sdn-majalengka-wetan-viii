<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #1e3a8a; --accent: #3b82f6; --success: #10b981; 
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: var(--dark); display: flex; flex-direction: column; min-height: 100vh; }
        .navbar { background: var(--primary); color: white; padding: 25px; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; border-bottom: 4px solid var(--accent); }
        .container { padding: 30px; max-width: 1300px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: var(--white); padding: 35px 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .menu-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .menu-card .icon { font-size: 50px; margin-bottom: 15px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; border-top: 5px solid var(--accent); }
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn-blue { background: var(--accent); } .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-orange { background: var(--warning); } .btn-dark { background: var(--dark); }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .field { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
        label { font-size: 11px; font-weight: 800; margin-bottom: 5px; color: #64748b; }
        input, select, textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .table-res { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 12px; color: var(--primary); font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .hidden-form { display: none; margin-top: 20px; padding: 15px; border: 2px dashed #3b82f6; border-radius: 12px; }
        .history-container { display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #cbd5e1; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        
        .semester-switcher { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .sem-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--accent); cursor: pointer; background: white; color: var(--accent); font-weight: bold; }
        .sem-btn.active { background: var(--accent); color: white; }

        .profile-photo-container { text-align: center; margin-bottom: 20px; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--accent); }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .admin-wa-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #cbd5e1; margin-top: 15px; }

        #modalCeklok {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            z-index: 2000; text-align: center; width: 320px;
        }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }

        @media print {
            .navbar, .btn, .btn-group, .form-group, .dashboard-grid, .no-print, #back-area, .btn-orange, .btn-green, .semester-switcher { display: none !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            #print-footer { display: block !important; margin-top: 40px; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body { background: white; }
            table { font-size: 10px; width: 100%; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; }
            .print-footer-table { width: 100%; border: none !important; margin-top: 30px; }
            .print-footer-table td { border: none !important; text-align: center; width: 50% !important; vertical-align: top; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlayCeklok"></div>
<div id="modalCeklok">
    <span style="font-size: 50px;">üìç</span>
    <h4>PRESENSI GURU</h4>
    <p id="statusLokasi" style="font-size: 12px; color: #64748b;">Mendeteksi lokasi Anda...</p>
    <div id="infoWaktu" style="margin-bottom: 15px; font-weight: bold; color: var(--primary);"></div>
    <button id="btnKirimAbsen" disabled onclick="submitCeklok()" class="btn btn-green" style="width: 100%; justify-content: center; padding: 15px;">CEKLOK SEKARANG</button>
    <button onclick="submitIzinSakit()" class="btn btn-orange" style="width: 100%; justify-content: center; padding: 10px; margin-top: 5px;">LAPOR IZIN / SAKIT</button>
    <button onclick="closeModalCeklok()" style="margin-top: 15px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold;">TUTUP</button>
</div>

<div id="print-header" style="display:none;">
    <h1 id="pSekolah">NAMA SEKOLAH</h1>
    <h2 id="pTitle">LAPORAN CAPAIAN HASIL BELAJAR</h2>
    <hr>
</div>

<div class="navbar">
    <h2 id="main-title">üöÄ ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</h2>
</div>

<div class="container">
    <div id="tab-login" class="tab-content" style="display: block;">
        <h3 style="text-align:center">Silakan Pilih Akun:</h3>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="selectRole('GK1', 'üè´ KELAS 1', 'SITI ROKAYAH,S.Pd')"><span class="icon">üè´</span><h3>KELAS 1</h3><p>SITI ROKAYAH,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK2', 'üè´ KELAS 2', 'VIKA NURATIKA,S.Pd')"><span class="icon">üè´</span><h3>KELAS 2</h3><p>VIKA NURATIKA,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK3', 'üè´ KELAS 3', 'RISKA WIDIA ROSANA,S.PD')"><span class="icon">üè´</span><h3>KELAS 3</h3><p>RISKA WIDIA ROSANA,S.PD</p></div>
            <div class="menu-card" onclick="selectRole('GK4', 'üè´ KELAS 4', 'DEDE YUDIASTUTI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 4</h3><p>DEDE YUDIASTUTI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK5', 'üè´ KELAS 5', 'SILVYRA RISMAWATI,S.Pd.SD')"><span class="icon">üè´</span><h3>KELAS 5</h3><p>SILVYRA RISMAWATI,S.Pd.SD</p></div>
            <div class="menu-card" onclick="selectRole('GK6', 'üè´ KELAS 6', 'ESIH IMAWATI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 6</h3><p>ESIH IMAWATI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PJOK', 'üèÉ‚Äç‚ôÇÔ∏è GURU PJOK', 'INDRA SETIAWAN,S.Pd')"><span class="icon">üèÉ‚Äç‚ôÇÔ∏è</span><h3>GURU PJOK</h3><p>INDRA SETIAWAN,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PAI', 'üïå GURU PAI', 'YATI NOVIYATI,S.Pd.I')"><span class="icon">üïå</span><h3>GURU PAI</h3><p>YATI NOVIYATI,S.Pd.I</p></div>
            <div class="menu-card" onclick="selectRole('KEPSEK', 'üë®‚Äçüíº KEPALA SEKOLAH', 'KARYADI, S.Pd')" style="background: #fdf2f2;"><span class="icon">üë®‚Äçüíº</span><h3>KEPALA SEKOLAH</h3><p>KARYADI, S.Pd</p></div>
        </div>
        <hr style="margin: 30px 0;">
        <div style="text-align: center;">
            <button class="btn btn-orange" onclick="switchTab('tab-login-siswa')" style="padding: 20px 40px; font-size: 18px;">‚úçÔ∏è LOGIN SISWA (ULANGAN)</button>
        </div>
    </div>

    <div id="back-area" style="display: none; margin-bottom: 20px;">
        <button class="btn btn-dark" onclick="switchTab('tab-home')">üè† MENU UTAMA</button>
        <button class="btn btn-red" onclick="location.reload()">üö™ GANTI AKUN</button>
    </div>

    <div id="tab-home" class="tab-content">
        <div class="dashboard-grid" id="guru-menu">
            <div class="menu-card" onclick="openModalCeklok()" style="background: #f0fdf4; border: 2px solid var(--success);"><span class="icon">üìç</span><h4>CEKLOK ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>IDENTITAS</h4></div>
            <div class="menu-card" onclick="switchTab('tab-siswa')"><span class="icon">üë•</span><h4>SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-master')"><span class="icon">üéØ</span><h4>CP, TP, ATP</h4></div>
            <div class="menu-card" onclick="switchTab('tab-modul')"><span class="icon">üìñ</span><h4>MODUL AJAR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-agenda')"><span class="icon">üìù</span><h4>AGENDA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-absensi')"><span class="icon">‚úÖ</span><h4>ABSENSI SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-rekap-absen')"><span class="icon">üìä</span><h4>REKAP ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-raport')"><span class="icon">üìú</span><h4>RAPOR & NILAI</h4></div>
            <div class="menu-card" onclick="switchTab('tab-buat-ulangan')"><span class="icon">üìù</span><h4>BUAT ULANGAN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kegiatan')"><span class="icon">üèÜ</span><h4>EKSKUL/KOKUL</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kosp')"><span class="icon">üìÇ</span><h4>KOSP & LINK</h4></div>
        </div>
        <div class="dashboard-grid" id="kepsek-menu" style="display: none;">
            <div class="menu-card" onclick="renderMonitorAgenda()"><span class="icon">üìã</span><h4>PERSETUJUAN AGENDA</h4></div>
            <div class="menu-card" onclick="renderMonitorKegiatan()"><span class="icon">üèÜ</span><h4>PERSETUJUAN KEGIATAN</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenGuru()"><span class="icon">üë®‚Äçüè´</span><h4>PRESENSI GURU</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenSiswa()"><span class="icon">üìä</span><h4>MONITOR ABSEN SISWA</h4></div>
            <div class="menu-card" onclick="renderMonitorLinkGuru()"><span class="icon">üìÇ</span><h4>DOKUMEN & CP/TP</h4></div>
            <div class="menu-card" onclick="renderMonitorNilai()"><span class="icon">üìú</span><h4>MONITOR NILAI & RAPOR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>PENGATURAN KEPSEK</h4></div>
        </div>
    </div>

    <div id="tab-login-siswa" class="tab-content">
        <div class="card" style="max-width: 500px; margin: auto; text-align: center;">
            <h3>‚úçÔ∏è Masuk Ruang Ulangan</h3>
            <div class="field" style="margin-bottom: 15px;">
                <label>Pilih Kelas</label>
                <select id="loginSwKls" onchange="loadDaftarNamaSiswa(this.value); updateMapelLoginSiswa(this.value)">
                    <div class="field">
    <label>Pilih Mata Pelajaran</label>
    <select id="loginSwMapel">
        <option value="">-- Pilih Mapel --</option>
    </select>
</div>
                    <option value="">-- Pilih Kelas --</option>
                    <option value="1">Kelas 1</option><option value="2">Kelas 2</option>
                    <option value="3">Kelas 3</option><option value="4">Kelas 4</option>
                    <option value="5">Kelas 5</option><option value="6">Kelas 6</option>
                </select>
            </div>
            <div class="field" style="margin-bottom: 20px;">
                <label>Pilih Nama Anda</label>
                <select id="loginSwNama">
                    <option value="">-- Pilih Nama --</option>
                </select>
            </div>
            <button class="btn btn-green" style="width: 100%; padding: 15px;" onclick="mulaiUlanganSiswa()">MASUK ULANGAN</button>
        </div>
    </div>

    <div id="tab-buat-ulangan" class="tab-content">
        <div class="card">
            <h3>üìù Kelola Soal Ulangan (Integrasi Rapor)</h3>
            <div class="form-group">
                <div class="field">
                    <label>Judul Ulangan</label>
                    <input type="text" id="ulJudul" placeholder="Contoh: PH 1 IPAS">
                </div>
                <div class="field">
                    <label>Mata Pelajaran</label>
                    <select id="ulMapel" onchange="updateUlTP()"></select>
                </div>
                <div class="field">
                    <label>Hubungkan ke TP (Untuk Rapor)</label>
                    <select id="ulTargetTP"></select>
                </div>
                <button class="btn btn-blue" onclick="simpanUlangan()">üíæ AKTIFKAN & SIMPAN</button>
            </div>
            <div id="area-input-soal"></div>
            <button class="btn btn-dark" onclick="tambahSoalBaru()">‚ûï TAMBAH SOAL</button>
            
            <hr style="margin: 30px 0;">
            <h4>üì• Koreksi Jawaban & Nilai Siswa</h4>
            <div id="area-koreksi-guru" class="table-res">
                <p>Belum ada data pengerjaan.</p>
            </div>
        </div>
    </div>

    <div id="tab-kerjakan-ulangan" class="tab-content">
        <div class="card">
            <h2 id="displayUlJudul" style="text-align: center;"></h2>
            <p id="displayNamaSiswa" style="text-align: center; color: var(--accent); font-weight: bold;"></p>
            <hr>
            <div id="konten-soal-siswa"></div>
            <button class="btn btn-green" style="width: 100%; padding: 20px; margin-top: 20px;" onclick="selesaiUlangan()">KIRIM JAWABAN</button>
        </div>
    </div>

    <div id="tab-setup" class="tab-content">
        <div class="card">
            <h3>‚öôÔ∏è Identitas & Foto Profil</h3>
            <div class="profile-photo-container">
                <div class="photo-preview" id="photo-preview-box">
                    <span id="photo-placeholder">üì∏ No Photo</span>
                    <img id="photo-img" src="" style="display:none;">
                </div>
                <input type="file" id="input-foto" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this)">
                <button class="btn btn-dark" onclick="document.getElementById('input-foto').click()">üì§ UPLOAD FOTO PROFIL</button>
            </div>
            <div class="form-group"><div class="field"><label>Nama Sekolah</label><input type="text" id="sSekolah"></div></div>
            <div class="form-group">
                <div class="field"><label>Nama Pengguna</label><input type="text" id="sGuru"></div>
                <div class="field"><label>NIP Pengguna</label><input type="text" id="snipGuru"></div>
                <div class="field"><label>WA Pribadi (628...)</label><input type="text" id="sWaGuru" placeholder="62812345678"></div>
            </div>
            <div id="kepsek-wa-management" class="admin-wa-box" style="display:none;">
                <h4>üõ†Ô∏è Panel Admin: Atur Nomor HP Guru</h4>
                <div id="list-wa-guru-inputs"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Nama Kepala Sekolah</label><input type="text" id="sKepsek"></div>
                <div class="field"><label>NIP Kepala Sekolah</label><input type="text" id="snipKepsek"></div>
                <div class="field"><label>WA Kepsek (628...)</label><input type="text" id="sWaKepsek" placeholder="62812345678"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="saveSetup()">üíæ SIMPAN PERUBAHAN</button>
            </div>
        </div>
    </div>

    <div id="tab-raport" class="tab-content">
        <div class="card">
            <h3>üìú Input Nilai & Rapor</h3>
            <div class="semester-switcher">
                <button id="btnSem1" class="sem-btn active" onclick="setSemester(1)">SEMESTER 1 (GANJIL)</button>
                <button id="btnSem2" class="sem-btn" onclick="setSemester(2)">SEMESTER 2 (GENAP)</button>
            </div>
            <div class="form-group">
                <div class="field">
                    <label>Pilih Kelas</label>
                    <select id="rpKls" onchange="updateMapelFilter('rpMapel', this.value); renderRaport()">
                        <option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option>
                        <option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>
                    </select>
                </div>
                <div class="field">
                    <label>Pilih Mata Pelajaran</label>
                    <select id="rpMapel" onchange="renderRaport()"></select>
                </div>
            </div>
            <button class="btn btn-green" onclick="window.print()">üñ®Ô∏è CETAK RAPOR</button>
            <div class="table-res">
                <table>
                    <thead id="headRaport"></thead>
                    <tbody id="bodyRaport"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-master" class="tab-content">
        <div class="card">
            <h3>üéØ Master CP, TP, ATP</h3>
            <div class="form-group">
                <div class="field">
                    <label>Pilih Kelas</label>
                    <select id="masterKls" onchange="updateMapelFilter('masterMapel', this.value); renderSemuaMaster()">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field">
                    <label>Pilih Mata Pelajaran</label>
                    <select id="masterMapel" onchange="renderSemuaMaster()"></select>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="showMasterForm('formCP')">‚ûï CP</button>
                <button class="btn btn-green" onclick="showMasterForm('formTP')">‚ûï TP</button>
                <button class="btn btn-orange" onclick="showMasterForm('formATP')">‚ûï ATP</button>
                <button class="btn btn-dark" onclick="toggleVisibility('history-master')">üëÅÔ∏è LIHAT RIWAYAT</button>
            </div>
            <div id="formCP" class="hidden-form">
                <h4>A. Capaian Pembelajaran (CP)</h4>
                <div class="form-group"><div class="field"><label>Elemen</label><input type="text" id="cpElemen"></div><div class="field" style="flex:2"><label>Isi CP</label><input type="text" id="cpIsi"></div><div class="field"><label>Kompetensi</label><input type="text" id="cpKompetensi"></div><div class="field"><label>Konten</label><input type="text" id="cpKonten"></div><button class="btn btn-blue" onclick="saveMaster('CP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formTP" class="hidden-form">
                <h4>B. Tujuan Pembelajaran (TP)</h4>
                <div class="form-group"><div class="field"><label>Kode TP</label><input type="text" id="tpKode"></div><div class="field" style="flex:2"><label>Isi TP</label><input type="text" id="tpIsi"></div><div class="field"><label>KKTP</label><input type="text" id="tpKktp"></div><button class="btn btn-green" onclick="saveMaster('TP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formATP" class="hidden-form">
                <h4>C. Alur Tujuan Pembelajaran (ATP)</h4>
                <div class="form-group"><div class="field" style="flex:2"><label>Isi ATP</label><input type="text" id="atpIsi"></div><div class="field"><label>Waktu</label><input type="text" id="atpWaktu"></div><div class="field"><label>Dimensi PPP</label><input type="text" id="atpDimensi"></div><div class="field"><label>Asesmen</label><input type="text" id="atpAsesmen"></div><button class="btn btn-orange" onclick="saveMaster('ATP')">üíæ SIMPAN</button></div>
            </div>
            <div id="history-master" class="history-container">
                <div class="table-res"><table><thead><tr><th>Elemen</th><th>CP</th><th>Kompetensi</th><th>Konten</th><th>AKSI</th></tr></thead><tbody id="bodyCPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>Kode TP</th><th>TP</th><th>KKTP</th><th>AKSI</th></tr></thead><tbody id="bodyTPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>No</th><th>ATP</th><th>Waktu</th><th>Asesmen</th><th>AKSI</th></tr></thead><tbody id="bodyATPNew"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-siswa" class="tab-content">
        <div class="card">
            <h3>üë• Data Siswa</h3>
            <div class="form-group">
                <div class="field"><label>Kelas</label><select id="swKls" onchange="renderSiswa()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                <div class="field"><label>NISN</label><input type="text" id="swNisn"></div>
                <div class="field"><label>NIS</label><input type="text" id="swNis"></div>
                <div class="field"><label>Nama</label><input type="text" id="swNama"></div>
                <button class="btn btn-blue" onclick="saveSiswa()">‚ûï TAMBAH</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-green" onclick="exportSiswaExcel()">üìä EKSPOR EXCEL</button>
                
                <button class="btn btn-orange" onclick="document.getElementById('importSiswaFile').click()">üì• IMPORT EXCEL</button>
                <input type="file" id="importSiswaFile" accept=".xlsx, .xls" style="display:none;" onchange="importSiswaExcel(this)">
                
                <button class="btn btn-dark" onclick="toggleVisibility('history-siswa')">üëÅÔ∏è LIHAT DATA</button>
            </div>
            <div id="history-siswa" class="history-container">
                <div class="table-res"><table><thead><tr><th>NO</th><th>NISN</th><th>NIS</th><th>NAMA</th><th class="no-print">AKSI</th></tr></thead><tbody id="bodySiswa"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-modul" class="tab-content">
        <div class="card">
            <h3>üìñ Modul Ajar</h3>
            <div class="form-group">
                <div class="field">
                    <label>Kelas</label>
                    <select id="mdKls" onchange="updateMapelFilter('mdMapel', this.value); updateMdTP()">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field"><label>Mata Pelajaran</label><select id="mdMapel" onchange="updateMdTP()"></select></div>
                <div class="field"><label>Pilih TP</label><select id="mdTP" onchange="loadModulDetail()"></select></div>
            </div>
            <div class="card" style="background: #f8fafc;">
                <div class="form-group"><div class="field"><label>Alokasi Waktu</label><input type="text" id="mdWaktu"></div><div class="field"><label>Metode</label><input type="text" id="mdMetode"></div></div>
                <div class="field"><label>Langkah-Langkah</label><textarea id="mdLangkah" rows="8"></textarea></div>
                <div class="form-group"><div class="field"><label>Media</label><input type="text" id="mdMedia"></div><div class="field"><label>Asesmen</label><input type="text" id="mdAsesmen"></div></div>
                <button class="btn btn-blue" onclick="saveModul()" style="width:100%">üíæ SIMPAN MODUL</button>
            </div>
        </div>
    </div>

    <div id="tab-agenda" class="tab-content">
        <div class="card">
            <h3>üìù Agenda Harian</h3>
            <div class="form-group">
                <div class="field">
                    <label>Kelas</label>
                    <select id="agKls" onchange="updateMapelFilter('agMapel', this.value); updateAgTP(); renderAgenda();">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                    </select>
                </div>
                <div class="field"><label>Mata Pelajaran</label><select id="agMapel" onchange="updateAgTP()"></select></div>
                <div class="field"><label>Tanggal</label><input type="date" id="agTgl"></div>
                <div class="field"><label>TP</label><select id="agTP"></select></div>
                <div class="field"><label>Materi</label><input type="text" id="agMateri"></div>
                <div class="field"><label>Foto (Opsional)</label><input type="file" id="agFoto" accept="image/*" onchange="processAgendaPhoto(this)"></div>
                <button class="btn btn-blue" onclick="saveAgenda()">üíæ SIMPAN</button>
            </div>
            <div class="table-res"><table><thead><tr><th>TGL</th><th>TP</th><th>MATERI</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead><tbody id="bodyAgenda"></tbody></table></div>
        </div>
    </div>

    <div id="tab-absensi" class="tab-content">
        <div class="card">
            <h3>‚úÖ Absensi Harian Siswa</h3>
            <div class="form-group">
                <select id="abKls" onchange="renderAbsensi()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                <input type="date" id="abTgl" onchange="renderAbsensi()">
            </div>
            <div class="table-res"><table><thead><tr><th>NO</th><th>NAMA</th><th>STATUS</th></tr></thead><tbody id="bodyAbsensi"></tbody></table></div>
        </div>
    </div>

    <div id="tab-rekap-absen" class="tab-content">
        <div class="card">
            <h3>üìä Rekap Bulanan</h3>
            <div class="form-group">
                <select id="rekKls" onchange="renderRekapAbsen()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                <input type="month" id="rekBulan" onchange="renderRekapAbsen()">
            </div>
            <div class="table-res"><table><thead id="headRekap"></thead><tbody id="bodyRekap"></tbody></table></div>
        </div>
    </div>

    <div id="tab-kegiatan" class="tab-content">
        <div class="card">
            <h3>üèÜ Kegiatan Ekstrakulikuler & Kokulikuler</h3>
            <div class="form-group">
                <div class="field"><label>Jenis</label><select id="kgJenis"><option value="Ekstrakulikuler">Ekstrakulikuler</option><option value="Kokulikuler">Kokulikuler</option></select></div>
                <div class="field"><label>Nama Kegiatan</label><input type="text" id="kgNama"></div>
                <div class="field"><label>Tanggal</label><input type="date" id="kgTgl"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Deskripsi</label><textarea id="kgKet"></textarea></div>
                <div class="field"><label>Foto Kegiatan</label><input type="file" id="kgFoto" accept="image/*" onchange="processKegiatanPhoto(this)"></div>
            </div>
            <button class="btn btn-blue" onclick="saveKegiatan()">üíæ AJUKAN KE KEPSEK</button>
            <div class="table-res" style="margin-top:15px;">
                <table><thead><tr><th>JENIS</th><th>NAMA</th><th>TGL</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead>
                <tbody id="bodyKegiatan"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-kosp" class="tab-content">
        <div class="card">
            <h3>üìÇ Link Dokumen KOSP & Perangkat</h3>
            <div class="form-group">
                <div class="field"><label>Nama Dokumen</label><input type="text" id="ksNama" placeholder="KOSP / Prota / Promes"></div>
                <div class="field"><label>Link URL Drive</label><input type="text" id="ksLink"></div>
                <button class="btn btn-blue" onclick="saveKosp()">üîó SIMPAN LINK</button>
            </div>
            <div class="table-res"><table><thead><tr><th>DOKUMEN</th><th>LINK</th><th>AKSI</th></tr></thead><tbody id="bodyKosp"></tbody></table></div>
        </div>
    </div>

    <div id="tab-kepsek" class="tab-content">
        <div class="card">
            <h3 id="monitor-title">Monitoring</h3>
            <div id="area-monitor-kepsek"></div>
        </div>
    </div>

    <div id="print-footer" style="display:none;">
        <table class="print-footer-table">
            <tr>
                <td>Mengetahui,<br>Kepala Sekolah<br><br><br><br><b id="fKepsek">KARYADI, S.Pd</b><br>NIP. <span id="fnipKepsek"></span></td>
                <td><span id="fTanggal"></span><br><span id="fRoleLabel">Guru</span><br><br><br><br><b id="fGuru"></b><br>NIP. <span id="fnipGuru"></span></td>
            </tr>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ",
        authDomain: "adminsitrasi-guru-de394.firebaseapp.com",
        databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "adminsitrasi-guru-de394",
        storageBucket: "adminsitrasi-guru-de394.firebasestorage.app",
        messagingSenderId: "1056567544540",
        appId: "1:1056567544540:web:d612d0c9eccb758c87c219"
    };

    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    let currentRole = '';
    let currentSemester = 1;
    let db = { cfg:{}, siswa:[], cp:[], agenda:[], absensi:{}, nilai:{}, modul:[], kegiatan:[], kosp:[] };
    let tempAgendaPhoto = "";
    let tempKegiatanPhoto = "";
    let daftarSoal = [];
    let siswaAktif = "";
    
    const SEKO_LAT = -6.8352517; 
    const SEKO_LNG = 108.2408433;
    const MAX_DISTANCE = 100;

    const mapelData = {
    function updateMapelLoginSiswa(kls) {
    const select = document.getElementById('loginSwMapel');
    if(!kls) {
        select.innerHTML = '<option value="">-- Pilih Mapel --</option>';
        return;
    }
    
    // Pilih daftar mapel sesuai kelas (Rendah 1-2, Tinggi 3-6)
    let list = (kls == 1 || kls == 2) ? mapelData.rendah : mapelData.tinggi;
    let fullList = [...list, "PAI", "PJOK"]; 
    
    select.innerHTML = '<option value="">-- Pilih Mapel --</option>' + 
        fullList.map(m => `<option value="${m}">${m}</option>`).join('');
}
        rendah: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda"],
        tinggi: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda", "IPAS", "B.Inggris"]
    };

    const allGurus = [
        {id: 'GK1', nama: 'SITI ROKAYAH,S.Pd', pw: '12345'},
        {id: 'GK2', nama: 'VIKA NURATIKA,S.Pd', pw: '12345'},
        {id: 'GK3', nama: 'RISKA WIDIA ROSANA,S.PD', pw: '12345'},
        {id: 'GK4', nama: 'DEDE YUDIASTUTI,S.Pd', pw: '12345'},
        {id: 'GK5', nama: 'SILVYRA RISMAWATI,S.Pd.SD', pw: '12345'},
        {id: 'GK6', nama: 'ESIH IMAWATI,S.Pd', pw: '12345'},
        {id: 'PJOK', nama: 'INDRA SETIAWAN,S.Pd', pw: '12345'},
        {id: 'PAI', nama: 'YATI NOVIYATI,S.Pd.I', pw: '12345'},
        {id: 'KEPSEK', nama: 'KARYADI, S.Pd', pw: 'admin2026'}
    ];

    const sindiranPagi = [
        "Matahari sudah bangun, masa kamu belum 'ceklok'?",
        "Tombol absennya kesepian nih. Udah mau jam 06.30.",
        "Lari pagi itu sehat, tapi ngejar absen jam 06.30 itu senam jantung.",
        "Wah, pemandangan sekolah sudah cantik, lebih cantik lagi kalau status absenmu hijau.",
        "Sudah hampir jam 06.30, jangan biarkan namamu 'nongkrong' di HP Kepala Sekolah."
    ];

    // --- FUNGSI PEMBANTU WAKTU ---
    function getTodayISO() {
        return new Date().toLocaleDateString('en-CA'); 
    }

    function getNamaHari(tglStr) {
        const hari = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const d = tglStr ? new Date(tglStr) : new Date();
        return hari[d.getDay()];
    }

    function updateMapelFilter(elementId, kls) {
        const select = document.getElementById(elementId);
        if(!select) return;
        let list = [];
        if(currentRole === 'PJOK') {
            list = ["PJOK"];
        } else if(currentRole === 'PAI') {
            list = ["PAI"];
        } else {
            list = (kls == 1 || kls == 2) ? mapelData.rendah : mapelData.tinggi;
        }
        select.innerHTML = list.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function filterKelasBerdasarkanRole(role) {
        const listSelectKelas = ['rpKls', 'masterKls', 'swKls', 'mdKls', 'agKls', 'abKls', 'rekKls'];
        listSelectKelas.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            if (role.startsWith('GK')) {
                const klsTujuan = role.replace('GK', '');
                select.innerHTML = `<option value="${klsTujuan}">Kelas ${klsTujuan}</option>`;
                select.disabled = true;
            } else {
                select.innerHTML = `<option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>`;
                select.disabled = false;
            }
        });
    }

    function selectRole(role, title, name) {
        const guruData = allGurus.find(g => g.id === role);
        const inputPw = prompt(`Ketik Password di bawah ini\nUntuk Akun: ${name}\n----------------------------------`);
        if (inputPw !== guruData.pw) {
            alert("Password Salah!");
            return;
        }
        currentRole = role;
        document.getElementById('main-title').innerText = title + " - " + name;
        filterKelasBerdasarkanRole(role);
        
        if(role === 'KEPSEK') {
            document.getElementById('guru-menu').style.display = 'none';
            document.getElementById('kepsek-menu').style.display = 'grid';
            loadDB(name);
        } else {
            document.getElementById('guru-menu').style.display = 'grid';
            document.getElementById('kepsek-menu').style.display = 'none';
            loadDB(name);
            startReminderSystem();
        }
        
        const defaultKls = role.startsWith('GK') ? role.replace('GK', '') : '1';
        updateMapelFilter('masterMapel', defaultKls);
        updateMapelFilter('rpMapel', defaultKls);
        updateMapelFilter('mdMapel', defaultKls);
        updateMapelFilter('agMapel', defaultKls);
        updateMapelFilter('ulMapel', defaultKls);

        switchTab('tab-home');
    }

    function setSemester(sem) {
        currentSemester = sem;
        document.getElementById('btnSem1').classList.toggle('active', sem === 1);
        document.getElementById('btnSem2').classList.toggle('active', sem === 2);
        renderRaport();
    }

    function openModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'block';
        document.getElementById('modalCeklok').style.display = 'block';
        document.getElementById('statusLokasi').innerText = "Sedang mencari GPS...";
        document.getElementById('btnKirimAbsen').disabled = true;

        const skrg = new Date();
        const tglISO = getTodayISO();
        const jam = skrg.getHours().toString().padStart(2,'0');
        const menit = skrg.getMinutes().toString().padStart(2,'0');
        document.getElementById('infoWaktu').innerHTML = `<div style="font-size:14px;">${getNamaHari(tglISO)}, ${tglISO}</div><div style="font-size:24px; margin-top:5px;">${jam}:${menit} WIB</div>`;

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, SEKO_LAT, SEKO_LNG);
                if(dist <= MAX_DISTANCE) {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:green">üìç Lokasi Sesuai (${Math.round(dist)}m)</span>`;
                    document.getElementById('btnKirimAbsen').disabled = false;
                } else {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:red">üìç Terlalu jauh! (${Math.round(dist)}m dari sekolah)</span>`;
                }
            }, err => {
                document.getElementById('statusLokasi').innerText = "Gagal akses GPS. Aktifkan lokasi HP!";
            });
        }
    }

    function closeModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'none';
        document.getElementById('modalCeklok').style.display = 'none';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180;
        const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function submitCeklok() {
        const skrg = new Date();
        const tgl = getTodayISO();
        const jam = skrg.getHours();
        const menit = skrg.getMinutes();

        let statusAbsen = "HADIR";
        let isTerlambat = false;
        if (jam > 6 || (jam === 6 && menit > 30)) {
            statusAbsen = "TERLAMBAT";
            isTerlambat = true;
        }

        const jamTeks = `${jam.toString().padStart(2,'0')}:${menit.toString().padStart(2,'0')}`;
        await rtdb.ref(`absen_guru/${tgl}/${currentRole}`).set({
            nama: db.cfg.guru || currentRole,
            waktu: jamTeks,
            status: statusAbsen,
            latlng: "Sesuai Radius"
        });

        alert(`Presensi Berhasil: ${statusAbsen} pukul ${jamTeks}`);
        closeModalCeklok();
    }

    async function submitIzinSakit() {
        const ket = prompt("Keterangan (Contoh: SAKIT atau IZIN ACARA KELUARGA):");
        if(!ket) return;
        const tgl = getTodayISO();
        await rtdb.ref(`absen_guru/${tgl}/${currentRole}`).set({
            nama: db.cfg.guru || currentRole,
            waktu: "-",
            status: ket.toUpperCase(),
            latlng: "-"
        });
        alert("Laporan terkirim ke Kepala Sekolah.");
        closeModalCeklok();
    }

    function startReminderSystem() {
        const check = () => {
            const skrg = new Date();
            const jam = skrg.getHours();
            const menit = skrg.getMinutes();
            if(jam === 6 && menit >= 15 && menit <= 30) {
                const msg = sindiranPagi[Math.floor(Math.random() * sindiranPagi.length)];
                if(confirm(`[PENGINGAT PAGI]\n${msg}\n\nIngin buka menu Ceklok sekarang?`)) {
                    openModalCeklok();
                }
            }
        };
        setInterval(check, 300000); 
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('back-area').style.display = (id === 'tab-login' || id === 'tab-login-siswa') ? 'none' : 'block';
        window.scrollTo(0,0);
        if(id === 'tab-siswa') renderSiswa();
        if(id === 'tab-agenda') renderAgenda();
        if(id === 'tab-absensi') renderAbsensi();
    }

    function toggleVisibility(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
    }

    async function loadDB(guruName) {
        const snapCfg = await rtdb.ref(`config/${currentRole}`).once('value');
        db.cfg = snapCfg.val() || {};
        document.getElementById('sGuru').value = db.cfg.guru || guruName;
        document.getElementById('snipGuru').value = db.cfg.nipGuru || "";
        document.getElementById('sWaGuru').value = db.cfg.waGuru || "";
        document.getElementById('sKepsek').value = db.cfg.kepsek || "KARYADI, S.Pd";
        document.getElementById('snipKepsek').value = db.cfg.nipKepsek || "";
        document.getElementById('sWaKepsek').value = db.cfg.waKepsek || "";
        document.getElementById('sSekolah').value = db.cfg.sekolah || "SD NEGERI MAJALENGKA WETAN VIII";
        
        if(db.cfg.foto) {
            document.getElementById('photo-img').src = db.cfg.foto;
            document.getElementById('photo-img').style.display = 'block';
            document.getElementById('photo-placeholder').style.display = 'none';
        }

        if(currentRole === 'KEPSEK') {
            document.getElementById('kepsek-wa-management').style.display = 'block';
            renderWaGuruManagement();
        }
    }

    async function renderWaGuruManagement() {
        let html = "";
        for(let g of allGurus) {
            if(g.id === 'KEPSEK') continue;
            const snap = await rtdb.ref(`config/${g.id}/waGuru`).once('value');
            const wa = snap.val() || "";
            html += `<div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                <label style="width:120px; font-weight:normal;">${g.nama}</label>
                <input type="text" placeholder="628..." value="${wa}" onchange="updateWaGuru('${g.id}', this.value)" style="flex:1;">
            </div>`;
        }
        document.getElementById('list-wa-guru-inputs').innerHTML = html;
    }

    async function updateWaGuru(roleId, val) {
        await rtdb.ref(`config/${roleId}/waGuru`).set(val);
    }

    function previewProfilePhoto(input) {
        const file = input.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-img').src = e.target.result;
                document.getElementById('photo-img').style.display = 'block';
                document.getElementById('photo-placeholder').style.display = 'none';
                db.cfg.foto = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    async function saveSetup() {
        db.cfg.sekolah = document.getElementById('sSekolah').value;
        db.cfg.guru = document.getElementById('sGuru').value;
        db.cfg.nipGuru = document.getElementById('snipGuru').value;
        db.cfg.waGuru = document.getElementById('sWaGuru').value;
        db.cfg.kepsek = document.getElementById('sKepsek').value;
        db.cfg.nipKepsek = document.getElementById('snipKepsek').value;
        db.cfg.waKepsek = document.getElementById('sWaKepsek').value;
        await rtdb.ref(`config/${currentRole}`).set(db.cfg);
        alert("Identitas Berhasil Disimpan!");
    }

    // --- FITUR SISWA ---
    async function saveSiswa() {
        const kls = document.getElementById('swKls').value;
        const data = {
            nisn: document.getElementById('swNisn').value,
            nis: document.getElementById('swNis').value,
            nama: document.getElementById('swNama').value.toUpperCase()
        };
        if(!data.nama) return;
        await rtdb.ref(`siswa_data/KLS${kls}`).push(data);
        alert("Siswa Ditambahkan!");
        renderSiswa();
    }

    async function renderSiswa() {
        const kls = document.getElementById('swKls').value;
        const snap = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        let html = "";
        let i = 1;
        snap.forEach(s => {
            const val = s.val();
            html += `<tr><td>${i++}</td><td>${val.nisn}</td><td>${val.nis}</td><td style="text-align:left">${val.nama}</td><td><button class="btn btn-red" onclick="delSiswa('${kls}','${s.key}')">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('bodySiswa').innerHTML = html;
    }

    async function delSiswa(kls, key) {
        if(confirm('Hapus siswa ini?')) {
            await rtdb.ref(`siswa_data/KLS${kls}/${key}`).remove();
            renderSiswa();
        }
    }

    // --- BARU: IMPORT EXCEL LOGIC ---
    async function importSiswaExcel(input) {
        const file = input.files[0];
        const kls = document.getElementById('swKls').value;

        if (!file) return;
        if (!confirm(`Import data siswa ke Kelas ${kls}?`)) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                let count = 0;
                for (let row of jsonData) {
                    const nisn = row.NISN || row.nisn || "";
                    const nis = row.NIS || row.nis || "";
                    const nama = (row.NAMA || row.nama || row.Nama || "").toUpperCase();

                    if (nama) {
                        await rtdb.ref(`siswa_data/KLS${kls}`).push({
                            nisn: nisn.toString(),
                            nis: nis.toString(),
                            nama: nama
                        });
                        count++;
                    }
                }

                alert(`Berhasil mengimpor ${count} siswa ke Kelas ${kls}`);
                input.value = ""; 
                renderSiswa();
            } catch (err) {
                console.error(err);
                alert("Gagal memproses file. Pastikan format kolom: NISN, NIS, NAMA");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function exportSiswaExcel() {
        const kls = document.getElementById('swKls').value;
        const snap = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        let data = [];
        snap.forEach(s => {
            const v = s.val();
            data.push({ "NISN": v.nisn, "NIS": v.nis, "NAMA": v.nama });
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siswa");
        XLSX.writeFile(wb, `Data_Siswa_Kelas_${kls}.xlsx`);
    }

    // --- MASTER CP/TP/ATP ---
    function showMasterForm(id) {
        document.querySelectorAll('.hidden-form').forEach(f => f.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    async function saveMaster(type) {
        const kls = document.getElementById('masterKls').value;
        const mapel = document.getElementById('masterMapel').value;
        let data = {};
        if(type === 'CP') data = { elemen: document.getElementById('cpElemen').value, isi: document.getElementById('cpIsi').value, kompetensi: document.getElementById('cpKompetensi').value, konten: document.getElementById('cpKonten').value };
        if(type === 'TP') data = { kode: document.getElementById('tpKode').value, isi: document.getElementById('tpIsi').value, kktp: document.getElementById('tpKktp').value };
        if(type === 'ATP') data = { isi: document.getElementById('atpIsi').value, waktu: document.getElementById('atpWaktu').value, dimensi: document.getElementById('atpDimensi').value, asesmen: document.getElementById('atpAsesmen').value };
        
        await rtdb.ref(`master_data/${kls}/${mapel}/${type}`).push(data);
        alert("Data Master Disimpan!");
        renderSemuaMaster();
    }

    async function renderSemuaMaster() {
        const kls = document.getElementById('masterKls').value;
        const mapel = document.getElementById('masterMapel').value;
        const snap = await rtdb.ref(`master_data/${kls}/${mapel}`).once('value');
        const v = snap.val() || {};
        
        let hCP = "", hTP = "", hATP = "";
        if(v.CP) Object.keys(v.CP).forEach(k => { hCP += `<tr><td>${v.CP[k].elemen}</td><td>${v.CP[k].isi}</td><td>${v.CP[k].kompetensi}</td><td>${v.CP[k].konten}</td><td><button class="btn btn-red" onclick="delMaster('${kls}','${mapel}','CP','${k}')">üóëÔ∏è</button></td></tr>`; });
        if(v.TP) Object.keys(v.TP).forEach(k => { hTP += `<tr><td>${v.TP[k].kode}</td><td>${v.TP[k].isi}</td><td>${v.TP[k].kktp}</td><td><button class="btn btn-red" onclick="delMaster('${kls}','${mapel}','TP','${k}')">üóëÔ∏è</button></td></tr>`; });
        if(v.ATP) { let i=1; Object.keys(v.ATP).forEach(k => { hATP += `<tr><td>${i++}</td><td>${v.ATP[k].isi}</td><td>${v.ATP[k].waktu}</td><td>${v.ATP[k].asesmen}</td><td><button class="btn btn-red" onclick="delMaster('${kls}','${mapel}','ATP','${k}')">üóëÔ∏è</button></td></tr>`; }); }
        
        document.getElementById('bodyCPNew').innerHTML = hCP;
        document.getElementById('bodyTPNew').innerHTML = hTP;
        document.getElementById('bodyATPNew').innerHTML = hATP;
    }

    async function delMaster(kls, mapel, type, key) {
        if(confirm('Hapus item ini?')) {
            await rtdb.ref(`master_data/${kls}/${mapel}/${type}/${key}`).remove();
            renderSemuaMaster();
        }
    }

    // --- AGENDA ---
    async function updateAgTP() {
        const kls = document.getElementById('agKls').value;
        const mapel = document.getElementById('agMapel').value;
        const snap = await rtdb.ref(`master_data/${kls}/${mapel}/TP`).once('value');
        let html = "<option value=''>-- Pilih TP --</option>";
        snap.forEach(tp => { html += `<option value="${tp.val().isi}">${tp.val().kode} - ${tp.val().isi}</option>`; });
        document.getElementById('agTP').innerHTML = html;
    }

    function processAgendaPhoto(input) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => tempAgendaPhoto = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveAgenda() {
        const kls = document.getElementById('agKls').value;
        const data = {
            tgl: document.getElementById('agTgl').value,
            mapel: document.getElementById('agMapel').value,
            tp: document.getElementById('agTP').value,
            materi: document.getElementById('agMateri').value,
            foto: tempAgendaPhoto,
            status: "MENUNGGU",
            guru: db.cfg.guru || currentRole
        };
        await rtdb.ref(`agenda_data/KLS${kls}`).push(data);
        alert("Agenda dikirim!");
        tempAgendaPhoto = "";
        renderAgenda();
    }

    async function renderAgenda() {
        const kls = document.getElementById('agKls').value;
        const snap = await rtdb.ref(`agenda_data/KLS${kls}`).once('value');
        let html = "";
        snap.forEach(a => {
            const v = a.val();
            const badge = v.status === 'SETUJU' ? 'btn-green' : (v.status === 'DITOLAK' ? 'btn-red' : 'btn-orange');
            html += `<tr><td>${v.tgl}</td><td>${v.tp}</td><td>${v.materi}</td><td>${v.foto ? `<img src="${v.foto}" width="50">` : '-'}</td><td><span class="status-badge ${badge}">${v.status}</span></td><td><button class="btn btn-red" onclick="delAgenda('${kls}','${a.key}')">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('bodyAgenda').innerHTML = html;
    }

    async function delAgenda(kls, key) {
        if(confirm('Hapus agenda?')) {
            await rtdb.ref(`agenda_data/KLS${kls}/${key}`).remove();
            renderAgenda();
        }
    }

    // --- ABSENSI ---
    async function renderAbsensi() {
        const kls = document.getElementById('abKls').value;
        const tgl = document.getElementById('abTgl').value || getTodayISO();
        const snapSiswa = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        const snapAbsen = await rtdb.ref(`absensi_data/KLS${kls}/${tgl}`).once('value');
        const absVal = snapAbsen.val() || {};

        let html = "";
        let i = 1;
        snapSiswa.forEach(s => {
            const nama = s.val().nama;
            const status = absVal[nama] || "H";
            html += `<tr><td>${i++}</td><td style="text-align:left">${nama}</td><td>
                <select onchange="saveAbsen('${kls}','${tgl}','${nama}', this.value)">
                    <option value="H" ${status==='H'?'selected':''}>Hadir</option>
                    <option value="S" ${status==='S'?'selected':''}>Sakit</option>
                    <option value="I" ${status==='I'?'selected':''}>Izin</option>
                    <option value="A" ${status==='A'?'selected':''}>Alfa</option>
                </select>
            </td></tr>`;
        });
        document.getElementById('bodyAbsensi').innerHTML = html;
    }

    async function saveAbsen(kls, tgl, nama, val) {
        await rtdb.ref(`absensi_data/KLS${kls}/${tgl}/${nama}`).set(val);
    }

    // --- REKAP ABSEN ---
    async function renderRekapAbsen() {
        const kls = document.getElementById('rekKls').value;
        const bulanStr = document.getElementById('rekBulan').value; 
        if(!bulanStr) return;

        const year = bulanStr.split('-')[0];
        const month = bulanStr.split('-')[1];
        const daysInMonth = new Date(year, month, 0).getDate();

        let head = `<tr><th>NAMA</th>`;
        for(let d=1; d<=daysInMonth; d++) head += `<th>${d}</th>`;
        head += `<th>S</th><th>I</th><th>A</th></tr>`;
        document.getElementById('headRekap').innerHTML = head;

        const snapSiswa = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        const snapAbsen = await rtdb.ref(`absensi_data/KLS${kls}`).once('value');
        const absData = snapAbsen.val() || {};

        let body = "";
        snapSiswa.forEach(s => {
            const nama = s.val().nama;
            let row = `<tr><td style="text-align:left">${nama}</td>`;
            let sCount=0, iCount=0, aCount=0;

            for(let d=1; d<=daysInMonth; d++) {
                const tglKey = `${year}-${month}-${d.toString().padStart(2,'0')}`;
                const st = (absData[tglKey] && absData[tglKey][nama]) ? absData[tglKey][nama] : ".";
                row += `<td>${st}</td>`;
                if(st==='S') sCount++; if(st==='I') iCount++; if(st==='A') aCount++;
            }
            row += `<td>${sCount}</td><td>${iCount}</td><td>${aCount}</td></tr>`;
            body += row;
        });
        document.getElementById('bodyRekap').innerHTML = body;
    }

    // --- MONITOR KEPSEK ---
    async function renderMonitorAgenda() {
        document.getElementById('monitor-title').innerText = "üìã Persetujuan Agenda Harian";
        let html = `<div class="table-res"><table><thead><tr><th>GURU</th><th>KELAS</th><th>TGL</th><th>MATERI</th><th>FOTO</th><th>AKSI</th></tr></thead><tbody>`;
        const snap = await rtdb.ref(`agenda_data`).once('value');
        snap.forEach(klsFolder => {
            const kls = klsFolder.key;
            klsFolder.forEach(item => {
                const v = item.val();
                if(v.status === 'MENUNGGU') {
                    html += `<tr><td>${v.guru}</td><td>${kls}</td><td>${v.tgl}</td><td>${v.materi}</td><td>${v.foto?`<img src="${v.foto}" width="50">`:'-'}</td><td>
                        <button class="btn btn-green" onclick="aksiAgenda('${kls}','${item.key}','SETUJU')">‚úÖ</button>
                        <button class="btn btn-red" onclick="aksiAgenda('${kls}','${item.key}','DITOLAK')">‚ùå</button>
                    </td></tr>`;
                }
            });
        });
        html += `</tbody></table></div>`;
        document.getElementById('area-monitor-kepsek').innerHTML = html;
        switchTab('tab-kepsek');
    }

    async function aksiAgenda(kls, key, status) {
        await rtdb.ref(`agenda_data/${kls}/${key}/status`).set(status);
        renderMonitorAgenda();
    }

    async function renderMonitorAbsenGuru() {
        document.getElementById('monitor-title').innerText = "üë®‚Äçüè´ Presensi Kehadiran Guru";
        const tgl = getTodayISO();
        let html = `<h4>Tanggal: ${tgl}</h4><div class="table-res"><table><thead><tr><th>GURU</th><th>JAM</th><th>STATUS</th><th>JARAK</th></tr></thead><tbody>`;
        const snap = await rtdb.ref(`absen_guru/${tgl}`).once('value');
        snap.forEach(g => {
            const v = g.val();
            const cStatus = v.status === 'HADIR' ? 'color:green' : 'color:red';
            html += `<tr><td>${v.nama}</td><td>${v.waktu}</td><td style="font-weight:bold; ${cStatus}">${v.status}</td><td>${v.latlng}</td></tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('area-monitor-kepsek').innerHTML = html;
        switchTab('tab-kepsek');
    }

    async function renderMonitorAbsenSiswa() {
        document.getElementById('monitor-title').innerText = "üìä Monitor Absensi Siswa";
        document.getElementById('area-monitor-kepsek').innerHTML = `<p>Gunakan menu Rekap Bulanan di akun Guru untuk melihat detail.</p>`;
        switchTab('tab-kepsek');
    }

    // --- RAPOR & NILAI ---
    async function renderRaport() {
        const kls = document.getElementById('rpKls').value;
        const mapel = document.getElementById('rpMapel').value;
        const sem = currentSemester;

        const snapSiswa = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        const snapTP = await rtdb.ref(`master_data/${kls}/${mapel}/TP`).once('value');
        const snapNilai = await rtdb.ref(`nilai_data/${kls}/${mapel}/SEM${sem}`).once('value');
        const nilVal = snapNilai.val() || {};

        let listTP = [];
        snapTP.forEach(t => listTP.push({ key: t.key, kode: t.val().kode, isi: t.val().isi }));

        let head = `<tr><th rowspan="2">NAMA SISWA</th><th colspan="${listTP.length || 1}">TUJUAN PEMBELAJARAN (TP)</th><th rowspan="2">RATA</th></tr><tr>`;
        if(listTP.length > 0) listTP.forEach(t => head += `<th>${t.kode}</th>`);
        else head += `<th>-</th>`;
        head += `</tr>`;
        document.getElementById('headRaport').innerHTML = head;

        let body = "";
        snapSiswa.forEach(s => {
            const nama = s.val().nama;
            let row = `<tr><td style="text-align:left">${nama}</td>`;
            let total = 0, count = 0;
            
            if(listTP.length > 0) {
                listTP.forEach(t => {
                    const skor = (nilVal[nama] && nilVal[nama][t.key]) ? nilVal[nama][t.key] : "";
                    row += `<td><input type="number" value="${skor}" style="width:50px" onchange="saveNilai('${kls}','${mapel}','${sem}','${nama}','${t.key}', this.value)"></td>`;
                    if(skor) { total += parseFloat(skor); count++; }
                });
            } else { row += `<td>-</td>`; }

            const rata = count > 0 ? (total/count).toFixed(1) : "-";
            row += `<td style="font-weight:bold">${rata}</td></tr>`;
            body += row;
        });
        document.getElementById('bodyRaport').innerHTML = body;

        // Footer Print
        document.getElementById('fGuru').innerText = db.cfg.guru || "-";
        document.getElementById('fnipGuru').innerText = db.cfg.nipGuru || "-";
        document.getElementById('fKepsek').innerText = db.cfg.kepsek || "-";
        document.getElementById('fnipKepsek').innerText = db.cfg.nipKepsek || "-";
        document.getElementById('fTanggal').innerText = "Majalengka, " + new Date().toLocaleDateString('id-ID');
        document.getElementById('pSekolah').innerText = db.cfg.sekolah || "SD NEGERI MAJALENGKA WETAN VIII";
    }

    async function saveNilai(kls, mapel, sem, nama, tpKey, val) {
        await rtdb.ref(`nilai_data/${kls}/${mapel}/SEM${sem}/${nama}/${tpKey}`).set(val);
    }

    // --- MODUL AJAR ---
    async function updateMdTP() {
        const kls = document.getElementById('mdKls').value;
        const mapel = document.getElementById('mdMapel').value;
        const snap = await rtdb.ref(`master_data/${kls}/${mapel}/TP`).once('value');
        let html = "<option value=''>-- Pilih TP --</option>";
        snap.forEach(tp => { html += `<option value="${tp.key}">${tp.val().kode} - ${tp.val().isi}</option>`; });
        document.getElementById('mdTP').innerHTML = html;
    }

    async function loadModulDetail() {
        const kls = document.getElementById('mdKls').value;
        const mapel = document.getElementById('mdMapel').value;
        const tpKey = document.getElementById('mdTP').value;
        if(!tpKey) return;
        const snap = await rtdb.ref(`modul_data/${kls}/${mapel}/${tpKey}`).once('value');
        const v = snap.val() || {};
        document.getElementById('mdWaktu').value = v.waktu || "";
        document.getElementById('mdMetode').value = v.metode || "";
        document.getElementById('mdLangkah').value = v.langkah || "";
        document.getElementById('mdMedia').value = v.media || "";
        document.getElementById('mdAsesmen').value = v.asesmen || "";
    }

    async function saveModul() {
        const kls = document.getElementById('mdKls').value;
        const mapel = document.getElementById('mdMapel').value;
        const tpKey = document.getElementById('mdTP').value;
        if(!tpKey) return alert("Pilih TP dulu!");
        const data = {
            waktu: document.getElementById('mdWaktu').value,
            metode: document.getElementById('mdMetode').value,
            langkah: document.getElementById('mdLangkah').value,
            media: document.getElementById('mdMedia').value,
            asesmen: document.getElementById('mdAsesmen').value
        };
        await rtdb.ref(`modul_data/${kls}/${mapel}/${tpKey}`).set(data);
        alert("Modul Ajar disimpan!");
    }

    // --- EKSKUL & KOKUL ---
    function processKegiatanPhoto(input) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => tempKegiatanPhoto = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveKegiatan() {
        const data = {
            jenis: document.getElementById('kgJenis').value,
            nama: document.getElementById('kgNama').value,
            tgl: document.getElementById('kgTgl').value,
            ket: document.getElementById('kgKet').value,
            foto: tempKegiatanPhoto,
            status: "MENUNGGU",
            guru: db.cfg.guru || currentRole
        };
        await rtdb.ref(`kegiatan_data`).push(data);
        alert("Kegiatan diajukan!");
        tempKegiatanPhoto = "";
        renderKegiatan();
    }

    async function renderKegiatan() {
        const snap = await rtdb.ref(`kegiatan_data`).once('value');
        let html = "";
        snap.forEach(k => {
            const v = k.val();
            if(v.guru === (db.cfg.guru || currentRole)) {
                html += `<tr><td>${v.jenis}</td><td>${v.nama}</td><td>${v.tgl}</td><td>${v.foto?`<img src="${v.foto}" width="40">`:'-'}</td><td>${v.status}</td><td><button class="btn btn-red" onclick="delKegiatan('${k.key}')">üóëÔ∏è</button></td></tr>`;
            }
        });
        document.getElementById('bodyKegiatan').innerHTML = html;
    }

    async function delKegiatan(key) {
        if(confirm('Hapus kegiatan?')) { await rtdb.ref(`kegiatan_data/${key}`).remove(); renderKegiatan(); }
    }

    async function renderMonitorKegiatan() {
        document.getElementById('monitor-title').innerText = "üèÜ Persetujuan Kegiatan";
        let html = `<div class="table-res"><table><thead><tr><th>GURU</th><th>JENIS</th><th>KEGIATAN</th><th>FOTO</th><th>AKSI</th></tr></thead><tbody>`;
        const snap = await rtdb.ref(`kegiatan_data`).once('value');
        snap.forEach(item => {
            const v = item.val();
            if(v.status === 'MENUNGGU') {
                html += `<tr><td>${v.guru}</td><td>${v.jenis}</td><td>${v.nama}</td><td>${v.foto?`<img src="${v.foto}" width="50">`:'-'}</td><td>
                    <button class="btn btn-green" onclick="aksiKegiatan('${item.key}','SETUJU')">‚úÖ</button>
                    <button class="btn btn-red" onclick="aksiKegiatan('${item.key}','DITOLAK')">‚ùå</button>
                </td></tr>`;
            }
        });
        html += `</tbody></table></div>`;
        document.getElementById('area-monitor-kepsek').innerHTML = html;
        switchTab('tab-kepsek');
    }

    async function aksiKegiatan(key, status) {
        await rtdb.ref(`kegiatan_data/${key}/status`).set(status);
        renderMonitorKegiatan();
    }

    // --- KOSP & LINK ---
    async function saveKosp() {
        const data = { nama: document.getElementById('ksNama').value, link: document.getElementById('ksLink').value };
        await rtdb.ref(`kosp_data/${currentRole}`).push(data);
        alert("Link disimpan!");
        renderKosp();
    }

    async function renderKosp() {
        const snap = await rtdb.ref(`kosp_data/${currentRole}`).once('value');
        let html = "";
        snap.forEach(k => {
            const v = k.val();
            html += `<tr><td>${v.nama}</td><td><a href="${v.link}" target="_blank">BUKA LINK</a></td><td><button class="btn btn-red" onclick="delKosp('${k.key}')">üóëÔ∏è</button></td></tr>`;
        });
        document.getElementById('bodyKosp').innerHTML = html;
    }

    async function delKosp(key) {
        if(confirm('Hapus link?')) { await rtdb.ref(`kosp_data/${currentRole}/${key}`).remove(); renderKosp(); }
    }

    async function renderMonitorLinkGuru() {
        document.getElementById('monitor-title').innerText = "üìÇ Dokumen & Perangkat Guru";
        let html = `<div class="table-res"><table><thead><tr><th>GURU</th><th>DOKUMEN</th><th>LINK</th></tr></thead><tbody>`;
        const snap = await rtdb.ref(`kosp_data`).once('value');
        snap.forEach(guruLink => {
            const guruID = guruLink.key;
            guruLink.forEach(item => {
                const v = item.val();
                html += `<tr><td>${guruID}</td><td>${v.nama}</td><td><a href="${v.link}" target="_blank">LIHAT DRIVE</a></td></tr>`;
            });
        });
        html += `</tbody></table></div>`;
        document.getElementById('area-monitor-kepsek').innerHTML = html;
        switchTab('tab-kepsek');
    }

    async function renderMonitorNilai() {
        document.getElementById('monitor-title').innerText = "üìú Monitor Nilai & Raport";
        document.getElementById('area-monitor-kepsek').innerHTML = `<p>Gunakan menu Rapor & Nilai untuk memantau capaian setiap kelas.</p>`;
        switchTab('tab-kepsek');
    }

    // --- FITUR ULANGAN ---
    function tambahSoalBaru() {
        const id = daftarSoal.length;
        const html = `
            <div class="card" id="soal-${id}" style="border-left: 4px solid var(--accent);">
                <div class="form-group">
                    <label>Soal #${id+1}</label>
                    <textarea id="qText-${id}" placeholder="Tulis soal di sini..." rows="2" style="width:100%"></textarea>
                </div>
                <div class="form-group">
                    <div class="field"><label>Tipe</label><select id="qType-${id}" onchange="toggleOpsi(${id})"><option value="PG">Pilihan Ganda</option><option value="ESAI">Esai</option></select></div>
                    <div class="field" id="area-kunci-${id}"><label>Kunci Jawaban (A/B/C/D)</label><input type="text" id="qKunci-${id}" maxlength="1"></div>
                </div>
                <div id="area-opsi-${id}">
                    <div class="form-group">
                        <input type="text" id="opsiA-${id}" placeholder="Opsi A" style="flex:1">
                        <input type="text" id="opsiB-${id}" placeholder="Opsi B" style="flex:1">
                        <input type="text" id="opsiC-${id}" placeholder="Opsi C" style="flex:1">
                        <input type="text" id="opsiD-${id}" placeholder="Opsi D" style="flex:1">
                    </div>
                </div>
                <button class="btn btn-red" onclick="hapusEntrySoal(${id})">HAPUS SOAL</button>
            </div>
        `;
        document.getElementById('area-input-soal').insertAdjacentHTML('beforeend', html);
        daftarSoal.push({ id });
    }

    function toggleOpsi(id) {
        const tipe = document.getElementById(`qType-${id}`).value;
        document.getElementById(`area-opsi-${id}`).style.display = tipe === 'PG' ? 'block' : 'none';
        document.getElementById(`area-kunci-${id}`).style.display = tipe === 'PG' ? 'block' : 'none';
    }

    async function updateUlTP() {
        const kls = document.getElementById('agKls').value; // Mengikuti kelas login guru
        const mapel = document.getElementById('ulMapel').value;
        const snap = await rtdb.ref(`master_data/${kls}/${mapel}/TP`).once('value');
        let html = "<option value=''>-- Pilih TP (Opsional) --</option>";
        snap.forEach(tp => { html += `<option value="${tp.key}">${tp.val().kode} - ${tp.val().isi}</option>`; });
        document.getElementById('ulTargetTP').innerHTML = html;
    }

    async function simpanUlangan() {
        const kls = document.getElementById('agKls').value;
        const judul = document.getElementById('ulJudul').value;
        const mapel = document.getElementById('ulMapel').value;
        const tpKey = document.getElementById('ulTargetTP').value;

        if(!judul) return alert("Judul ulangan harus diisi!");

        let soalFinal = [];
        for(let i=0; i<daftarSoal.length; i++) {
            const el = document.getElementById(`qText-${i}`);
            if(!el) continue;
            soalFinal.push({
                tanya: el.value,
                tipe: document.getElementById(`qType-${i}`).value,
                kunci: document.getElementById(`qKunci-${i}`).value.toUpperCase(),
                opsi: [
                    document.getElementById(`opsiA-${i}`).value,
                    document.getElementById(`opsiB-${i}`).value,
                    document.getElementById(`opsiC-${i}`).value,
                    document.getElementById(`opsiD-${i}`).value
                ]
            });
        }

        await rtdb.ref(`ulangan_aktif/GK${kls}`).set({
            judul, mapel, tpKey, soal: soalFinal, status: "OPEN"
        });
        alert("Ulangan telah aktif! Siswa sudah bisa mengerjakan.");
        renderKoreksiGuru();
    }

    async function loadDaftarNamaSiswa(kls) {
        if(!kls) return;
        const snap = await rtdb.ref(`siswa_data/KLS${kls}`).once('value');
        let html = "<option value=''>-- Pilih Nama --</option>";
        snap.forEach(s => { html += `<option value="${s.val().nama}">${s.val().nama}</option>`; });
        document.getElementById('loginSwNama').innerHTML = html;
    }

    async function mulaiUlanganSiswa() {
        async function mulaiUlanganSiswa() {
    const kls = document.getElementById('loginSwKls').value;
    const nama = document.getElementById('loginSwNama').value;
    const mapel = document.getElementById('loginSwMapel').value; // Ambil mapel yang dipilih

    if(!kls || !nama || !mapel) {
        alert("Pilih Kelas, Mapel, dan Nama dulu ya!");
        return;
    }

    const snap = await rtdb.ref(`ulangan_aktif/GK${kls}`).once('value');
    const data = snap.val();

    if(!data) {
        alert("Maaf, tidak ada ulangan yang aktif di kelas ini.");
        return;
    }

    // CEK: Apakah mapel yang dipilih siswa sama dengan mapel yang diaktifkan Guru?
    if(data.metadata.mapel !== mapel) {
        alert("Maaf, ulangan untuk mata pelajaran ini belum dibuka oleh Guru.");
        return;
    }

    siswaAktif = nama;
    renderSoalSiswa(data.soal, data.metadata);
    switchTab('tab-kerjakan-ulangan');
}

    async function selesaiUlangan() {
        const kls = document.getElementById('loginSwKls').value;
        const snapAktif = await rtdb.ref(`ulangan_aktif/GK${kls}`).once('value');
        const metadata = snapAktif.val();
        
        let benarPG = 0;
        let totalSoal = daftarSoal.length;

        daftarSoal.forEach((s, i) => {
            if(s.tipe === 'PG') {
                const pil = document.querySelector(`input[name="q${i}"]:checked`);
                if(pil && pil.value === s.kunci) benarPG++;
            }
        });

        const nilaiHitung = (benarPG / totalSoal) * 100;

        await rtdb.ref(`hasil_ulangan/GK${kls}/${siswaAktif}`).push({
            nilai: nilaiHitung.toFixed(0),
            tgl: new Date().toLocaleString(),
            judul: metadata.judul
        });

        if(metadata.tpKey) {
            await rtdb.ref(`nilai_data/${kls}/${metadata.mapel}/SEM${currentSemester}/${siswaAktif}/${metadata.tpKey}`).set(nilaiHitung.toFixed(0));
        }

        alert(`Selesai! Nilai Anda: ${nilaiHitung.toFixed(0)}`);
        location.reload();
    }

    async function renderKoreksiGuru() {
        const kls = document.getElementById('agKls').value;
        const snap = await rtdb.ref(`hasil_ulangan/GK${kls}`).once('value');
        let html = "<table><thead><tr><th>NAMA</th><th>JUDUL</th><th>TGL</th><th>NILAI</th></tr></thead><tbody>";
        snap.forEach(siswa => {
            siswa.forEach(h => {
                const v = h.val();
                html += `<tr><td>${siswa.key}</td><td>${v.judul}</td><td>${v.tgl}</td><td style="font-weight:bold">${v.nilai}</td></tr>`;
            });
        });
        html += "</tbody></table>";
        document.getElementById('area-koreksi-guru').innerHTML = html;
    }

</script>
</body>
</html>

