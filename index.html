<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMINISTRASI DIGITAL v45.0 - TOTAL SUPREME MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary: #0f172a; --accent: #2563eb; --sidebar: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --white: #ffffff; --bg: #f8fafc; --shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; font-size: 0.85rem; transition: 0.2s ease; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin:0; display:flex; min-height:100vh; color: var(--primary); }
        
        .u-screen { position: fixed; inset: 0; background: var(--primary); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 25px; overflow-y: auto; }
        .u-glass { background: white; padding: 45px 35px; border-radius: 35px; width: 100%; max-width: 480px; text-align: center; box-shadow: 0 45px 120px -20px rgba(0,0,0,0.8); }
        .hidden { display: none !important; }

        .sidebar { width: 280px; background: var(--sidebar); color: white; height: 100vh; position: fixed; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 40px 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .m-lbl { font-size: 0.65rem; color: #64748b; text-transform: uppercase; padding: 25px 30px 8px; font-weight: 800; letter-spacing: 2px; }
        .m-item { display: flex; align-items: center; padding: 14px 30px; color: #94a3b8; cursor: pointer; text-decoration: none; border-left: 4px solid transparent; }
        .m-item i { width: 30px; font-size: 1.1rem; }
        .m-item:hover, .m-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); border-left-color: var(--accent); }
        .logout { margin-top: auto; padding: 25px; border-top: 1px solid rgba(255,255,255,0.05); color: var(--danger); font-weight: 900; text-align: center; cursor: pointer; }

        .main { flex: 1; margin-left: 280px; width: calc(100% - 280px); display: flex; flex-direction: column; min-height: 100vh; }
        .topbar { background: white; height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 45px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 990; }
        .container { padding: 40px; max-width: 1400px; margin: 0 auto; width: 100%; }
        
        .card { background: white; border-radius: 24px; box-shadow: var(--shadow); padding: 30px; margin-bottom: 25px; border: 1px solid #f1f5f9; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .f-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { font-size: 0.75rem; font-weight: 800; color: #475569; margin-bottom: 8px; display: block; }
        input, select, textarea { width: 100%; padding: 12px 18px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: inherit; background: #f8fafc; }
        input:focus { border-color: var(--accent); outline: none; background: white; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 15px; text-align: left; font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 800; }
        td { padding: 14px 15px; border-bottom: 1px solid #f1f5f9; }
        .table-res { border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0; }

        .btn { padding: 10px 22px; border-radius: 12px; font-weight: 800; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-warn { background: var(--warning); color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-xs { padding: 5px 10px; font-size: 0.65rem; border-radius: 6px; }

        .badge { padding: 4px 10px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; }
        .bg-pending { background: #fff7ed; color: #c2410c; }
        .bg-ok { background: #f0fdf4; color: #15803d; }

        @media print {
            .sidebar, .topbar, .btn, .no-print, button { display: none !important; }
            .main { margin-left: 0 !important; width: 100% !important; }
            .card { box-shadow: none !important; border: 1px solid black !important; border-radius: 0; }
            .print-kop { display: block !important; text-align: center; border-bottom: 3px solid black; margin-bottom: 20px; padding-bottom: 10px; }
            .signature { display: grid !important; grid-template-columns: 1fr 1fr; margin-top: 40px; text-align: center; }
            .sign-box { margin-top: 60px; font-weight: 900; text-decoration: underline; }
        }
        .print-kop, .signature { display: none; }
    
/* =========================
   MOBILE RESPONSIVE FIX
========================= */
@media (max-width: 768px) {

    body {
        flex-direction: column;
    }

    .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        width: 260px;
        height: 100%;
        transition: 0.3s ease;
    }

    .sidebar.show {
        left: 0;
    }

    .main {
        margin-left: 0 !important;
        width: 100% !important;
    }

    .topbar {
        height: 65px;
        padding: 0 15px;
    }

    .container {
        padding: 15px;
    }

    .card {
        padding: 18px;
        border-radius: 16px;
    }

    .f-row {
        grid-template-columns: 1fr !important;
    }

    .table-res {
        overflow-x: auto;
    }

    table {
        min-width: 600px;
    }

    #d-clock-txt {
        font-size: 2.5rem !important;
        letter-spacing: -1px !important;
    }

    .btn {
        font-size: 0.8rem;
        padding: 12px;
    }

    #p-avatar {
        width: 38px;
        height: 38px;
        font-size: 1rem;
    }
}

</style>
</head>
<body>

<div id="scr-setup" class="u-screen hidden">
    <div class="u-glass">
        <h2 style="font-weight:900;">AKTIVASI DATABASE</h2>
        <p style="color:gray; margin-bottom:25px;">Masukkan NPSN Sekolah untuk sinkronisasi Cloud.</p>
        <input type="text" id="reg-npsn" placeholder="NPSN (8 Digit)" style="margin-bottom:10px;">
        <input type="text" id="reg-nama" placeholder="Nama Sekolah Terdaftar" style="margin-bottom:20px;">
        <button onclick="saveActivation()" class="btn btn-blue" style="width:100%; height:50px;">AKTIFKAN SISTEM v45</button>
    </div>
</div>

<div id="scr-login" class="u-screen hidden">
    <div class="u-glass">
        <h1 id="v-school-name" style="margin:0; font-weight:900; color:var(--accent);">DIREKTORI</h1>
        <p id="v-school-npsn" style="font-weight:800; font-size:0.75rem; color:#64748b; margin-bottom:30px;"></p>
        <input type="text" id="log-u" placeholder="ID User Account" style="margin-bottom:10px;">
        <input type="password" id="log-p" placeholder="Security PIN" style="margin-bottom:20px;">
        <button onclick="handleLogin()" class="btn btn-blue" style="width:100%; height:50px;">MASUK KE PORTAL</button>
    </div>
</div>

<div id="m-gps" class="u-screen hidden">
    <div class="u-glass">
        <div style="font-size:4rem;">üìç</div>
        <h3 style="margin-top:10px;">RADIUS GPS SEKOLAH</h3>
        <p id="t-dist">Menghitung jarak ke titik koordinat sekolah...</p>
        <button id="b-ab-done" class="btn btn-blue" style="width:100%; padding:15px;" onclick="execAbsen()" disabled>KONFIRMASI KEHADIRAN</button>
        <button onclick="closeGps()" class="btn" style="margin-top:10px; color:red;">Batal</button>
    </div>
</div>

<div id="sidebar" class="sidebar hidden">
    <div class="sidebar-header"><h3 id="brand">SUPREME MASTER</h3><div id="clk" style="font-size:0.7rem; color:#94a3b8;"></div></div>
    <div class="sidebar-menu">
        <div onclick="switchTab('dashboard')" class="m-item active"><i class="fa fa-home"></i> DASHBOARD</div>
        
        <div id="menu-area-guru" class="hidden">
            <p class="m-lbl">Administrasi Guru</p>
            <div onclick="switchTab('g-siswa')" class="m-item"><i class="fa fa-user-graduate"></i> Akun Siswa</div>
            <div onclick="switchTab('g-absen')" class="m-item"><i class="fa fa-calendar-check"></i> Absensi Siswa</div>
            <div onclick="switchTab('g-agenda')" class="m-item"><i class="fa fa-book"></i> Agenda Harian</div>
            <div onclick="switchTab('g-modul')" class="m-item"><i class="fa fa-folder-open"></i> Modul Mingguan</div>
            <div onclick="switchTab('g-ujian')" class="m-item"><i class="fa fa-file-signature"></i> Bank Soal Ujian</div>
            <div onclick="switchTab('g-nilai')" class="m-item"><i class="fa fa-award"></i> Input Nilai SD</div>
        </div>

        <div id="menu-area-kepsek" class="hidden">
            <p class="m-lbl">Monitoring Kepsek</p>
            <div onclick="switchTab('k-absen')" class="m-item"><i class="fa fa-user-clock"></i> Ceklok & Absensi Guru</div>
            <div onclick="switchTab('k-agenda')" class="m-item"><i class="fa fa-check-double"></i> Review Agenda</div>
            <div onclick="switchTab('k-modul')" class="m-item"><i class="fa fa-paste"></i> Review Modul</div>
            <div onclick="switchTab('k-rekap')" class="m-item"><i class="fa fa-list-ol"></i> Rekap Nilai Mapel</div>
            <p class="m-lbl">Pengaturan</p>
            <div onclick="switchTab('k-staf')" class="m-item" style="color:var(--success);"><i class="fa fa-users-cog"></i> DATA STAF & PIN</div>
        </div>

        <div onclick="location.reload()" class="logout">LOGOUT SYSTEM</div>
    </div>
</div>

<div id="main-ui" class="main hidden">
    <div class="topbar">
<button onclick="toggleMenu()" class="btn" style="display:none;" id="mobileMenuBtn">‚ò∞</button>

        <h4 id="v-title-label" style="text-transform:uppercase; font-weight:900;">DASHBOARD</h4>
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="text-align:right;">
                <div id="p-name" style="font-weight:900;">...</div>
                <div id="p-role" style="font-size:0.6rem; color:var(--accent); font-weight:900;">GURU</div>
            </div>
            <div id="p-avatar" style="width:45px; height:45px; border-radius:14px; background:var(--accent); color:white; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:1.3rem;">?</div>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-dashboard" class="tab-content active">
            <div class="card" style="background:var(--primary); color:white; text-align:center; padding:50px;">
                <h4 id="d-date-txt" style="color:var(--success);">Tgl Hari Ini</h4>
                <h1 id="d-clock-txt" style="font-size:5rem; margin:10px 0; font-weight:900; letter-spacing:-3px;">00:00:00</h1>
                <p style="opacity:0.6; margin-bottom:30px;">Silahkan lakukan Ceklok Kehadiran (Radius 200m)</p>
                <button onclick="openGps()" class="btn btn-green" style="padding:18px 45px; border-radius:50px;"><i class="fa fa-map-marker-alt"></i> CEKLOK KEHADIRAN GURU</button>
            </div>
            
            <div id="k-stats-row" class="hidden" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="card" style="border-left:8px solid var(--accent);">
                    <p>Guru Hadir Hari Ini</p>
                    <h2 id="sk-absen">0</h2>
                </div>
                <div class="card" style="border-left:8px solid var(--warning);">
                    <p>Agenda Menunggu Review</p>
                    <h2 id="sk-agenda">0</h2>
                </div>
                <div class="card" style="border-left:8px solid var(--danger);">
                    <p>Modul Belum Dikirim</p>
                    <h2 id="sk-modul">0</h2>
                </div>
            </div>
        </div>

        <div id="tab-g-siswa" class="tab-content">
            <div class="card">
                <h3>Buat Akun Login Siswa</h3>
                <div class="f-row">
                    <div><label>Nama Lengkap Siswa</label><input type="text" id="gs-nama"></div>
                    <div><label>Username Login</label><input type="text" id="gs-user"></div>
                    <div><label>Password</label><input type="text" id="gs-pass"></div>
                    <div><label>Kelas</label><select id="gs-kls"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
                </div>
                <button onclick="addStudent()" class="btn btn-blue" style="width:100%;"><i class="fa fa-plus"></i> DAFTARKAN SISWA</button>
                <div class="table-res" style="margin-top:20px;">
                    <table><thead><tr><th>User</th><th>Nama</th><th>Kelas</th><th>Pass</th><th>Aksi</th></tr></thead><tbody id="tbl-gs-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-g-absen" class="tab-content">
            <div class="card">
                <h3>Absensi Siswa Harian (H/S/I/A)</h3>
                <div class="f-row">
                    <div><label>Pilih Kelas</label><select id="ga-kls-sel" onchange="renderAbsenSiswa()"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
                    <div><label>Tanggal</label><input type="text" class="global-date-inp" readonly></div>
                </div>
                <div class="table-res">
                    <table><thead><tr><th>Nama Siswa</th><th>Kelas</th><th>Status Hadir</th></tr></thead><tbody id="tbl-ga-list"></tbody></table>
                </div>
                <button onclick="saveAbsenSiswa()" class="btn btn-green" style="width:100%; margin-top:20px;"><i class="fa fa-save"></i> SIMPAN ABSENSI SISWA</button>
            </div>
        </div>

        <div id="tab-g-agenda" class="tab-content">
            <div class="card" id="print-agenda-area">
                <div class="print-kop">
                    <h2>PEMERINTAH KABUPATEN MAJALENGKA</h2>
                    <h1 class="v-sch-lbl">NAMA SEKOLAH</h1>
                    <hr>
                    <h2 style="text-decoration:underline;">AGENDA HARIAN GURU</h2>
                </div>
                <h3>Input Agenda Harian</h3>
                <div class="f-row">
                    <div><label>Tanggal</label><input type="text" class="global-date-inp" readonly></div>
                    <div><label>CP (Capaian Pembelajaran)</label><input type="text" id="gag-cp" placeholder="Elemen Capaian"></div>
                    <div><label>TP (Tujuan Pembelajaran)</label><input type="text" id="gag-tp" placeholder="Kode TP"></div>
                </div>
                <label>Uraian Materi Pembelajaran Secara Detail</label>
                <textarea id="gag-mat" rows="6" placeholder="Tuliskan materi yang diajarkan hari ini..."></textarea>
                <div class="no-print">
                    <button onclick="submitAgenda()" class="btn btn-blue" style="width:100%; height:55px; margin-top:20px;"><i class="fa fa-paper-plane"></i> AJUKAN KE KEPALA SEKOLAH</button>
                    <button onclick="window.print()" class="btn btn-warn" style="width:100%; margin-top:10px;"><i class="fa fa-print"></i> CETAK AGENDA INI</button>
                </div>
                <div class="signature">
                    <div class="sig-item">Mengetahui,<br>Kepala Sekolah<br><br><br><span class="v-kepsek-name">....................</span></div>
                    <div class="sig-item">Majalengka, <span class="global-text-date"></span><br>Guru Kelas<br><br><br><b id="p-sign-name">Guru</b></div>
                </div>
            </div>
        </div>

        <div id="tab-g-modul" class="tab-content">
            <div class="card">
                <h3>Modul Ajar Mingguan (RPP Digital)</h3>
                <div class="f-row">
                    <div><label>Judul Modul</label><input type="text" id="gm-title"></div>
                    <div><label>Mata Pelajaran</label><input type="text" id="gm-mapel"></div>
                </div>
                <label>Langkah-langkah Kegiatan Pembelajaran</label>
                <textarea id="gm-logic" rows="8"></textarea>
                <button onclick="submitModul()" class="btn btn-green" style="width:100%; margin-top:20px;"><i class="fa fa-upload"></i> KIRIM MODUL KE KEPSEK</button>
            </div>
        </div>

        <div id="tab-g-ujian" class="tab-content">
            <div class="card">
                <h3>Bank Soal Ujian Digital</h3>
                <div class="f-row">
                    <input type="text" id="ex-header" placeholder="Judul Ujian (Contoh: STS Ganjil Matematika)">
                    <select id="ex-type" onchange="toggleExType()">
                        <option value="PG">Pilihan Ganda (PG)</option>
                        <option value="ES">Essay / Uraian</option>
                    </select>
                </div>
                <div id="ex-form-area" style="background:#f1f5f9; padding:20px; border-radius:15px; border:2px dashed #cbd5e1;">
                    <label>Butir Pertanyaan</label><textarea id="ex-q" rows="3"></textarea>
                    <div id="ex-pg-ops" style="margin-top:10px;">
                        <input type="text" id="ex-oa" placeholder="Opsi A" style="margin-bottom:5px;">
                        <input type="text" id="ex-ob" placeholder="Opsi B" style="margin-bottom:5px;">
                        <input type="text" id="ex-oc" placeholder="Opsi C" style="margin-bottom:5px;">
                        <input type="text" id="ex-od" placeholder="Opsi D" style="margin-bottom:5px;">
                    </div>
                    <label>Kunci Jawaban Benar</label>
                    <input type="text" id="ex-ans" placeholder="Isi A/B/C/D jika PG, atau kata kunci jika Essay">
                </div>
                <button onclick="saveQuestion()" class="btn btn-blue" style="width:100%; margin-top:20px;"><i class="fa fa-save"></i> SIMPAN KE BANK SOAL</button>
                <div class="table-res" style="margin-top:20px;">
                    <table><thead><tr><th>Soal/Judul</th><th>Tipe/Status</th><th>Info</th><th>Hapus</th></tr></thead><tbody id="tbl-ex-list"></tbody></table>
                </div>
                <button onclick="publishExam()" class="btn btn-green" style="width:100%; margin-top:15px;"><i class="fa fa-share-nodes"></i> KIRIM KE SISWA (PUBLISH)</button>
            </div>
        </div>

        <div id="tab-g-nilai" class="tab-content">
            <div class="card">
                <h3>Input Nilai Siswa SD (Semua Mapel)</h3>
                <div class="f-row">
                    <div><label>Mapel</label>
                        <select id="gn-mapel" onchange="fetchSiswaNilai()">
                            <option>B. Indonesia</option><option>Matematika</option><option>IPA</option><option>IPS</option>
                            <option>PAI</option><option>PJOK</option><option>Seni Budaya</option><option>PKN</option>
                        </select>
                    </div>
                    <div><label>Kelas</label><select id="gn-kls" onchange="fetchSiswaNilai()"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
                </div>
                <div class="table-res">
                    <table><thead><tr><th>Siswa</th><th>Sumatif TP</th><th>STS</th><th>SAS</th></tr></thead><tbody id="tbl-gn-list"></tbody></table>
                </div>
                <button onclick="saveGrades()" class="btn btn-blue" style="width:100%; margin-top:20px;">SIMPAN SEMUA NILAI</button>
            </div>
        </div>

        <div id="tab-k-absen" class="tab-content">
            <div class="card">
                <h3>Monitoring Ceklok Kehadiran Guru (Real-time)</h3>
                <div class="table-res">
                    <table><thead><tr><th>Guru</th><th>Status</th><th>Jam</th><th>Lokasi</th><th>Tegur WA</th></tr></thead><tbody id="tbl-k-abs"></tbody></table>
                </div>
                <p style="font-size:0.7rem; color:gray; margin-top:10px;">*Guru yang belum ceklok lewat jam 07:30 dianggap terlambat.</p>
            </div>
        </div>

        <div id="tab-k-agenda" class="tab-content">
            <div class="card">
                <h3>Review & Persetujuan Agenda Harian Guru</h3>
                <div class="table-res">
                    <table><thead><tr><th>Tgl</th><th>Guru</th><th>CP/TP</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbl-k-rev-agenda"></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-k-modul" class="tab-content">
            <div class="card">
                <h3>Review Modul Ajar Mingguan</h3>
                <div class="table-res" id="tbl-k-rev-modul">
                    <table><thead><tr><th>Guru</th><th>Tema/Mapel</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tbl-k-rev-modul-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="tab-k-rekap" class="tab-content">
            <div class="card">
                <h3>Rekapitulasi Nilai Seluruh Kelas & Mapel</h3>
                <div class="f-row">
                    <select id="kr-kls" onchange="setRekapMapelByKelas()"><option value="1">Kelas 1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                    <select id="kr-mapel"></select>
                    <button onclick="renderRekap()" class="btn btn-blue">TAMPILKAN REKAP</button>
                </div>
                <div class="table-res">
                    <table id="rekap-print-area"><thead><tr><th>Nama</th><th>Kelas</th><th>Avg Nilai</th><th>Ket</th></tr></thead><tbody id="tbl-k-rekap-body"></tbody></table>
                </div>
                <button onclick="printRapor()" class="btn btn-warn" style="width:100%; margin-top:15px;"><i class="fa fa-print"></i> CETAK REKAPITULASI INI</button>
            </div>
        </div>

        <div id="tab-k-staf" class="tab-content">
            <div class="card">
                <h3>Kelola Data Staf & Guru Digital</h3>
                <div class="f-row">
                    <input type="text" id="ks-n" placeholder="Nama Lengkap & Gelar">
                    <input type="text" id="ks-nip" placeholder="NIP (Jika Ada)">
                    <input type="text" id="ks-u" placeholder="ID Akun Login">
                    <input type="text" id="ks-p" placeholder="Security PIN">
                    <input type="text" id="ks-wa" placeholder="No HP/WA (62...)">
                    <select id="ks-r">
<option value="GURU12">GURU KELAS 1-2</option>
<option value="GURU36">GURU KELAS 3-6</option>
<option value="PAI">GURU PAI</option>
<option value="PJOK">GURU PJOK</option>
<option value="KEPSEK">KEPALA SEKOLAH</option>
</select>
                </div>
                <button onclick="saveStaff()" class="btn btn-blue" style="width:100%;"><i class="fa fa-save"></i> TAMBAH/UPDATE STAF</button>
                <div class="table-res" style="margin-top:20px;">
                    <table><thead><tr><th>Nama</th><th>ID</th><th>PIN</th><th>WA</th><th>Aksi</th></tr></thead><tbody id="tbl-ks-list"></tbody></table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// --- CORE CONFIG ---
const CFG = { 
    apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ", 
    authDomain: "adminsitrasi-guru-de394.firebaseapp.com", 
    databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "adminsitrasi-guru-de394" 
};
firebase.initializeApp(CFG); const db = firebase.database();

let curU = null; 
let sch = null;
const S_COOR = { lat: -6.835, lng: 108.241 }; // Default Sekolah

// --- SYSTEM INITIAL ---
window.onload = () => {
    sch = JSON.parse(localStorage.getItem('ADM_V45_SUPREME'));
    if(!sch) showScreen('scr-setup');
    else { initPortal(); syncCloud(); }
};

function showScreen(id) {
    document.querySelectorAll('.u-screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

function initPortal() {
    showScreen('scr-login');
    document.getElementById('v-school-name').innerText = sch.nama;
    document.getElementById('v-school-npsn').innerText = "UNIT NPSN: " + sch.npsn;
    document.querySelectorAll('.v-sch-lbl').forEach(e => e.innerText = sch.nama);
}

function saveActivation() {
    const n = document.getElementById('reg-npsn').value; 
    const nm = document.getElementById('reg-nama').value;
    if(!n || !nm) return alert("Harap isi NPSN dan Nama Sekolah!");
    localStorage.setItem('ADM_V45_SUPREME', JSON.stringify({npsn:n, nama:nm}));
    location.reload();
}

// --- LOGIN & SYNC ---
function handleLogin() {
    const u = document.getElementById('log-u').value; 
    const p = document.getElementById('log-p').value;
    
    if(u === 'admin' && p === '12345') {
        proceedLogin({u:'admin', n:'Root Master', r:'KEPSEK', id:'ROOT'});
        return;
    }

    let found = null;
    for(let id in STAF_DATA) {
        if(STAF_DATA[id].u === u && STAF_DATA[id].p === p) found = STAF_DATA[id];
    }

    if(found) proceedLogin(found);
    else alert("Gagal Login. Periksa User & PIN!");
}

function proceedLogin(user) {
    curU = user;
    showScreen('main-ui');
    document.getElementById('sidebar').classList.remove('hidden');
    document.getElementById('p-name').innerText = user.n;
    document.getElementById('p-role').innerText = user.r;
    document.getElementById('p-avatar').innerText = user.n.charAt(0);
    document.getElementById('p-sign-name').innerText = user.n;

    if(user.r === 'KEPSEK') {
        document.getElementById('menu-area-kepsek').classList.remove('hidden');
        document.getElementById('k-stats-row').classList.remove('hidden');
    } else {
        document.getElementById('menu-area-guru').classList.remove('hidden');
    }
    switchTab('dashboard');
    setMapelByRole();
    if(curU.r === 'KEPSEK'){ setRekapMapelByKelas(); }
}

function syncCloud() {
    // Sync Staff
    db.ref('schools/'+sch.npsn+'/staff').on('value', s => {
        window.STAF_DATA = s.val() || {};
        renderStaffTable();
        renderAbsenMonitor();
        for(let id in STAF_DATA) if(STAF_DATA[id].r === 'KEPSEK') document.querySelectorAll('.v-kepsek-name').forEach(e => e.innerText = STAF_DATA[id].n);
    });
    // Sync Students
    db.ref('schools/'+sch.npsn+'/students').on('value', s => {
        window.SISWA_DATA = s.val() || {};
        renderStudentTable();
    });
    
    // Sync Modul untuk Kepsek (Realtime)
    db.ref('schools/'+sch.npsn+'/moduls').on('value', s => {
        const data = s.val() || {};
        if(!curU || curU.r !== 'KEPSEK') return;

        let h = '';
        for(let id in data) {
            let x = data[id];
            h += `<tr>
                <td>${x.n}</td>
                <td>${x.t} / ${x.m}</td>
                <td><span class="badge bg-${x.st==='OK'?'ok':'pending'}">${x.st}</span></td>
                <td><button onclick="approveModul('${id}')" class="btn btn-green btn-xs">Setuju</button></td>
            </tr>`;
        }

        document.getElementById('tbl-k-rev-modul-body').innerHTML = h;
    });

    // Sync Exams
    db.ref('schools/'+sch.npsn+'/exams').on('value', s => {
        const allEx = s.val() || {};
        let h = '';
        for(let id in allEx) {
            h += `<tr><td>${allEx[id].title}</td><td><span class="badge bg-ok">PUBLISHED</span></td><td>${allEx[id].guru}</td><td><button onclick="delExam('${id}')" class="btn btn-red btn-xs">Hapus</button></td></tr>`;
        }
        document.getElementById('tbl-ex-list').innerHTML = h;
    });

    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/agendas/'+d).on('value', s => {
        const ag = s.val() || {}; 
        let cnt = 0; for(let i in ag) if(ag[i].st==='PENDING') cnt++;
        document.getElementById('sk-agenda').innerText = cnt;
        renderReviewAgenda(ag);
    });
}

// --- GPS & ATTENDANCE ---
function openGps() { document.getElementById('m-gps').classList.remove('hidden'); checkLocation(); }
function closeGps() { document.getElementById('m-gps').classList.add('hidden'); }

function checkLocation() {
    if(!navigator.geolocation) return alert("GPS Tidak Didukung!");
    navigator.geolocation.getCurrentPosition(pos => {
        const dist = calcDistance(pos.coords.latitude, pos.coords.longitude, S_COOR.lat, S_COOR.lng);
        document.getElementById('t-dist').innerText = "Jarak Anda: " + dist.toFixed(0) + " meter dari Sekolah.";
        if(dist <= 210) {
            document.getElementById('b-ab-done').disabled = false;
            document.getElementById('b-ab-done').innerText = "KONFIRMASI HADIR SEKARANG";
        } else {
            document.getElementById('b-ab-done').innerText = "DILUAR RADIUS (MIN 200M)";
        }
    });
}

function execAbsen() {
    const d = new Date().toISOString().split('T')[0];
    const jam = new Date().toLocaleTimeString('id-id');
    db.ref('schools/'+sch.npsn+'/absen/'+d+'/'+curU.u).set({
        jam, guru: curU.n, st: 'HADIR', loc: 'Verified'
    }).then(() => { alert("Berhasil Ceklok!"); closeGps(); });
}

function renderAbsenMonitor() {
    if(!curU || curU.r !== 'KEPSEK') return;
    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/absen/'+d).on('value', s => {
        const data = s.val() || {};
        let h = ''; let count = 0;
        for(let id in STAF_DATA) {
            if(STAF_DATA[id].r === 'KEPSEK') continue;
            const r = data[id] || {st:'BELUM', jam:'-'};
            if(r.st==='HADIR') count++;
            const waMsg = "Halo " + STAF_DATA[id].n + ", kami melihat Anda belum melakukan Ceklok hari ini. Mohon segera lapor kehadiran.";
            h += `<tr><td>${STAF_DATA[id].n}</td><td><span class="badge bg-${r.st==='HADIR'?'ok':'pending'}">${r.st}</span></td><td>${r.jam}</td><td>${r.loc || '-'}</td>
            <td><button onclick="sendWA('${STAF_DATA[id].wa}', '${waMsg}')" class="btn btn-red btn-xs"><i class="fab fa-whatsapp"></i> Tegur</button></td></tr>`;
        }
        document.getElementById('tbl-k-abs').innerHTML = h;
        document.getElementById('sk-absen').innerText = count;
    });
}

// --- TEACHER: STUDENTS ---
function addStudent() {
    const n = document.getElementById('gs-nama').value;
    const u = document.getElementById('gs-user').value;
    const p = document.getElementById('gs-pass').value;
    const k = document.getElementById('gs-kls').value;
    if(!n || !u) return;
    db.ref('schools/'+sch.npsn+'/students/'+u).set({n, u, p, k});
    alert("Siswa Terdaftar!");
}

function renderStudentTable() {
    let h = '';
    for(let id in SISWA_DATA) {
        h += `<tr><td>${id}</td><td>${SISWA_DATA[id].n}</td><td>${SISWA_DATA[id].k}</td><td>${SISWA_DATA[id].p}</td>
        <td><button class="btn btn-red btn-xs" onclick="delSiswa('${id}')">X</button></td></tr>`;
    }
    document.getElementById('tbl-gs-list').innerHTML = h;
}
function delSiswa(id) { if(confirm('Hapus?')) db.ref('schools/'+sch.npsn+'/students/'+id).remove(); }

// --- TEACHER: ABSEN SISWA ---
function renderAbsenSiswa() {
    const kls = document.getElementById('ga-kls-sel').value;
    let h = '';
    for(let id in SISWA_DATA) {
        if(SISWA_DATA[id].k == kls) {
            h += `<tr><td>${SISWA_DATA[id].n}</td><td>${kls}</td>
            <td><select class="abs-sw-val" data-id="${id}"><option>H</option><option>S</option><option>I</option><option>A</option></select></td></tr>`;
        }
    }
    document.getElementById('tbl-ga-list').innerHTML = h;
}


function saveAbsenSiswa() {
    const kls = document.getElementById('ga-kls-sel').value;
    const d = new Date().toISOString().split('T')[0];

    let updates = {};

    document.querySelectorAll('.abs-sw-val').forEach(sel => {
        updates[sel.dataset.id] = sel.value;
    });

    db.ref('schools/'+sch.npsn+'/absen_siswa/'+d+'/'+kls).set({
        guru: curU.n,
        data: updates
    }).then(() => alert("Absensi Siswa Tersimpan!"));
}

// --- TEACHER: AGENDA & MODUL ---
function submitAgenda() {
    const cp = document.getElementById('gag-cp').value; const tp = document.getElementById('gag-tp').value;
    const mat = document.getElementById('gag-mat').value;
    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/agendas/'+d+'/'+curU.u).set({
        n: curU.n, cp, tp, mat, st: 'PENDING', tgl: d
    }).then(() => alert("Agenda Terkirim!"));
}

function submitModul() {
    const t = document.getElementById('gm-title').value; const m = document.getElementById('gm-mapel').value;
    const c = document.getElementById('gm-logic').value;
    db.ref('schools/'+sch.npsn+'/moduls/'+curU.u).set({ t, m, c, n: curU.n, st: 'PENDING' });
    alert("Modul Berhasil Dikirim!");
}


function approveModul(id) {
    db.ref('schools/'+sch.npsn+'/moduls/'+id+'/st').set('OK');
}

// --- TEACHER: EXAM ---
let tempEx = [];
function toggleExType() {
    const ty = document.getElementById('ex-type').value;
    document.getElementById('ex-pg-ops').className = (ty === 'ES' ? 'hidden' : '');
}
function saveQuestion() {
    const q = document.getElementById('ex-q').value;
    const ty = document.getElementById('ex-type').value;
    const ans = document.getElementById('ex-ans').value;
    if(!q) return;
    const itm = { q, ty, ans };
    if(ty === 'PG') itm.opts = [document.getElementById('ex-oa').value, document.getElementById('ex-ob').value, document.getElementById('ex-oc').value, document.getElementById('ex-od').value];
    tempEx.push(itm);
    renderExTemp();
}
function renderExTemp() {
    let h = ''; tempEx.forEach((x, i) => { h += `<tr><td>${x.q}</td><td>${x.ty}</td><td>${x.ans}</td><td><button onclick="tempEx.splice(${i},1);renderExTemp()">X</button></td></tr>`; });
    // Tampilkan list soal sementara sebelum dipublish
    document.getElementById('tbl-ex-list').innerHTML = h;
}
function publishExam() {
    const title = document.getElementById('ex-header').value;
    if(!title || tempEx.length === 0) return alert("Isi Judul & Soal!");
    db.ref('schools/'+sch.npsn+'/exams/'+Date.now()).set({ title, q: tempEx, guru: curU.n });
    alert("Ujian Dipublish ke Siswa!"); tempEx = []; renderExTemp();
}
function delExam(id) { if(confirm('Hapus Ujian?')) db.ref('schools/'+sch.npsn+'/exams/'+id).remove(); }

// --- TEACHER: NILAI SD ---
function fetchSiswaNilai() {
    const kls = document.getElementById('gn-kls').value;
    const mapel = document.getElementById('gn-mapel').value;
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).once('value', snapshot => {
        const savedData = snapshot.val() || {};
        let h = '';
        for(let id in SISWA_DATA) {
            if(SISWA_DATA[id].k == kls) {
                const val = savedData[id] || {tp:0, sts:0, sas:0};
                h += `<tr><td>${SISWA_DATA[id].n}</td>
                    <td><input type="number" class="ni-tp" data-id="${id}" value="${val.tp}" style="width:70px"></td>
                    <td><input type="number" class="ni-sts" data-id="${id}" value="${val.sts}" style="width:70px"></td>
                    <td><input type="number" class="ni-sas" data-id="${id}" value="${val.sas}" style="width:70px"></td></tr>`;
            }
        }
        document.getElementById('tbl-gn-list').innerHTML = h;
    });
}
function saveGrades() {
    const kls = document.getElementById('gn-kls').value;
    const mapel = document.getElementById('gn-mapel').value;
    const updates = {};
    document.querySelectorAll('#tbl-gn-list tr').forEach(row => {
        const tpInp = row.querySelector('.ni-tp');
        const id = tpInp.dataset.id;
        updates[id] = {
            tp: tpInp.value,
            sts: row.querySelector('.ni-sts').value,
            sas: row.querySelector('.ni-sas').value
        };
    });
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).update(updates).then(() => alert("Nilai Tersinkron!"));
}

// --- KEPSEK: REVIEW & REKAP ---
function renderReviewAgenda(data) {
    if(!curU || curU.r !== 'KEPSEK') return;
    let h = '';
    for(let uid in data) {
        let x = data[uid];
        h += `<tr><td>${x.tgl}</td><td>${x.n}</td><td>${x.cp}/${x.tp}</td><td><span class="badge bg-${x.st==='OK'?'ok':'pending'}">${x.st}</span></td>
        <td><button onclick="approveAgenda('${uid}')" class="btn btn-green btn-xs">Setuju</button></td></tr>`;
    }
    document.getElementById('tbl-k-rev-agenda').innerHTML = h;
}
function approveAgenda(uid) {
    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/agendas/'+d+'/'+uid+'/st').set('OK');
}

function renderRekap() {
    const kls = document.getElementById('kr-kls').value;
    const mapel = document.getElementById('kr-mapel').value;
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).once('value', s => {
        const data = s.val() || {};
        let h = '';
        for(let id in SISWA_DATA) {
            if(SISWA_DATA[id].k == kls) {
                const n = data[id] || {tp:0, sts:0, sas:0};
                const avg = (parseFloat(n.tp) + parseFloat(n.sts) + parseFloat(n.sas)) / 3;
                h += `<tr><td>${SISWA_DATA[id].n}</td><td>${kls}</td><td>${avg.toFixed(2)}</td>
                    <td><span class="badge ${avg >= 75 ? 'bg-ok' : 'bg-pending'}">${avg >= 75 ? 'TUNTAS' : 'REMEDIAL'}</span></td></tr>`;
            }
        }
        document.getElementById('tbl-k-rekap-body').innerHTML = h;
    });
}

function printRapor() {
    const kls = document.getElementById('kr-kls').value;
    const mapel = document.getElementById('kr-mapel').value;
    const content = document.getElementById('rekap-print-area').outerHTML;
    const printWin = window.open('', '_blank');
    printWin.document.write(`<html><head><title>Rapor ${sch.nama}</title><style>body{font-family:sans-serif;padding:40px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:12px;text-align:left}th{background:#f4f4f4}.kop{text-align:center;border-bottom:3px solid #000;margin-bottom:20px}.sig{display:flex;justify-content:space-between;margin-top:50px}
/* =========================
   MOBILE RESPONSIVE FIX
========================= */
@media (max-width: 768px) {

    body {
        flex-direction: column;
    }

    .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        width: 260px;
        height: 100%;
        transition: 0.3s ease;
    }

    .sidebar.show {
        left: 0;
    }

    .main {
        margin-left: 0 !important;
        width: 100% !important;
    }

    .topbar {
        height: 65px;
        padding: 0 15px;
    }

    .container {
        padding: 15px;
    }

    .card {
        padding: 18px;
        border-radius: 16px;
    }

    .f-row {
        grid-template-columns: 1fr !important;
    }

    .table-res {
        overflow-x: auto;
    }

    table {
        min-width: 600px;
    }

    #d-clock-txt {
        font-size: 2.5rem !important;
        letter-spacing: -1px !important;
    }

    .btn {
        font-size: 0.8rem;
        padding: 12px;
    }

    #p-avatar {
        width: 38px;
        height: 38px;
        font-size: 1rem;
    }
}

</style></head><body>
        <div class="kop"><h2>${sch.nama}</h2><p>Rekapitulasi Nilai Mapel: ${mapel} | Kelas: ${kls}</p></div>
        ${content}
        <div class="sig"><div>Mengetahui,<br>Kepala Sekolah<br><br><br><b>${document.querySelector('.v-kepsek-name').innerText}</b></div><div>Majalengka, ${new Date().toLocaleDateString('id-id')}<br>Guru Kelas<br><br><br><b>${curU.n}</b></div></div>
        <script>window.print();<\/script></body></html>`);
    printWin.document.close();
}

// --- KEPSEK: DATA STAF ---
function saveStaff() {
    const id = document.getElementById('ks-u').value;
    const dat = {
        u: id, n: document.getElementById('ks-n').value, p: document.getElementById('ks-p').value,
        nip: document.getElementById('ks-nip').value, wa: document.getElementById('ks-wa').value, r: document.getElementById('ks-r').value
    };
    db.ref('schools/'+sch.npsn+'/staff/'+id).set(dat);
    alert("Data Staf Disimpan!");
}
function renderStaffTable() {
    let h = ''; for(let id in STAF_DATA) { let x = STAF_DATA[id];
        h += `<tr><td>${x.n}</td><td>${x.u}</td><td>${x.p}</td><td>${x.wa}</td><td><button class="btn btn-red btn-xs" onclick="delStaf('${id}')">X</button></td></tr>`;
    }
    document.getElementById('tbl-ks-list').innerHTML = h;
}
function delStaf(id) { if(confirm('Hapus?')) db.ref('schools/'+sch.npsn+'/staff/'+id).remove(); }

// --- UTILS ---


function setRekapMapelByKelas() {

    const kls = document.getElementById('kr-kls').value;
    const sel = document.getElementById('kr-mapel');
    if(!sel) return;

    sel.innerHTML = '';

    let mapels = [];

    if(kls == 1 || kls == 2) {
        mapels = ["Matematika","B. Indonesia","Pendidikan Pancasila","Bahasa Sunda","Seni Budaya"];
    }

    if(kls >= 3 && kls <= 6) {
        mapels = ["Matematika","B. Indonesia","Pendidikan Pancasila","Bahasa Sunda","Seni Budaya","IPAS","Bahasa Inggris"];
    }

    mapels.push("PAI");
    mapels.push("PJOK");

    mapels.forEach(m => {
        sel.innerHTML += `<option>${m}</option>`;
    });
}

function setMapelByRole() {

    const sel = document.getElementById('gn-mapel');
    if(!sel || !curU) return;

    sel.innerHTML = '';

    let mapels = [];

    if(curU.r === 'GURU12') {
        mapels = ["Matematika","B. Indonesia","Pendidikan Pancasila","Bahasa Sunda","Seni Budaya"];
    }

    if(curU.r === 'GURU36') {
        mapels = ["Matematika","B. Indonesia","Pendidikan Pancasila","Bahasa Sunda","Seni Budaya","IPAS","Bahasa Inggris"];
    }

    if(curU.r === 'PAI') {
        mapels = ["PAI"];
    }

    if(curU.r === 'PJOK') {
        mapels = ["PJOK"];
    }

    if(curU.r === 'KEPSEK') {
        mapels = ["Matematika","B. Indonesia","Pendidikan Pancasila","Bahasa Sunda","Seni Budaya","IPAS","Bahasa Inggris","PAI","PJOK"];
    }

    mapels.forEach(m => {
        sel.innerHTML += `<option>${m}</option>`;
    });
}

function switchTab(id) {

    if(id.startsWith('k-') && curU.r !== 'KEPSEK') {
        alert("Akses Ditolak!");
        return;
    }
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('v-title-label').innerText = id.replace('g-','').replace('k-','').toUpperCase();
    if(id === 'g-nilai') fetchSiswaNilai();
}
function sendWA(num, msg) { window.open("https://wa.me/"+num+"?text="+encodeURIComponent(msg), '_blank'); }
function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; const p1 = lat1 * Math.PI/180; const p2 = lat2 * Math.PI/180;
    const dp = (lat2-lat1) * Math.PI/180; const dl = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
setInterval(() => {
    const d = new Date();
    document.getElementById('d-clock-txt').innerText = d.toLocaleTimeString('id-id');
    document.getElementById('d-date-txt').innerText = d.toLocaleDateString('id-id', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('clk').innerText = d.toLocaleTimeString('id-id');
    document.querySelectorAll('.global-text-date').forEach(e => e.innerText = d.toLocaleDateString('id-id'));
    document.querySelectorAll('.global-date-inp').forEach(e => e.value = d.toLocaleDateString('id-id'));
}, 1000);

function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('show');
}

function checkMobile() {
    if (window.innerWidth <= 768) {
        document.getElementById('mobileMenuBtn').style.display = "block";
    } else {
        document.getElementById('mobileMenuBtn').style.display = "none";
    }
}

window.addEventListener('resize', checkMobile);
window.addEventListener('load', checkMobile);

</script>
</body>
</html>

