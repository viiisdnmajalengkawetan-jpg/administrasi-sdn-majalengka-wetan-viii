<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #1e3a8a; --accent: #3b82f6; --success: #10b981; 
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: var(--dark); display: flex; flex-direction: column; min-height: 100vh; }
        .navbar { background: var(--primary); color: white; padding: 25px; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; border-bottom: 4px solid var(--accent); }
        .container { padding: 30px; max-width: 1300px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: var(--white); padding: 35px 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .menu-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .menu-card .icon { font-size: 50px; margin-bottom: 15px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; border-top: 5px solid var(--accent); }
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn-blue { background: var(--accent); } .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-orange { background: var(--warning); } .btn-dark { background: var(--dark); }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .field { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
        label { font-size: 11px; font-weight: 800; margin-bottom: 5px; color: #64748b; }
        input, select, textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .table-res { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 12px; color: var(--primary); font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .hidden-form { display: none; margin-top: 20px; padding: 15px; border: 2px dashed #3b82f6; border-radius: 12px; }
        .history-container { display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #cbd5e1; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        
        /* CSS Tambahan untuk Ujian HP Friendly */
        .opt-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .opt-btn:active { background: #e0f2fe; border-color: var(--accent); }

        #modalCeklok {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            z-index: 2000; text-align: center; width: 320px;
        }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }

        @media print {
            .navbar, .btn, .btn-group, .form-group, .dashboard-grid, .no-print, #back-area, .btn-orange, .btn-green, .semester-switcher { display: none !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            #print-footer { display: block !important; margin-top: 40px; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body { background: white; }
            table { font-size: 10px; width: 100%; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlayCeklok"></div>
<div id="modalCeklok">
    <span style="font-size: 50px;">ğŸ“</span>
    <h4>PRESENSI GURU</h4>
    <p id="statusLokasi" style="font-size: 12px; color: #64748b;">Mendeteksi lokasi Anda...</p>
    <div id="infoWaktu" style="margin-bottom: 15px; font-weight: bold; color: var(--primary);"></div>
    <button id="btnKirimAbsen" disabled onclick="submitCeklok()" class="btn btn-green" style="width: 100%; justify-content: center; padding: 15px;">CEKLOK SEKARANG</button>
    <button onclick="submitIzinSakit()" class="btn btn-orange" style="width: 100%; justify-content: center; padding: 10px; margin-top: 5px;">LAPOR IZIN / SAKIT</button>
    <button onclick="closeModalCeklok()" style="margin-top: 15px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold;">TUTUP</button>
</div>

<div id="print-header" style="display:none;">
    <h1 id="pSekolah">SD NEGERI MAJALENGKA WETAN VIII</h1>
    <h2 id="pTitle">LAPORAN ADMINISTRASI</h2>
    <hr>
</div>

<div class="navbar">
    <h2 id="main-title">ğŸš€ ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</h2>
</div>

<div class="container">
    <div id="tab-login" class="tab-content" style="display: block;">
        <h3 style="text-align:center">Silakan Pilih Akun:</h3>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="selectRole('GK1', 'ğŸ« KELAS 1', 'SITI ROKAYAH,S.Pd')"><span class="icon">ğŸ«</span><h3>KELAS 1</h3><p>SITI ROKAYAH,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK2', 'ğŸ« KELAS 2', 'VIKA NURATIKA,S.Pd')"><span class="icon">ğŸ«</span><h3>KELAS 2</h3><p>VIKA NURATIKA,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK3', 'ğŸ« KELAS 3', 'RISKA WIDIA ROSANA,S.PD')"><span class="icon">ğŸ«</span><h3>KELAS 3</h3><p>RISKA WIDIA ROSANA,S.PD</p></div>
            <div class="menu-card" onclick="selectRole('GK4', 'ğŸ« KELAS 4', 'DEDE YUDIASTUTI,S.Pd')"><span class="icon">ğŸ«</span><h3>KELAS 4</h3><p>DEDE YUDIASTUTI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK5', 'ğŸ« KELAS 5', 'SILVYRA RISMAWATI,S.Pd.SD')"><span class="icon">ğŸ«</span><h3>KELAS 5</h3><p>SILVYRA RISMAWATI,S.Pd.SD</p></div>
            <div class="menu-card" onclick="selectRole('GK6', 'ğŸ« KELAS 6', 'ESIH IMAWATI,S.Pd')"><span class="icon">ğŸ«</span><h3>KELAS 6</h3><p>ESIH IMAWATI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PJOK', 'ğŸƒâ€â™‚ï¸ GURU PJOK', 'INDRA SETIAWAN,S.Pd')"><span class="icon">ğŸƒâ€â™‚ï¸</span><h3>GURU PJOK</h3><p>INDRA SETIAWAN,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PAI', 'ğŸ•Œ GURU PAI', 'YATI NOVIYATI,S.Pd.I')"><span class="icon">ğŸ•Œ</span><h3>GURU PAI</h3><p>YATI NOVIYATI,S.Pd.I</p></div>
            <div class="menu-card" onclick="selectRole('KEPSEK', 'ğŸ‘¨â€ğŸ’¼ KEPALA SEKOLAH', 'KARYADI, S.Pd')" style="background: #fdf2f2;"><span class="icon">ğŸ‘¨â€ğŸ’¼</span><h3>KEPALA SEKOLAH</h3><p>KARYADI, S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('ADMIN', 'ğŸ› ï¸ ADMINISTRATOR', 'SISTEM ADMIN')" style="background: #eff6ff;"><span class="icon">ğŸ› ï¸</span><h3>ADMIN PANEL</h3><p>Kelola Data Massal</p></div>
            <div class="menu-card" onclick="loginSiswa()" style="background: #f0fdf4;"><span class="icon">ğŸ“</span><h3>SISWA</h3><p>Kerjakan Tugas/Ujian</p></div>
        </div>
    </div>

    <div id="back-area" style="display: none; margin-bottom: 20px;">
        <button class="btn btn-dark" onclick="switchTab('tab-home')">ğŸ  MENU UTAMA</button>
        <button class="btn btn-red" onclick="location.reload()">ğŸšª GANTI AKUN</button>
    </div>

    <div id="tab-home" class="tab-content">
        <div class="dashboard-grid" id="guru-menu">
            <div class="menu-card" onclick="openModalCeklok()" style="background: #f0fdf4; border: 2px solid var(--success);"><span class="icon">ğŸ“</span><h4>CEKLOK ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">âš™ï¸</span><h4>IDENTITAS</h4></div>
            <div class="menu-card" onclick="switchTab('tab-siswa')"><span class="icon">ğŸ‘¥</span><h4>SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-master')"><span class="icon">ğŸ¯</span><h4>CP, TP, ATP</h4></div>
            <div class="menu-card" onclick="switchTab('tab-modul')"><span class="icon">ğŸ“–</span><h4>MODUL AJAR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-agenda')"><span class="icon">ğŸ“</span><h4>AGENDA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-absensi')"><span class="icon">âœ…</span><h4>ABSENSI SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-rekap-absen')"><span class="icon">ğŸ“Š</span><h4>REKAP ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-raport')"><span class="icon">ğŸ“œ</span><h4>RAPOR & NILAI</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kegiatan')"><span class="icon">ğŸ†</span><h4>EKSKUL/KOKUL</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kosp')"><span class="icon">ğŸ“‚</span><h4>KOSP & LINK</h4></div>
        </div>
        <div class="dashboard-grid" id="kepsek-menu" style="display: none;">
            <div class="menu-card" onclick="renderMonitorAgenda()"><span class="icon">ğŸ“‹</span><h4>PERSETUJUAN AGENDA</h4></div>
            <div class="menu-card" onclick="renderMonitorKegiatan()"><span class="icon">ğŸ†</span><h4>PERSETUJUAN KEGIATAN</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenGuru()"><span class="icon">ğŸ‘¨â€ğŸ«</span><h4>PRESENSI GURU</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenSiswa()"><span class="icon">ğŸ“Š</span><h4>MONITOR ABSEN SISWA</h4></div>
            <div class="menu-card" onclick="renderMonitorLinkGuru()"><span class="icon">ğŸ“‚</span><h4>DOKUMEN & CP/TP</h4></div>
            <div class="menu-card" onclick="renderMonitorNilai()"><span class="icon">ğŸ“œ</span><h4>MONITOR NILAI & RAPOR</h4></div>
        </div>
        <div class="dashboard-grid" id="admin-menu" style="display: none;">
            <div class="menu-card" onclick="downloadTemplateSiswa()"><span class="icon">ğŸ“¥</span><h4>TEMP. SISWA</h4></div>
            <div class="menu-card" onclick="document.getElementById('impSiswa').click()"><span class="icon">ğŸ“¤</span><h4>IMP. SISWA</h4></div>
            <div class="menu-card" onclick="downloadTemplateSoal()"><span class="icon">ğŸ“</span><h4>TEMP. SOAL</h4></div>
            <div class="menu-card" onclick="document.getElementById('impSoal').click()"><span class="icon">ğŸš€</span><h4>IMP. SOAL</h4></div>
            <div class="menu-card" onclick="pushDataToKepsek()"><span class="icon">ğŸ”„</span><h4>SINKRON KEPSEK</h4></div>
            <input type="file" id="impSiswa" hidden onchange="handleImportSiswa(this)">
            <input type="file" id="impSoal" hidden onchange="handleImportSoal(this)">
        </div>
    </div>

    <div id="tab-siswa-home" class="tab-content">
        <div class="card">
            <h3 id="sis-nama">Halo, Siswa</h3>
            <p id="sis-kls">Kelas: -</p>
            <div id="list-tugas" class="dashboard-grid"></div>
        </div>
    </div>

    <div id="tab-kerjakan-soal" class="tab-content">
        <div class="card" style="max-width: 600px; margin: auto;">
            <h4 id="ujian-title">Mata Pelajaran</h4>
            <div id="q-area" style="font-size: 18px; margin: 20px 0; font-weight: bold;"></div>
            <div id="a-area"></div>
            <p id="q-progress" style="text-align: center; color: #64748b;"></p>
        </div>
    </div>

    <div id="tab-setup" class="tab-content">
        <div class="card">
            <h3>âš™ï¸ Identitas & Foto Profil</h3>
            <div class="form-group"><div class="field"><label>Nama Sekolah</label><input type="text" id="sSekolah"></div></div>
            <div class="form-group">
                <div class="field"><label>Nama Pengguna</label><input type="text" id="sGuru"></div>
                <div class="field"><label>NIP Pengguna</label><input type="text" id="snipGuru"></div>
            </div>
            <button class="btn btn-blue" onclick="saveSetup()">ğŸ’¾ SIMPAN</button>
        </div>
    </div>

    <div id="tab-siswa" class="tab-content">
        <div class="card">
            <h3>ğŸ‘¥ Data Siswa</h3>
            <div class="table-res"><table><thead><tr><th>NO</th><th>NISN</th><th>NIS</th><th>NAMA</th><th>AKSI</th></tr></thead><tbody id="bodySiswa"></tbody></table></div>
        </div>
    </div>

    <div id="tab-master" class="tab-content">
        <div class="card">
            <h3>ğŸ¯ Master CP, TP, ATP</h3>
            <div class="form-group">
                <div class="field"><label>Pilih Kelas</label><select id="masterKls" onchange="updateMapelFilter('masterMapel', this.value); renderSemuaMaster();"></select></div>
                <div class="field"><label>Pilih Mata Pelajaran</label><select id="masterMapel" onchange="renderSemuaMaster()"></select></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="showMasterForm('formCP')">â• CP</button>
                <button class="btn btn-green" onclick="showMasterForm('formTP')">â• TP</button>
            </div>
            <div id="formCP" class="hidden-form">
                <div class="form-group"><input type="text" id="cpElemen" placeholder="Elemen"><input type="text" id="cpIsi" placeholder="Isi CP"><button class="btn btn-blue" onclick="saveMaster('CP')">SIMPAN</button></div>
            </div>
            <div id="formTP" class="hidden-form">
                <div class="form-group"><input type="text" id="tpKode" placeholder="Kode"><input type="text" id="tpIsi" placeholder="Isi TP"><button class="btn btn-green" onclick="saveMaster('TP')">SIMPAN</button></div>
            </div>
            <div class="table-res"><table><thead><tr><th>INFO</th><th>ISI</th><th>AKSI</th></tr></thead><tbody id="bodyCPNew"></tbody></table></div>
        </div>
    </div>

    <div id="tab-raport" class="tab-content"><div class="card"><h3>ğŸ“œ Input Nilai & Rapor</h3><div id="bodyRaport"></div></div></div>
    <div id="tab-agenda" class="tab-content"><div class="card"><h3>ğŸ“ Agenda Harian</h3><tbody id="bodyAgenda"></tbody></div></div>
    <div id="tab-absensi" class="tab-content"><div class="card"><h3>âœ… Absensi</h3><tbody id="bodyAbsensi"></tbody></div></div>
    <div id="tab-kegiatan" class="tab-content"><div class="card"><h3>ğŸ† Kegiatan</h3><tbody id="bodyKegiatan"></tbody></div></div>
    <div id="tab-kosp" class="tab-content"><div class="card"><h3>ğŸ“‚ Link KOSP</h3><tbody id="bodyKosp"></tbody></div></div>
    <div id="tab-kepsek" class="tab-content"><div class="card"><h3 id="monitor-title">Monitor</h3><div id="area-monitor-kepsek"></div></div></div>

</div>

<script>
    // --- KONFIGURASI FIREBASE (ASLI) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ",
        authDomain: "adminsitrasi-guru-de394.firebaseapp.com",
        databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "adminsitrasi-guru-de394",
        storageBucket: "adminsitrasi-guru-de394.firebasestorage.app",
        messagingSenderId: "1056567544540",
        appId: "1:1056567544540:web:d612d0c9eccb758c87c219"
    };
    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    let currentRole = '';
    let db = { cfg:{}, siswa:[], cp:[], agenda:[], absensi:{}, nilai:{}, modul:[], kegiatan:[], kosp:[] };
    let sisLogin = null;
    let bankSoal = [];
    let curSoalIdx = 0;
    let curSoalList = [];
    let curJawaban = [];

    const allGurus = [
        {id: 'GK1', nama: 'SITI ROKAYAH,S.Pd', pw: '12345'},
        {id: 'GK2', nama: 'VIKA NURATIKA,S.Pd', pw: '12345'},
        {id: 'GK3', nama: 'RISKA WIDIA ROSANA,S.PD', pw: '12345'},
        {id: 'GK4', nama: 'DEDE YUDIASTUTI,S.Pd', pw: '12345'},
        {id: 'GK5', nama: 'SILVYRA RISMAWATI,S.Pd.SD', pw: '12345'},
        {id: 'GK6', nama: 'ESIH IMAWATI,S.Pd', pw: '12345'},
        {id: 'PJOK', nama: 'INDRA SETIAWAN,S.Pd', pw: '12345'},
        {id: 'PAI', nama: 'YATI NOVIYATI,S.Pd.I', pw: '12345'},
        {id: 'KEPSEK', nama: 'KARYADI, S.Pd', pw: 'admin2026'},
        {id: 'ADMIN', nama: 'SISTEM ADMIN', pw: 'admin8'}
    ];

    // --- FUNGSI CORE ---

    function selectRole(role, title, name) {
        const guruData = allGurus.find(g => g.id === role);
        const inputPw = prompt(`Ketik Password:`);
        if (inputPw !== guruData.pw) { alert("Salah!"); return; }

        currentRole = role;
        document.getElementById('main-title').innerText = title;
        
        if(role === 'ADMIN') {
            document.getElementById('guru-menu').style.display = 'none';
            document.getElementById('kepsek-menu').style.display = 'none';
            document.getElementById('admin-menu').style.display = 'grid';
        } else if(role === 'KEPSEK') {
            document.getElementById('guru-menu').style.display = 'none';
            document.getElementById('kepsek-menu').style.display = 'grid';
            document.getElementById('admin-menu').style.display = 'none';
        } else {
            document.getElementById('guru-menu').style.display = 'grid';
            document.getElementById('kepsek-menu').style.display = 'none';
            document.getElementById('admin-menu').style.display = 'none';
            filterKelasBerdasarkanRole(role);
        }
        loadDB(name);
        switchTab('tab-home');
    }

    function loadDB(name) {
        rtdb.ref('sekolah_wetan/' + currentRole.toLowerCase()).on('value', (snap) => {
            db = snap.val() || { cfg:{guru:name}, siswa:[], cp:[], agenda:[] };
            renderSiswa();
            renderSemuaMaster();
        });
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('back-area').style.display = (id === 'tab-login' ? 'none' : 'block');
    }

    // --- FITUR ADMIN (MASSAL) ---

    function downloadTemplateSiswa() {
        const data = [["NISN", "NIS", "NAMA", "KELAS"]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Siswa");
        XLSX.writeFile(wb, "Template_Siswa.xlsx");
    }

    function handleImportSiswa(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            rows.forEach(r => {
                const target = 'gk' + r.KELAS;
                rtdb.ref(`sekolah_wetan/${target}/siswa`).push({nisn:r.NISN, nis:r.NIS, nama:r.NAMA});
            });
            alert("Siswa berhasil didistribusikan ke Guru Kelas!");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function downloadTemplateSoal() {
        const data = [["MAPEL", "KELAS", "PERTANYAAN", "A", "B", "C", "D", "KUNCI"]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Soal");
        XLSX.writeFile(wb, "Template_Soal.xlsx");
    }

    function handleImportSoal(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            rtdb.ref('bank_soal').set(rows).then(() => alert("Bank Soal Berhasil Diperbarui!"));
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function pushDataToKepsek() {
        rtdb.ref('sekolah_wetan').once('value', snap => {
            rtdb.ref('pusat_kepsek').set(snap.val()).then(() => alert("Data Terkirim ke Kepsek!"));
        });
    }

    // --- FITUR SISWA (HP FRIENDLY) ---

    function loginSiswa() {
        const nisn = prompt("Masukkan NISN:");
        if(!nisn) return;
        rtdb.ref('sekolah_wetan').once('value', snap => {
            const all = snap.val();
            let found = false;
            for(let key in all) {
                if(all[key].siswa) {
                    const list = Object.values(all[key].siswa);
                    const s = list.find(x => x.nisn == nisn);
                    if(s) {
                        sisLogin = {...s, roleGuru: key, kls: key.replace('gk','')};
                        found = true; break;
                    }
                }
            }
            if(found) showSiswaMenu(); else alert("NISN Tidak Terdaftar!");
        });
    }

    function showSiswaMenu() {
        switchTab('tab-siswa-home');
        document.getElementById('sis-nama').innerText = "Halo, " + sisLogin.nama;
        document.getElementById('sis-kls').innerText = "Kelas: " + sisLogin.kls;
        
        rtdb.ref('bank_soal').once('value', snap => {
            const all = snap.val() || [];
            const mySoal = all.filter(x => x.KELAS == sisLogin.kls);
            const uniqueMapel = [...new Set(mySoal.map(s => s.MAPEL))];
            
            let html = "";
            uniqueMapel.forEach(m => {
                html += `<div class="menu-card" onclick="mulaiUjian('${m}')"><span>ğŸ“š</span><h4>${m}</h4></div>`;
            });
            document.getElementById('list-tugas').innerHTML = html || "<p>Belum ada tugas.</p>";
        });
    }

    function mulaiUjian(mapel) {
        rtdb.ref('bank_soal').once('value', snap => {
            const all = snap.val() || [];
            curSoalList = all.filter(x => x.KELAS == sisLogin.kls && x.MAPEL == mapel);
            curSoalIdx = 0; curJawaban = [];
            document.getElementById('ujian-title').innerText = mapel;
            switchTab('tab-kerjakan-soal');
            renderUjian();
        });
    }

    function renderUjian() {
        const s = curSoalList[curSoalIdx];
        document.getElementById('q-progress').innerText = `Soal ${curSoalIdx+1} / ${curSoalList.length}`;
        document.getElementById('q-area').innerText = s.PERTANYAAN;
        let html = "";
        ['A','B','C','D'].forEach(o => {
            html += `<button class="opt-btn" onclick="pilihJawaban('${o}')">${o}. ${s[o]}</button>`;
        });
        document.getElementById('a-area').innerHTML = html;
    }

    function pilihJawaban(pil) {
        if(pil === curSoalList[curSoalIdx].KUNCI) curJawaban.push(1); else curJawaban.push(0);
        if(curSoalIdx < curSoalList.length - 1) {
            curSoalIdx++; renderUjian();
        } else {
            const skor = Math.round((curJawaban.reduce((a,b)=>a+b,0) / curSoalList.length) * 100);
            const mapel = curSoalList[0].MAPEL;
            // Kirim Nilai ke Guru (PAI/PJOK/GK)
            rtdb.ref(`sekolah_wetan/${sisLogin.roleGuru}/nilai/${sisLogin.nisn}/${mapel}`).set({
                skor: skor, tgl: new Date().toLocaleDateString()
            }).then(() => {
                alert("Selesai! Nilai Anda: " + skor);
                showSiswaMenu();
            });
        }
    }

    // --- FUNGSI GURU (KODE ASLI ANDA) ---
    function filterKelasBerdasarkanRole(role) {
        const ids = ['masterKls','swKls'];
        ids.forEach(id => {
            const sel = document.getElementById(id); if(!sel) return;
            if(role.startsWith('GK')) {
                const k = role.replace('GK','');
                sel.innerHTML = `<option value="${k}">Kelas ${k}</option>`;
            } else {
                sel.innerHTML = `<option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>`;
            }
        });
    }

    function renderSiswa() {
        const body = document.getElementById('bodySiswa');
        if(!body || !db.siswa) return;
        const list = Object.values(db.siswa);
        body.innerHTML = list.map((s,i) => `<tr><td>${i+1}</td><td>${s.nisn}</td><td>${s.nis}</td><td>${s.nama}</td><td>-</td></tr>`).join('');
    }

    function saveMaster(tipe) {
        if(!db.cp) db.cp = [];
        const item = tipe === 'CP' ? 
            {tipe:'CP', kls:document.getElementById('masterKls').value, mapel:document.getElementById('masterMapel').value, elemen:document.getElementById('cpElemen').value, isi:document.getElementById('cpIsi').value} :
            {tipe:'TP', kls:document.getElementById('masterKls').value, mapel:document.getElementById('masterMapel').value, kode:document.getElementById('tpKode').value, isi:document.getElementById('tpIsi').value};
        db.cp.push(item);
        rtdb.ref('sekolah_wetan/'+currentRole.toLowerCase()).set(db);
    }

    function renderSemuaMaster() {
        const body = document.getElementById('bodyCPNew'); if(!body) return;
        const list = (db.cp || []).filter(x => x.kls == document.getElementById('masterKls').value && x.mapel == document.getElementById('masterMapel').value);
        body.innerHTML = list.map(x => `<tr><td>${x.tipe} ${x.elemen || x.kode}</td><td>${x.isi}</td><td>-</td></tr>`).join('');
    }

    function updateMapelFilter(id, kls) {
        const sel = document.getElementById(id); if(!sel) return;
        const list = (kls < 3) ? ["B.Indonesia","Matematika","P.Pancasila","PAI","PJOK"] : ["B.Indonesia","Matematika","IPAS","P.Pancasila","PAI","PJOK"];
        sel.innerHTML = list.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function showMasterForm(id) {
        document.getElementById('formCP').style.display = 'none';
        document.getElementById('formTP').style.display = 'none';
        document.getElementById(id).style.display = 'block';
    }

</script>
</body>
</html>
