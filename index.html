<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ADMINISTRASI GURU v45 - CP KURIKULUM MERDEKA</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary: #0f172a; --accent: #2563eb; --sidebar: #1e293b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --white: #ffffff; --bg: #f8fafc; --shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); display: flex; color: var(--primary); }
        
        .u-screen { position: fixed; inset: 0; background: var(--primary); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .u-glass { background: white; padding: 35px; border-radius: 30px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .u-glass h2 { font-weight: 900; margin-bottom: 10px; color: var(--primary); }
        .u-glass p { color: #64748b; margin-bottom: 20px; font-size: 0.9rem; }
        .u-glass input { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; }
        .u-glass button { width: 100%; padding: 14px; margin-top: 10px; }
        .u-glass select { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; background: white; }
        .hidden { display: none !important; }

        .sidebar { width: 280px; background: var(--sidebar); color: white; height: 100vh; position: fixed; display: flex; flex-direction: column; z-index: 1000; overflow-y: auto; }
        .sidebar-header { padding: 35px 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h3 { font-size: 1.2rem; margin-bottom: 8px; }
        .m-lbl { font-size: 0.65rem; color: #64748b; text-transform: uppercase; padding: 20px 25px 8px; font-weight: 800; letter-spacing: 1.5px; }
        .m-item { display: flex; align-items: center; padding: 13px 25px; color: #94a3b8; cursor: pointer; border-left: 4px solid transparent; font-size: 0.9rem; }
        .m-item i { width: 28px; font-size: 1rem; margin-right: 8px; }
        .m-item:hover, .m-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); border-left-color: var(--accent); }
        .logout { margin-top: auto; padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.1); color: var(--danger); font-weight: 900; text-align: center; cursor: pointer; }

        .main { flex: 1; margin-left: 280px; width: calc(100% - 280px); display: flex; flex-direction: column; height: 100vh; }
        .topbar { background: white; height: 75px; display: flex; align-items: center; justify-content: space-between; padding: 0 35px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 990; }
        .topbar h4 { font-size: 1rem; font-weight: 900; color: var(--primary); text-transform: uppercase; margin: 0; }
        .topbar-right { display: flex; align-items: center; gap: 20px; }
        .user-info { text-align: right; }
        .user-info div:first-child { font-weight: 900; font-size: 0.95rem; }
        .user-info div:last-child { font-size: 0.65rem; color: var(--accent); font-weight: 800; }
        #p-avatar { width: 48px; height: 48px; border-radius: 12px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.3rem; }

        .container { padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; overflow-y: auto; height: calc(100vh - 75px); }
        
        .card { background: white; border-radius: 20px; box-shadow: var(--shadow); padding: 25px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .card h3 { margin: 0 0 20px 0; font-size: 1.1rem; color: var(--primary); }
        .card h4 { margin: 15px 0 10px 0; font-size: 0.95rem; color: var(--primary); }
        
        .tab-content { display: none; } 
        .tab-content.active { display: block; animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .f-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { font-size: 0.75rem; font-weight: 800; color: #475569; margin-bottom: 8px; display: block; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 11px 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: inherit; background: #f8fafc; font-size: 0.95rem; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; background: white; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f5f9; padding: 12px 14px; text-align: left; font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 800; }
        td { padding: 12px 14px; border-bottom: 1px solid #f1f5f9; }
        tr:last-child td { border-bottom: none; }
        .table-res { border-radius: 14px; overflow: hidden; border: 1px solid #e2e8f0; }

        .btn { padding: 11px 20px; border-radius: 11px; font-weight: 800; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; justify-content: center; font-size: 0.9rem; transition: all 0.2s; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-warn { background: var(--warning); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .btn-xs { padding: 6px 10px; font-size: 0.65rem; border-radius: 8px; }

        .badge { padding: 5px 12px; border-radius: 10px; font-size: 0.65rem; font-weight: 800; }
        .bg-pending { background: #fff7ed; color: #c2410c; }
        .bg-ok { background: #f0fdf4; color: #15803d; }
        .bg-info { background: #dbeafe; color: #0369a1; }

        .exam-section { background: #f1f5f9; padding: 18px; border-radius: 14px; margin-bottom: 18px; }
        .correction-item { background: #f8fafc; padding: 14px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--accent); }

        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .main { margin-left: 240px; width: calc(100% - 240px); }
            .topbar { padding: 0 25px; }
            .container { padding: 20px; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; left: -100%; top: 0; width: 280px; height: 100vh; transition: left 0.3s ease; box-shadow: 2px 0 15px rgba(0,0,0,0.2); }
            .sidebar.show { left: 0; }
            .main { margin-left: 0 !important; width: 100% !important; }
            .topbar { height: 65px; padding: 0 12px; }
            .topbar h4 { font-size: 0.95rem; }
            .topbar-right { gap: 12px; }
            #p-avatar { width: 40px; height: 40px; font-size: 1rem; border-radius: 10px; }
            .user-info div:first-child { font-size: 0.85rem; }
            .user-info div:last-child { font-size: 0.6rem; }
            .container { padding: 12px; height: calc(100vh - 65px); }
            .card { padding: 14px; margin-bottom: 12px; border-radius: 14px; }
            .card h3 { font-size: 1rem; margin-bottom: 14px; }
            .f-row { grid-template-columns: 1fr; gap: 10px; }
            label { font-size: 0.7rem; margin-bottom: 6px; }
            input, select, textarea { padding: 10px 12px; font-size: 0.9rem; border-radius: 10px; }
            table { font-size: 0.8rem; }
            th { padding: 10px 8px; font-size: 0.65rem; }
            td { padding: 10px 8px; }
            .btn { font-size: 0.8rem; padding: 10px 14px; border-radius: 10px; }
            .btn-xs { padding: 5px 8px; font-size: 0.6rem; }
            #d-clock-txt { font-size: 3rem !important; }
            #d-date-txt { font-size: 0.85rem !important; }
            .exam-section { padding: 12px; margin-bottom: 12px; border-radius: 12px; }
            .correction-item { padding: 12px; margin-bottom: 10px; border-radius: 10px; }
            #mobileMenuBtn { display: flex !important; }
            .sidebar-header { padding: 20px 15px; }
            .m-lbl { padding: 15px 15px 5px; font-size: 0.6rem; }
            .m-item { padding: 11px 15px; font-size: 0.85rem; }
            .m-item i { width: 24px; font-size: 0.95rem; margin-right: 8px; }
            .badge { padding: 4px 10px; font-size: 0.6rem; }
        }

        #mobileMenuBtn { display: none; background: transparent; color: var(--primary); border: none; cursor: pointer; padding: 8px; font-size: 1.3rem; }
        
        .login-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin: 25px 0; }
        .login-btn { flex: 1; padding: 14px; border: 2px solid #e2e8f0; border-radius: 14px; background: white; cursor: pointer; text-align: center; transition: all 0.2s; min-width: 140px; font-weight: 800; }
        .login-btn:hover { border-color: var(--accent); background: #dbeafe; color: var(--accent); }
        .login-btn.active { border-color: var(--accent); background: var(--accent); color: white; }

        .comp-btn { padding: 10px 12px; margin: 4px; border-radius: 10px; border: none; cursor: pointer; font-weight: 800; font-size: 0.8rem; transition: all 0.2s; }
        .comp-btn.selected { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3); transform: scale(1.05); }
        .comp-btn:hover { transform: translateY(-2px); }

        .cp-structure-guide { background: linear-gradient(135deg, #dbeafe 0%, #f0fdf4 100%); padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent); margin-bottom: 20px; }

        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }

        #loading-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 99999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="scr-setup" class="u-screen hidden">
   <div class="u-glass">
    <h2>üè´ AKTIVASI SISTEM KEPALA SEKOLAH</h2>
    <p>Hanya Kepala Sekolah yang dapat mengaktifkan sistem</p><input type="text" id="reg-npsn" placeholder="NPSN (8 Digit)" maxlength="8"> <input type="text" id="reg-nama" placeholder="Nama Sekolah"> <input type="text" id="reg-lat" placeholder="Latitude: -6.835"> <input type="text" id="reg-lng" placeholder="Longitude: 108.241">
    <p style="font-size:0.8rem; color:#64748b; margin:15px 0;">üìç Contoh Majalengka: -6.835, 108.241</p><button onclick="saveActivation()" class="btn btn-blue">AKTIFKAN SISTEM v45</button>
    <p style="font-size:0.7rem; color:#64748b; margin-top:15px;">üîí Hanya sekali saja. Aktivasi tidak akan muncul lagi.</p>
   </div>
  </div>
  <div id="scr-login" class="u-screen hidden">
   <div class="u-glass">
    <div style="font-size:3rem; margin-bottom:15px;">
     üìö
    </div>
    <h2 id="v-school-name" style="margin:0 0 5px 0; color:var(--accent);">PORTAL GURU</h2>
    <p id="v-school-npsn" style="font-size:0.75rem; color:#64748b; margin-bottom:15px;"></p><input type="text" id="log-u" placeholder="ID User Account" autofocus> <input type="password" id="log-p" placeholder="Security PIN" onkeypress="if(event.key==='Enter') handleLogin()"> <button onclick="handleLogin()" class="btn btn-blue">LOGIN PORTAL</button>
    <p style="font-size:0.7rem; color:#64748b; margin-top:15px;">Demo | Guru: guru1/12345 | Kepsek: admin/12345</p>
   </div>
  </div>
  <div id="loading-modal" class="hidden">
   <div class="loading-spinner"></div>
  </div>
  <div id="m-gps" class="u-screen hidden">
   <div class="u-glass">
    <div style="font-size:3.5rem; margin-bottom:10px;">
     üìç
    </div>
    <h3 style="margin:0 0 15px 0;">CEK LOKASI KEHADIRAN</h3>
    <p id="t-dist" style="font-size:1.2rem; font-weight:900; color:var(--accent); margin:20px 0;">Mendeteksi lokasi...</p><button id="b-ab-done" class="btn btn-green" style="width:100%; padding:15px; margin-bottom:10px;" onclick="execAbsen()" disabled>KONFIRMASI HADIR</button> <button onclick="closeGps()" class="btn" style="width:100%; background:#e2e8f0; color:var(--primary);">Batal</button>
   </div>
  </div>
  <div id="sidebar" class="sidebar hidden">
   <div class="sidebar-header">
    <h3>SUPREME v45</h3>
    <div id="clk" style="font-size:0.75rem; color:#94a3b8; margin-top:8px;"></div>
    <p id="p-kelas-label" style="font-size:0.7rem; color:#60a5fa; margin-top:5px; margin-bottom:0;">GURU</p>
   </div>
   <div style="flex:1; overflow-y: auto;">
    <div onclick="switchTab('dashboard'); document.getElementById('sidebar').classList.remove('show');" class="m-item active">
     <i class="fa fa-home"></i>Dashboard
    </div>
    <div id="menu-area-guru" class="hidden">
     <p class="m-lbl">üìã Administrasi Guru</p>
     <div onclick="switchTab('g-siswa'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-user-graduate"></i>Akun Siswa
     </div>
     <div onclick="switchTab('g-absen'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-calendar-check"></i>Absensi Siswa
     </div>
     <div onclick="switchTab('g-agenda'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-book"></i>Agenda Harian (CP)
     </div>
     <div onclick="switchTab('g-modul'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-folder-open"></i>Modul Mingguan
     </div>
     <div onclick="switchTab('g-ujian'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-file-signature"></i>Buat Soal Ujian
     </div>
     <div onclick="switchTab('g-koreksi'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-check-circle"></i>Koreksi Jawaban
     </div>
     <div onclick="switchTab('g-nilai'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-award"></i>Input Nilai
     </div>
    </div>
    <div id="menu-area-kepsek" class="hidden">
     <p class="m-lbl">üë®‚Äçüíº Monitoring Kepsek</p>
     <div onclick="switchTab('k-absen'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-user-clock"></i>Ceklok Guru
     </div>
     <div onclick="switchTab('k-agenda'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-check-double"></i>Review Agenda CP
     </div>
     <div onclick="switchTab('k-modul'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-paste"></i>Review Modul
     </div>
     <div onclick="switchTab('k-rekap'); document.getElementById('sidebar').classList.remove('show');" class="m-item">
      <i class="fa fa-list-ol"></i>Rekap Nilai
     </div>
     <p class="m-lbl">‚öôÔ∏è Pengaturan</p>
     <div onclick="switchTab('k-staf'); document.getElementById('sidebar').classList.remove('show');" class="m-item" style="color:var(--success);">
      <i class="fa fa-users-cog"></i>Data Staf &amp; PIN
     </div>
    </div>
   </div>
   <div onclick="location.reload()" class="logout">
    <i class="fa fa-sign-out"></i> LOGOUT
   </div>
  </div>
  <div id="main-ui" class="main hidden">
   <div class="topbar"><button onclick="toggleMenu()" class="btn" id="mobileMenuBtn"><i class="fa fa-bars"></i></button>
    <h4 id="v-title-label">DASHBOARD</h4>
    <div class="topbar-right">
     <div class="user-info">
      <div id="p-name">
       ...
      </div>
      <div id="p-role">
       GURU
      </div>
     </div>
     <div id="p-avatar">
      ?
     </div>
    </div>
   </div>
   <div class="container">
    <div id="tab-dashboard" class="tab-content active">
     <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%); color:white; text-align:center; padding:40px 25px;">
      <h4 id="d-date-txt" style="color:rgba(255,255,255,0.8); margin:0 0 15px 0;">Tgl Hari Ini</h4>
      <h1 id="d-clock-txt" style="font-size:4.5rem; margin:10px 0; font-weight:900;">00:00:00</h1>
      <p id="p-mapel-label" style="opacity:0.8; margin:15px 0 20px 0; font-size:0.9rem;">üìç Radius 200m | Aktifkan GPS</p><button onclick="openGps()" class="btn btn-green" style="width:100%; padding:14px; font-size:0.95rem;"><i class="fa fa-map-marker-alt"></i> CEKLOK HADIR SEKARANG</button>
     </div>
     <div id="k-stats-row" class="hidden" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px;">
      <div class="card" style="border-left:5px solid var(--accent); padding:15px;">
       <p style="margin:0 0 8px 0; font-size:0.8rem; color:#64748b;">Guru Hadir</p>
       <h2 id="sk-absen" style="margin:0; font-size:2rem; color:var(--accent);">0</h2>
      </div>
      <div class="card" style="border-left:5px solid var(--warning); padding:15px;">
       <p style="margin:0 0 8px 0; font-size:0.8rem; color:#64748b;">Agenda CP Pending</p>
       <h2 id="sk-agenda" style="margin:0; font-size:2rem; color:var(--warning);">0</h2>
      </div>
      <div class="card" style="border-left:5px solid var(--danger); padding:15px;">
       <p style="margin:0 0 8px 0; font-size:0.8rem; color:#64748b;">Modul Belum</p>
       <h2 id="sk-modul" style="margin:0; font-size:2rem; color:var(--danger);">0</h2>
      </div>
     </div>
    </div><!-- TAB SISWA -->
    <div id="tab-g-siswa" class="tab-content">
     <div class="card">
      <h3>üë§ Kelola Akun Siswa</h3>
      <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Tambah siswa satu per satu atau import dari Excel</p>
      <div style="background:#f0fdf4; padding:15px; border-radius:12px; margin-bottom:15px; border-left:4px solid var(--success);">
       <h4 style="margin-top:0; color:#15803d;">‚¨áÔ∏è IMPORT DARI EXCEL</h4>
       <p style="font-size:0.75rem; color:#64748b; margin:10px 0;">Unduh template ‚Üí Isi data siswa ‚Üí Upload kembali</p>
       <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><button onclick="downloadStudentTemplate()" class="btn btn-green" style="width:100%;"><i class="fa fa-download"></i> Template Excel</button> <input type="file" id="file-siswa-inp" accept=".xlsx, .xls" onchange="importSiswaExcel()" style="display:none;"> <button onclick="document.getElementById('file-siswa-inp').click()" class="btn btn-blue" style="width:100%;"><i class="fa fa-upload"></i> Upload Excel</button>
       </div>
      </div>
      <div style="border-top:2px solid #e2e8f0; padding-top:15px; margin-top:15px;">
       <h4>‚ûï TAMBAH SISWA MANUAL</h4>
       <div class="f-row"><input type="text" id="gs-nama" placeholder="Nama Lengkap Siswa"> <input type="text" id="gs-user" placeholder="Username Login">
       </div>
       <div class="f-row"><input type="text" id="gs-pass" placeholder="Password"> <select id="gs-kls"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
       </div><button onclick="addStudent()" class="btn btn-blue" style="width:100%;"><i class="fa fa-plus"></i> DAFTARKAN SISWA</button>
      </div>
      <div class="table-res" style="margin-top:15px;">
       <table>
        <thead>
         <tr>
          <th>User</th>
          <th>Nama</th>
          <th>Kls</th>
          <th>Pass</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-gs-list"></tbody>
       </table>
      </div>
     </div>
    </div><!-- TAB ABSEN SISWA -->
    <div id="tab-g-absen" class="tab-content">
     <div class="card">
      <h3>üìã Absensi Siswa Harian</h3>
      <div class="f-row"><select id="ga-kls-sel" onchange="renderAbsenSiswa()"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select> <input type="text" class="global-date-inp" readonly>
      </div>
      <div class="table-res">
       <table>
        <thead>
         <tr>
          <th>Nama Siswa</th>
          <th>Kelas</th>
          <th>Status (H/S/I/A)</th>
         </tr>
        </thead>
        <tbody id="tbl-ga-list"></tbody>
       </table>
      </div><button onclick="saveAbsenSiswa()" class="btn btn-green" style="width:100%; margin-top:15px;"><i class="fa fa-save"></i> SIMPAN ABSENSI</button>
     </div>
    </div><!-- TAB AGENDA CP -->
    <div id="tab-g-agenda" class="tab-content">
     <div class="cp-structure-guide">
      <h4 style="margin-top:0; color:var(--accent); font-weight:900;">üìã STRUKTUR CP &amp; TP KURIKULUM MERDEKA</h4>
      <p style="font-size:0.75rem; color:#64748b; margin:10px 0; margin-bottom:0;"><strong>üìå PANDUAN:</strong> Isi setiap elemen sesuai standar Kurikulum Merdeka</p>
     </div>
     <div class="card">
      <h3>üìù Agenda Harian Guru - CP &amp; TP</h3>
      <div class="f-row">
       <div><label>üìÖ Tanggal</label> <input type="text" class="global-date-inp" readonly>
       </div>
       <div><label>üìö Mata Pelajaran</label> <select id="gag-mapel-sel" style="margin-bottom:0;"> <option>-- Pilih Mapel --</option> </select>
       </div>
      </div>
      <div class="exam-section" style="background:#f0fdf4; border-left:4px solid var(--success);">
       <h4 style="color:#15803d; margin-top:0;">1Ô∏è‚É£ ELEMEN PEMBELAJARAN</h4><select id="gag-elemen" style="margin-bottom:0;"> <option value="">-- Pilih Elemen --</option> <option value="Pemahaman Konsep">üß† Pemahaman Konsep</option> <option value="Penerapan Prosedur">‚öôÔ∏è Penerapan Prosedur</option> <option value="Penalaran &amp; Kreativitas">üí° Penalaran &amp; Kreativitas</option> <option value="Komunikasi &amp; Kolaborasi">ü§ù Komunikasi &amp; Kolaborasi</option> <option value="Kesadaran Sosial">‚ù§Ô∏è Kesadaran Sosial</option> </select>
      </div>
      <div class="exam-section" style="background:#fef2f2; border-left:4px solid var(--danger);">
       <h4 style="color:#b91c1c; margin-top:0;">2Ô∏è‚É£ CAPAIAN PEMBELAJARAN (CP)</h4><textarea id="gag-cp" rows="3" placeholder="Target pembelajaran..." style="margin-bottom:0;"></textarea>
      </div>
      <div class="exam-section" style="background:#f5f3ff; border-left:4px solid #8b5cf6;">
       <h4 style="color:#7c3aed; margin-top:0;">3Ô∏è‚É£ KOMPETENSI (BLOOM)</h4>
       <div class="f-row" style="gap:8px; margin-bottom:10px; grid-template-columns: repeat(2, 1fr);"><button onclick="selectKompetensi('C1 - Mengingat')" class="comp-btn" style="background:#e0e7ff; color:#3730a3;">C1 Ingat</button> <button onclick="selectKompetensi('C2 - Memahami')" class="comp-btn" style="background:#ddd6fe; color:#5b21b6;">C2 Pahami</button> <button onclick="selectKompetensi('C3 - Menerapkan')" class="comp-btn" style="background:#d8d5f8; color:#6d28d9;">C3 Terapkan</button> <button onclick="selectKompetensi('C4 - Menganalisis')" class="comp-btn" style="background:#e5d4ff; color:#7c3aed;">C4 Analisis</button> <button onclick="selectKompetensi('C5 - Mengevaluasi')" class="comp-btn" style="background:#f3e8ff; color:#a855f7;">C5 Evaluasi</button> <button onclick="selectKompetensi('C6 - Menciptakan')" class="comp-btn" style="background:#faf5ff; color:#d946ef;">C6 Ciptakan</button>
       </div><input type="text" id="gag-kompetensi" readonly style="background:#f5f3ff; font-weight:800; text-align:center;" placeholder="Pilih kompetensi...">
      </div>
      <div class="exam-section" style="background:#fffbeb; border-left:4px solid var(--warning);">
       <h4 style="color:#b45309; margin-top:0;">4Ô∏è‚É£ LINGKUP MATERI</h4><textarea id="gag-lingkup" rows="3" placeholder="Konten utama..." style="margin-bottom:0;"></textarea>
      </div>
      <div class="exam-section" style="background:#f0fdf4; border-left:4px solid var(--success);">
       <h4 style="color:#15803d; margin-top:0;">5Ô∏è‚É£ TUJUAN PEMBELAJARAN (TP)</h4><textarea id="gag-tp" rows="3" placeholder="Target spesifik hari ini..." style="margin-bottom:0;"></textarea>
      </div><button onclick="submitAgenda()" class="btn btn-blue" style="width:100%; margin-top:15px; padding:14px;"><i class="fa fa-paper-plane"></i> AJUKAN AGENDA KE KEPSEK</button>
     </div>
    </div><!-- TAB MODUL -->
    <div id="tab-g-modul" class="tab-content">
     <div class="card">
      <h3>üìö Modul Ajar Mingguan</h3><input type="text" id="gm-title" placeholder="Judul Modul" style="margin-bottom:10px;"> <select id="gm-mapel" style="margin-bottom:10px;"> <option>-- Pilih Mata Pelajaran --</option> </select> <textarea id="gm-logic" rows="6" placeholder="Langkah-langkah Pembelajaran..."></textarea> <button onclick="submitModul()" class="btn btn-green" style="width:100%; margin-top:15px;"><i class="fa fa-upload"></i> KIRIM KE KEPSEK</button>
     </div>
    </div><!-- TAB UJIAN -->
    <div id="tab-g-ujian" class="tab-content">
     <div class="card">
      <h3>üìñ Bank Soal Ujian</h3>
      <div style="background:#fef3c7; padding:15px; border-radius:12px; margin-bottom:15px; border-left:4px solid var(--warning);">
       <h4 style="margin-top:0; color:#b45309;">‚¨áÔ∏è IMPORT SOAL DARI EXCEL</h4>
       <p style="font-size:0.75rem; color:#64748b; margin:10px 0;">Buat soal di Excel ‚Üí Download template ‚Üí Kirim batch</p>
       <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><button onclick="downloadExamTemplate()" class="btn btn-warn" style="width:100%;"><i class="fa fa-download"></i> Template Soal</button> <input type="file" id="file-soal-inp" accept=".xlsx, .xls" onchange="importSoalExcel()" style="display:none;"> <button onclick="document.getElementById('file-soal-inp').click()" class="btn btn-blue" style="width:100%;"><i class="fa fa-upload"></i> Upload Soal</button>
       </div>
      </div>
      <div style="border-top:2px solid #e2e8f0; padding-top:15px; margin-top:15px;">
       <h4>‚ûï TAMBAH SOAL MANUAL</h4><input type="text" id="ex-header" placeholder="Judul Ujian" style="margin-bottom:10px;">
       <div class="f-row"><select id="ex-jenis"><option value="UH">Ulangan Harian (UH)</option><option value="STS">STS</option><option value="SAS">SAS/SAT</option></select> <select id="ex-mapel" style="margin-bottom:0;"> <option>-- Mata Pelajaran --</option> </select>
       </div>
       <div class="f-row"><select id="ex-type" onchange="toggleExType()"><option value="PG">Pilihan Ganda</option><option value="ES">Essay</option></select>
       </div>
       <div style="background:#f1f5f9; padding:15px; border-radius:12px; margin-bottom:15px;"><textarea id="ex-q" rows="3" placeholder="Butir Pertanyaan..." style="margin-bottom:10px;"></textarea>
        <div id="ex-pg-ops"><input type="text" id="ex-oa" placeholder="Opsi A" style="margin-bottom:5px;"> <input type="text" id="ex-ob" placeholder="Opsi B" style="margin-bottom:5px;"> <input type="text" id="ex-oc" placeholder="Opsi C" style="margin-bottom:5px;"> <input type="text" id="ex-od" placeholder="Opsi D" style="margin-bottom:5px;">
        </div><input type="text" id="ex-ans" placeholder="Kunci Jawaban">
       </div><button onclick="saveQuestion()" class="btn btn-blue" style="width:100%;"><i class="fa fa-save"></i> SIMPAN SOAL</button>
      </div>
      <div class="table-res" style="margin-top:15px;">
       <table>
        <thead>
         <tr>
          <th>Soal</th>
          <th>Jenis</th>
          <th>Tipe</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-ex-list"></tbody>
       </table>
      </div><button onclick="publishExam()" class="btn btn-green" style="width:100%; margin-top:10px;"><i class="fa fa-share-nodes"></i> PUBLISH KE SISWA</button>
     </div>
    </div><!-- TAB KOREKSI -->
    <div id="tab-g-koreksi" class="tab-content">
     <div class="card">
      <h3>‚úèÔ∏è Koreksi Jawaban Siswa</h3>
      <div class="f-row"><select id="kor-exam-sel" onchange="loadExamAnswers()"><option value="">-- Pilih Ujian --</option></select> <select id="kor-siswa-sel" onchange="loadStudentAnswers()"><option value="">-- Pilih Siswa --</option></select>
      </div>
      <div id="kor-detail-area" style="display:none;">
       <div class="exam-section">
        <h4 id="kor-exam-title">Nama Ujian</h4>
        <p id="kor-exam-info" style="font-size:0.75rem; color:#64748b; margin:0;"></p>
       </div>
       <div id="kor-questions-area"></div>
       <div class="card" style="background:#f0fdf4; border-left:4px solid var(--success);">
        <h4>üìä Nilai Akhir</h4><input type="number" id="kor-nilai-akhir" min="0" max="100" value="0" style="margin-bottom:10px;"> <select id="kor-status" style="margin-bottom:10px;"><option value="TUNTAS">TUNTAS (‚â•75)</option><option value="REMEDIAL">REMEDIAL (&lt;75)</option></select> <button onclick="saveCorrection()" class="btn btn-green" style="width:100%;"><i class="fa fa-save"></i> SIMPAN KOREKSI</button>
       </div>
      </div>
     </div>
    </div><!-- TAB NILAI -->
    <div id="tab-g-nilai" class="tab-content">
     <div class="card">
      <h3>üìä Input Nilai Siswa</h3>
      <div class="f-row"><select id="gn-mapel" onchange="fetchSiswaNilai()"> <option>-- Pilih Mata Pelajaran --</option> </select> <select id="gn-kls" onchange="fetchSiswaNilai()"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
      </div>
      <div style="margin-bottom:15px; display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
       <div>
        <label>Tugas Penilaian (TP)</label>
       </div>
       <div>
        <label>STS Semester 1</label>
       </div>
       <div>
        <label>STS Semester 2</label>
       </div>
       <div>
        <label>SAS (Sumatif Akhir Semester)</label>
       </div>
       <div>
        <label>SAT (Sumatif Akhir Tahun)</label>
       </div>
      </div>
      <div class="table-res">
       <table>
        <thead>
         <tr>
          <th>Siswa</th>
          <th>TP</th>
          <th>STS S1</th>
          <th>STS S2</th>
          <th>SAS</th>
          <th>SAT</th>
         </tr>
        </thead>
        <tbody id="tbl-gn-list"></tbody>
       </table>
      </div><button onclick="saveGrades()" class="btn btn-green" style="width:100%; margin-top:15px;"><i class="fa fa-save"></i> SIMPAN SEMUA NILAI</button>
     </div>
    </div><!-- TAB KEPSEK ABSEN -->
    <div id="tab-k-absen" class="tab-content">
     <div class="card">
      <h3>üë• Monitoring Ceklok Guru</h3>
      <div class="table-res">
       <table>
        <thead>
         <tr>
          <th>Guru</th>
          <th>Status</th>
          <th>Jam</th>
          <th>Lokasi</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-k-abs"></tbody>
       </table>
      </div>
     </div>
    </div><!-- TAB KEPSEK AGENDA -->
    <div id="tab-k-agenda" class="tab-content">
     <div class="card">
      <h3>üìã Review Agenda CP &amp; TP</h3>
      <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Verifikasi struktur CP &amp; TP yang diajukan guru</p>
      <div class="table-res">
       <table>
        <thead>
         <tr>
          <th>Tgl</th>
          <th>Guru / Mapel</th>
          <th>Kompetensi</th>
          <th>TP (Ringkas)</th>
          <th>Status</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-k-rev-agenda"></tbody>
       </table>
      </div>
     </div>
    </div><!-- TAB KEPSEK MODUL -->
    <div id="tab-k-modul" class="tab-content">
     <div class="card">
      <h3>üìö Review Modul Ajar</h3>
      <div class="table-res">
       <table>
        <thead>
         <tr>
          <th>Guru</th>
          <th>Tema/Mapel</th>
          <th>Status</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-k-rev-modul-body"></tbody>
       </table>
      </div>
     </div>
    </div><!-- TAB KEPSEK REKAP -->
    <div id="tab-k-rekap" class="tab-content">
     <div class="card">
      <h3>üìà Rekapitulasi Nilai</h3>
      <div class="f-row"><select id="kr-kls" onchange="setRekapMapelByKelas()"><option value="1">Kelas 1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select> <select id="kr-mapel"></select> <button onclick="renderRekap()" class="btn btn-blue">TAMPILKAN</button>
      </div>
      <div class="table-res">
       <table id="rekap-print-area">
        <thead>
         <tr>
          <th>Nama</th>
          <th>Kelas</th>
          <th>Rata-rata</th>
          <th>Ket</th>
         </tr>
        </thead>
        <tbody id="tbl-k-rekap-body"></tbody>
       </table>
      </div><button onclick="printRapor()" class="btn btn-warn" style="width:100%; margin-top:15px;"><i class="fa fa-print"></i> CETAK REKAP</button>
     </div>
    </div><!-- TAB KEPSEK STAF -->
    <div id="tab-k-staf" class="tab-content">
     <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd;">
      <h4 style="margin:0 0 10px 0; font-weight:800; color:var(--accent);">‚öôÔ∏è PENGATURAN GPS SEKOLAH</h4>
      <p style="font-size:0.8rem; margin-bottom:15px; color:#64748b;">Update koordinat sekolah untuk Ceklok Guru</p>
      <div class="f-row"><input type="text" id="conf-lat" placeholder="Latitude"> <input type="text" id="conf-lng" placeholder="Longitude">
      </div><button onclick="updateConfig()" class="btn btn-green" style="width:100%;"><i class="fa fa-save"></i> SIMPAN KOORDINAT</button>
     </div>
     <div class="card">
      <h3>üë®‚Äçüíº Kelola Data Staf Guru</h3><input type="text" id="ks-n" placeholder="Nama Lengkap" style="margin-bottom:10px;"> <input type="text" id="ks-nip" placeholder="NIP" style="margin-bottom:10px;"> <input type="text" id="ks-u" placeholder="ID Akun Login" style="margin-bottom:10px;"> <input type="text" id="ks-p" placeholder="Security PIN" style="margin-bottom:10px;"> <input type="text" id="ks-wa" placeholder="No WA (62...)" style="margin-bottom:10px;"> <select id="ks-r" style="margin-bottom:10px;"> <option value="GURU12">GURU KELAS 1-2</option> <option value="GURU36">GURU KELAS 3-6</option> <option value="PAI">GURU PAI</option> <option value="PJOK">GURU PJOK</option> <option value="KEPSEK">KEPALA SEKOLAH</option> </select> <button onclick="saveStaff()" class="btn btn-blue" style="width:100%;"><i class="fa fa-save"></i> SIMPAN DATA STAF</button>
      <div class="table-res" style="margin-top:15px;">
       <table>
        <thead>
         <tr>
          <th>Nama</th>
          <th>ID</th>
          <th>PIN</th>
          <th>WA</th>
          <th>Aksi</th>
         </tr>
        </thead>
        <tbody id="tbl-ks-list"></tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
const CFG = { 
    apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ", 
    authDomain: "adminsitrasi-guru-de394.firebaseapp.com", 
    databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "adminsitrasi-guru-de394" 
};
firebase.initializeApp(CFG); 
const db = firebase.database();

const MAPEL_BY_LEVEL = {
    'GURU12': ['Matematika', 'Bahasa Indonesia', 'Pendidikan Pancasila', 'Seni Budaya', 'Bahasa Sunda'],
    'GURU36': ['Matematika', 'Bahasa Indonesia', 'Pendidikan Pancasila', 'Seni Budaya', 'Bahasa Sunda', 'IPAS', 'Bahasa Inggris'],
    'PAI': ['Pendidikan Agama Islam'],
    'PJOK': ['Pendidikan Jasmani Olahraga Kesehatan']
};

let curU = null; 
let sch = null;
let S_COOR = { lat: -6.835, lng: 108.241 };
let tempEx = [];
let correctionState = { examId: null, studentId: null, answers: [] };

window.onload = () => {
    sch = JSON.parse(localStorage.getItem('ADM_V45_SUPREME'));
    if(!sch) {
        showScreen('scr-setup');
    } else { 
        if(sch.lat && sch.lng) {
            S_COOR.lat = parseFloat(sch.lat);
            S_COOR.lng = parseFloat(sch.lng);
        }
        initPortal(); 
        syncCloud(); 
    }
};

function showScreen(id) {
    document.querySelectorAll('.u-screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

function initPortal() {
    showScreen('scr-login');
    document.getElementById('v-school-name').innerText = sch.nama;
    document.getElementById('v-school-npsn').innerText = "NPSN: " + sch.npsn;
}

function saveActivation() {
    const n = document.getElementById('reg-npsn').value; 
    const nm = document.getElementById('reg-nama').value;
    const lat = document.getElementById('reg-lat').value;
    const lng = document.getElementById('reg-lng').value;
    
    if(!n || !nm || !lat || !lng) return showInlineAlert("‚ö†Ô∏è Harap isi NPSN, Nama Sekolah, dan Koordinat!");
    
    const schoolData = {npsn:n, nama:nm, lat:lat, lng:lng};
    localStorage.setItem('ADM_V45_SUPREME', JSON.stringify(schoolData));
    db.ref('schools/'+n+'/config').set({ lat: lat, lng: lng, nama: nm });
    
    location.reload();
}

function handleLogin() {
    const u = document.getElementById('log-u').value; 
    const p = document.getElementById('log-p').value;
    
    if(!u || !p) return showInlineAlert("‚ö†Ô∏è Isi User ID dan PIN!");
    
    if(u === 'admin' && p === '12345') {
        proceedLogin({u:'admin', n:'Kepala Sekolah', r:'KEPSEK', id:'ROOT', mapel:'SEMUA'});
        return;
    }

    if(u === 'guru1' && p === '12345') {
        proceedLogin({u:'guru1', n:'Guru Demo', r:'GURU12', id:'GURU1', mapel: 'Matematika'});
        return;
    }

    let found = null;
    for(let id in STAF_DATA) {
        if(STAF_DATA[id].u === u && STAF_DATA[id].p === p) {
            found = STAF_DATA[id];
        }
    }

    if(found) {
        proceedLogin(found);
    }
    else showInlineAlert("‚ùå Gagal Login. Periksa User & PIN!");
}

function proceedLogin(user) {
    curU = user;
    showScreen('main-ui');
    document.getElementById('sidebar').classList.remove('hidden');
    document.getElementById('p-name').innerText = user.n;
    document.getElementById('p-role').innerText = user.r;
    document.getElementById('p-avatar').innerText = user.n.charAt(0);
    
    const roleLabel = user.r === 'KEPSEK' ? 'KEPALA SEKOLAH' : user.r;
    document.getElementById('p-kelas-label').innerText = roleLabel;
    document.getElementById('p-mapel-label').innerText = `üìö ${user.mapel || 'Semua Mapel'}`;

    if(user.r === 'KEPSEK') {
        document.getElementById('menu-area-kepsek').classList.remove('hidden');
        document.getElementById('k-stats-row').classList.remove('hidden');
        document.getElementById('conf-lat').value = S_COOR.lat;
        document.getElementById('conf-lng').value = S_COOR.lng;
    } else {
        document.getElementById('menu-area-guru').classList.remove('hidden');
    }
    
    populateMapelSelects();
    switchTab('dashboard');
    if(user.r === 'KEPSEK'){ setRekapMapelByKelas(); }
}

function populateMapelSelects() {
    let mapels = MAPEL_BY_LEVEL[curU.r] || ['Matematika', 'Bahasa Indonesia', 'Pendidikan Pancasila', 'Seni Budaya', 'Bahasa Sunda', 'IPAS', 'Bahasa Inggris', 'Pendidikan Agama Islam', 'PJOK'];
    
    ['gn-mapel', 'ex-mapel', 'gm-mapel', 'gag-mapel-sel'].forEach(id => {
        const sel = document.getElementById(id);
        if(sel) {
            sel.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
            mapels.forEach(m => sel.innerHTML += `<option>${m}</option>`);
        }
    });
}

function syncCloud() {
    db.ref('schools/'+sch.npsn+'/config').on('value', s => {
        const config = s.val();
        if(config && config.lat && config.lng) {
            S_COOR.lat = parseFloat(config.lat);
            S_COOR.lng = parseFloat(config.lng);
            sch.lat = config.lat;
            sch.lng = config.lng;
            localStorage.setItem('ADM_V45_SUPREME', JSON.stringify(sch));
            if(curU && curU.r === 'KEPSEK') {
                document.getElementById('conf-lat').value = S_COOR.lat;
                document.getElementById('conf-lng').value = S_COOR.lng;
            }
        }
    });

    db.ref('schools/'+sch.npsn+'/staff').on('value', s => {
        window.STAF_DATA = s.val() || {};
        renderStaffTable();
        renderAbsenMonitor();
    });
    
    db.ref('schools/'+sch.npsn+'/students').on('value', s => {
        window.SISWA_DATA = s.val() || {};
        renderStudentTable();
    });
    
    db.ref('schools/'+sch.npsn+'/moduls').on('value', s => {
        const data = s.val() || {};
        if(!curU || curU.r !== 'KEPSEK') return;
        let h = '';
        for(let id in data) {
            let x = data[id];
            h += `<tr><td>${x.n}</td><td>${x.t} / ${x.m}</td><td><span class="badge bg-${x.st==='OK'?'ok':'pending'}">${x.st}</span></td><td><button onclick="approveModul('${id}')" class="btn btn-green btn-xs">‚úì Setuju</button></td></tr>`;
        }
        document.getElementById('tbl-k-rev-modul-body').innerHTML = h;
    });

    db.ref('schools/'+sch.npsn+'/exams').on('value', s => {
        const allEx = s.val() || {};
        let h = '';
        let examList = [];
        for(let id in allEx) {
            examList.push({id, data: allEx[id]});
            h += `<tr><td>${allEx[id].title.substring(0,30)}</td><td>${allEx[id].jenis}/${allEx[id].mapel}</td><td><span class="badge bg-ok">LIVE</span></td><td><button onclick="delExam('${id}')" class="btn btn-red btn-xs">‚úï Hapus</button></td></tr>`;
        }
        document.getElementById('tbl-ex-list').innerHTML = h;
        
        let examSel = document.getElementById('kor-exam-sel');
        let prevSelected = examSel.value;
        examSel.innerHTML = '<option value="">-- Pilih Ujian --</option>';
        examList.forEach(ex => {
            examSel.innerHTML += `<option value="${ex.id}">${ex.data.title}</option>`;
        });
        if(prevSelected) examSel.value = prevSelected;
    });

    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/agendas/'+d).on('value', s => {
        const ag = s.val() || {}; 
        let cnt = 0; for(let i in ag) if(ag[i].st==='PENDING') cnt++;
        document.getElementById('sk-agenda').innerText = cnt;
        renderReviewAgenda(ag);
    });
}

function selectKompetensi(kom) {
    document.querySelectorAll('.comp-btn').forEach(b => b.classList.remove('selected'));
    event.target.classList.add('selected');
    document.getElementById('gag-kompetensi').value = kom;
}

function downloadStudentTemplate() {
    const ws = XLSX.utils.aoa_to_sheet([
        ['Nama Lengkap', 'Username', 'Password', 'Kelas'],
        ['Contoh Siswa', 'siswa01', 'pass123', '1']
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siswa");
    XLSX.writeFile(wb, "Template_Siswa_"+sch.npsn+".xlsx");
    showInlineAlert("‚úÖ Template Siswa Terunduh!");
}

function importSiswaExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet);
            
            let count = 0;
            data.forEach(row => {
                if(row['Nama Lengkap'] && row.Username) {
                    db.ref('schools/'+sch.npsn+'/students/'+row.Username).set({
                        n: row['Nama Lengkap'],
                        u: row.Username,
                        p: row.Password || 'default123',
                        k: row.Kelas || '1'
                    });
                    count++;
                }
            });
            
            showInlineAlert(`‚úÖ ${count} siswa berhasil diimport!`);
            document.getElementById('file-siswa-inp').value = '';
        } catch(err) {
            showInlineAlert("‚ùå Gagal baca file Excel!");
        }
    };
    reader.readAsArrayBuffer(file);
}

function downloadExamTemplate() {
    const ws = XLSX.utils.aoa_to_sheet([
        ['Judul Ujian', 'Jenis', 'Mapel', 'Tipe Soal', 'Pertanyaan', 'Opsi A', 'Opsi B', 'Opsi C', 'Opsi D', 'Kunci Jawaban'],
        ['UH Bilangan', 'UH', 'Matematika', 'PG', 'Berapa 2+2?', 'A', 'B', 'C', '4', 'D']
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Soal");
    XLSX.writeFile(wb, "Template_Soal_"+sch.npsn+".xlsx");
    showInlineAlert("‚úÖ Template Soal Terunduh!");
}

function importSoalExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(sheet);
            
            let count = 0;
            data.forEach(row => {
                if(row['Pertanyaan']) {
                    const soal = {
                        q: row['Pertanyaan'],
                        ty: row['Tipe Soal'] || 'PG',
                        ans: row['Kunci Jawaban']
                    };
                    
                    if(row['Tipe Soal'] === 'PG') {
                        soal.opts = [row['Opsi A'], row['Opsi B'], row['Opsi C'], row['Opsi D']];
                    }
                    
                    tempEx.push(soal);
                    count++;
                }
            });
            
            renderExTemp();
            showInlineAlert(`‚úÖ ${count} soal berhasil diimport!`);
            document.getElementById('file-soal-inp').value = '';
        } catch(err) {
            showInlineAlert("‚ùå Gagal baca file Excel!");
        }
    };
    reader.readAsArrayBuffer(file);
}

function openGps() { document.getElementById('m-gps').classList.remove('hidden'); checkLocation(); }
function closeGps() { document.getElementById('m-gps').classList.add('hidden'); }

function checkLocation() {
    if(!navigator.geolocation) {
        document.getElementById('t-dist').innerText = "‚ö†Ô∏è GPS Tidak Tersedia";
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        pos => {
            const dist = calcDistance(pos.coords.latitude, pos.coords.longitude, S_COOR.lat, S_COOR.lng);
            document.getElementById('t-dist').innerText = Math.round(dist) + " meter";
            if(dist <= 210) {
                document.getElementById('b-ab-done').disabled = false;
                document.getElementById('b-ab-done').innerText = "‚úì HADIR SEKARANG";
                document.getElementById('b-ab-done').style.background = "var(--success)";
            } else {
                document.getElementById('b-ab-done').disabled = true;
                document.getElementById('b-ab-done').innerText = "‚úó DILUAR RADIUS";
                document.getElementById('b-ab-done').style.background = "var(--danger)";
            }
        },
        err => {
            document.getElementById('t-dist').innerText = "‚ö†Ô∏è GPS Gagal";
        },
        { timeout: 10000, enableHighAccuracy: true }
    );
}

function execAbsen() {
    const d = new Date().toISOString().split('T')[0];
    const jam = new Date().toLocaleTimeString('id-id');
    db.ref('schools/'+sch.npsn+'/absen/'+d+'/'+curU.u).set({
        jam, guru: curU.n, st: 'HADIR', loc: 'Verified'
    }).then(() => { 
        showInlineAlert("‚úÖ Ceklok Berhasil!"); 
        closeGps(); 
    });
}

function renderAbsenMonitor() {
    if(!curU || curU.r !== 'KEPSEK') return;
    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/absen/'+d).on('value', s => {
        const data = s.val() || {};
        let h = ''; let count = 0;
        for(let id in STAF_DATA) {
            if(STAF_DATA[id].r === 'KEPSEK') continue;
            const r = data[id] || {st:'BELUM', jam:'-'};
            if(r.st==='HADIR') count++;
            const waMsg = "Halo " + STAF_DATA[id].n + ", mohon lakukan Ceklok hari ini.";
            h += `<tr><td>${STAF_DATA[id].n}</td><td><span class="badge bg-${r.st==='HADIR'?'ok':'pending'}">${r.st}</span></td><td>${r.jam}</td><td>${r.loc || '-'}</td>
            <td><button onclick="sendWA('${STAF_DATA[id].wa}', '${waMsg}')" class="btn btn-red btn-xs">üì± WA</button></td></tr>`;
        }
        document.getElementById('tbl-k-abs').innerHTML = h;
        document.getElementById('sk-absen').innerText = count;
    });
}

function updateConfig() {
    const lat = document.getElementById('conf-lat').value;
    const lng = document.getElementById('conf-lng').value;
    if(!lat || !lng) return showInlineAlert("‚ö†Ô∏è Isi koordinat!");
    db.ref('schools/'+sch.npsn+'/config').update({ lat: lat, lng: lng })
    .then(() => showInlineAlert("‚úÖ Koordinat Diperbarui!"));
}

function addStudent() {
    const n = document.getElementById('gs-nama').value;
    const u = document.getElementById('gs-user').value;
    const p = document.getElementById('gs-pass').value;
    const k = document.getElementById('gs-kls').value;
    if(!n || !u) return showInlineAlert("‚ö†Ô∏è Isi Nama & Username!");
    db.ref('schools/'+sch.npsn+'/students/'+u).set({n, u, p, k});
    showInlineAlert("‚úÖ Siswa Terdaftar!");
    document.getElementById('gs-nama').value = '';
    document.getElementById('gs-user').value = '';
    document.getElementById('gs-pass').value = '';
}

function renderStudentTable() {
    let h = '';
    for(let id in SISWA_DATA) {
        h += `<tr><td>${id}</td><td>${SISWA_DATA[id].n}</td><td>${SISWA_DATA[id].k}</td><td>${SISWA_DATA[id].p}</td>
        <td><button class="btn btn-red btn-xs" onclick="delSiswa('${id}')">‚úï</button></td></tr>`;
    }
    document.getElementById('tbl-gs-list').innerHTML = h;
}

function delSiswa(id) { 
    if(confirm('Hapus Siswa?')) db.ref('schools/'+sch.npsn+'/students/'+id).remove(); 
}

function renderAbsenSiswa() {
    const kls = document.getElementById('ga-kls-sel').value;
    let h = '';
    for(let id in SISWA_DATA) {
        if(SISWA_DATA[id].k == kls) {
            h += `<tr><td>${SISWA_DATA[id].n}</td><td>${kls}</td>
            <td><select class="abs-sw-val" data-id="${id}"><option value="H">H</option><option value="S">S</option><option value="I">I</option><option value="A">A</option></select></td></tr>`;
        }
    }
    document.getElementById('tbl-ga-list').innerHTML = h;
}

function saveAbsenSiswa() {
    const kls = document.getElementById('ga-kls-sel').value;
    const d = new Date().toISOString().split('T')[0];
    let updates = {};
    document.querySelectorAll('.abs-sw-val').forEach(sel => { updates[sel.dataset.id] = sel.value; });
    db.ref('schools/'+sch.npsn+'/absen_siswa/'+d+'/'+kls).set({ guru: curU.n, data: updates }).then(() => showInlineAlert("‚úÖ Absensi Tersimpan!"));
}

function submitAgenda() {
    const mapel = document.getElementById('gag-mapel-sel').value;
    const elemen = document.getElementById('gag-elemen').value;
    const cp = document.getElementById('gag-cp').value; 
    const kompetensi = document.getElementById('gag-kompetensi').value;
    const lingkup = document.getElementById('gag-lingkup').value;
    const tp = document.getElementById('gag-tp').value;
    const d = new Date().toISOString().split('T')[0];
    
    if(!mapel || !elemen || !cp || !kompetensi || !lingkup || !tp) return showInlineAlert("‚ö†Ô∏è Isi semua elemen!");
    
    db.ref('schools/'+sch.npsn+'/agendas/'+d+'/'+curU.u).set({ 
        n: curU.n, 
        mapel: mapel,
        elemen: elemen, 
        cp: cp, 
        kompetensi: kompetensi, 
        lingkup: lingkup, 
        tp: tp, 
        st: 'PENDING', 
        tgl: d 
    }).then(() => {
        showInlineAlert("‚úÖ Agenda CP & TP Terkirim!"); 
        document.getElementById('gag-cp').value = '';
        document.getElementById('gag-elemen').value = '';
        document.getElementById('gag-mapel-sel').value = '';
        document.getElementById('gag-kompetensi').value = '';
        document.getElementById('gag-lingkup').value = '';
        document.getElementById('gag-tp').value = '';
    });
}

function submitModul() {
    const t = document.getElementById('gm-title').value; const m = document.getElementById('gm-mapel').value;
    const c = document.getElementById('gm-logic').value;
    if(!t || !m || !c) return showInlineAlert("‚ö†Ô∏è Isi semua field!");
    db.ref('schools/'+sch.npsn+'/moduls/'+Date.now()).set({ t, m, c, n: curU.n, st: 'PENDING' });
    showInlineAlert("‚úÖ Modul Dikirim!");
    document.getElementById('gm-title').value = '';
    document.getElementById('gm-mapel').value = '';
    document.getElementById('gm-logic').value = '';
}

function approveModul(id) { db.ref('schools/'+sch.npsn+'/moduls/'+id+'/st').set('OK'); showInlineAlert("‚úÖ Modul Disetujui!"); }

function toggleExType() {
    const ty = document.getElementById('ex-type').value;
    document.getElementById('ex-pg-ops').style.display = (ty === 'ES' ? 'none' : 'block');
}

function saveQuestion() {
    const q = document.getElementById('ex-q').value;
    const ty = document.getElementById('ex-type').value;
    const ans = document.getElementById('ex-ans').value;
    if(!q || !ans) return showInlineAlert("‚ö†Ô∏è Isi pertanyaan & jawaban!");
    const itm = { q, ty, ans };
    if(ty === 'PG') {
        const opts = [document.getElementById('ex-oa').value, document.getElementById('ex-ob').value, document.getElementById('ex-oc').value, document.getElementById('ex-od').value];
        if(opts.some(o => !o)) return showInlineAlert("‚ö†Ô∏è Isi semua opsi!");
        itm.opts = opts;
    }
    tempEx.push(itm);
    renderExTemp();
    document.getElementById('ex-q').value = '';
    document.getElementById('ex-ans').value = '';
    ['ex-oa', 'ex-ob', 'ex-oc', 'ex-od'].forEach(id => document.getElementById(id).value = '');
}

function renderExTemp() {
    let h = ''; 
    tempEx.forEach((x, i) => { 
        h += `<tr><td>${x.q.substring(0, 40)}...</td><td>${x.ty}</td><td>${x.ans}</td><td><button onclick="tempEx.splice(${i},1);renderExTemp()" class="btn btn-red btn-xs">‚úï</button></td></tr>`; 
    });
    document.getElementById('tbl-ex-list').innerHTML = h;
}

function publishExam() {
    const title = document.getElementById('ex-header').value;
    const jenis = document.getElementById('ex-jenis').value;
    const mapel = document.getElementById('ex-mapel').value;
    if(!title || tempEx.length === 0) return showInlineAlert("‚ö†Ô∏è Isi Judul & minimal 1 soal!");
    db.ref('schools/'+sch.npsn+'/exams/'+Date.now()).set({ title, jenis, mapel, q: tempEx, guru: curU.n });
    showInlineAlert("‚úÖ Ujian Dipublish!"); 
    tempEx = []; 
    renderExTemp();
    document.getElementById('ex-header').value = '';
}

function delExam(id) { if(confirm('Hapus Ujian?')) db.ref('schools/'+sch.npsn+'/exams/'+id).remove(); }

function loadExamAnswers() {
    const examId = document.getElementById('kor-exam-sel').value;
    if(!examId) {
        document.getElementById('kor-detail-area').style.display = 'none';
        return;
    }

    db.ref('schools/'+sch.npsn+'/exams/'+examId).once('value', s => {
        const exam = s.val();
        if(!exam) return;

        correctionState.examId = examId;
        document.getElementById('kor-exam-title').innerText = exam.title;
        document.getElementById('kor-exam-info').innerText = `${exam.jenis} - ${exam.mapel} | ${exam.q.length} soal`;
        
        let siswaSel = document.getElementById('kor-siswa-sel');
        siswaSel.innerHTML = '<option value="">-- Pilih Siswa --</option>';
        for(let id in SISWA_DATA) {
            siswaSel.innerHTML += `<option value="${id}">${SISWA_DATA[id].n}</option>`;
        }

        document.getElementById('kor-detail-area').style.display = 'block';
    });
}

function loadStudentAnswers() {
    const studentId = document.getElementById('kor-siswa-sel').value;
    if(!studentId) return;

    const examId = correctionState.examId;
    db.ref('schools/'+sch.npsn+'/exams/'+examId).once('value', s => {
        const exam = s.val();
        correctionState.studentId = studentId;
        correctionState.answers = [];

        let h = '';
        exam.q.forEach((q, idx) => {
            const qNum = idx + 1;
            h += `<div class="correction-item">
                <h5 style="margin:0 0 5px 0;">Soal ${qNum}: ${q.q.substring(0, 50)}...</h5>
                <p style="font-size:0.7rem; color:#64748b; margin:0 0 10px 0;">Tipe: ${q.ty === 'PG' ? 'PG' : 'Essay'}</p>`;

            if(q.ty === 'PG') {
                h += `<div style="background:#f8fafc; padding:10px; border-radius:8px; margin:10px 0; font-size:0.8rem;">
                    ${q.opts.map((opt, i) => `<p style="margin:4px 0;">‚Ä¢ ${String.fromCharCode(65+i)}) ${opt}</p>`).join('')}
                    <p style="font-weight:800; color:#10b981; margin-top:8px;">‚úì Kunci: ${q.ans}</p>
                </div>`;
                h += `<select class="kor-jawaban" data-idx="${idx}" style="width:100%; padding:8px; margin-bottom:10px;">
                    <option value="">Jawaban Siswa</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                </select>`;
            } else {
                h += `<textarea class="kor-jawaban" data-idx="${idx}" rows="2" placeholder="Jawaban siswa..." style="margin-bottom:10px;"></textarea>
                <p style="font-weight:800; font-size:0.7rem; color:#10b981;">‚úì Kata Kunci: ${q.ans}</p>`;
            }

            h += `<input type="number" class="kor-nilai" data-idx="${idx}" min="0" max="10" value="10" placeholder="Nilai (0-10)" style="width:100%; padding:8px;">
            </div>`;
        });

        document.getElementById('kor-questions-area').innerHTML = h;
        document.getElementById('kor-nilai-akhir').value = '0';
    });
}

function saveCorrection() {
    if(!correctionState.examId || !correctionState.studentId) return showInlineAlert("‚ö†Ô∏è Pilih ujian dan siswa!");

    let totalNilai = 0;
    document.querySelectorAll('.kor-nilai').forEach(inp => {
        totalNilai += parseInt(inp.value) || 0;
    });

    const nilaiAkhir = Math.min(totalNilai, 100);
    const status = document.getElementById('kor-status').value;

    db.ref('schools/'+sch.npsn+'/corrections/'+correctionState.examId+'/'+correctionState.studentId).set({
        siswa: SISWA_DATA[correctionState.studentId].n,
        kelas: SISWA_DATA[correctionState.studentId].k,
        nilaiAkhir: nilaiAkhir,
        status: status,
        tgl: new Date().toISOString().split('T')[0],
        jam: new Date().toLocaleTimeString('id-id'),
        dikoreksiOleh: curU.n
    }).then(() => {
        showInlineAlert(`‚úÖ Koreksi Tersimpan!\nNilai: ${nilaiAkhir} (${status})`);
        document.getElementById('kor-siswa-sel').value = '';
        document.getElementById('kor-questions-area').innerHTML = '';
    });
}

function fetchSiswaNilai() {
    const kls = document.getElementById('gn-kls').value;
    const mapel = document.getElementById('gn-mapel').value;
    if(!mapel) return;
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).once('value', snapshot => {
        const savedData = snapshot.val() || {};
        let h = '';
        for(let id in SISWA_DATA) {
            if(SISWA_DATA[id].k == kls) {
                const val = savedData[id] || {tp:0, sts1:0, sts2:0, sas:0, sat:0};
                h += `<tr><td>${SISWA_DATA[id].n}</td>
                    <td><input type="number" class="ni-tp" data-id="${id}" value="${val.tp}" style="width:100%; padding:6px;"></td>
                    <td><input type="number" class="ni-sts1" data-id="${id}" value="${val.sts1}" style="width:100%; padding:6px;"></td>
                    <td><input type="number" class="ni-sts2" data-id="${id}" value="${val.sts2}" style="width:100%; padding:6px;"></td>
                    <td><input type="number" class="ni-sas" data-id="${id}" value="${val.sas}" style="width:100%; padding:6px;"></td>
                    <td><input type="number" class="ni-sat" data-id="${id}" value="${val.sat}" style="width:100%; padding:6px;"></td></tr>`;
            }
        }
        document.getElementById('tbl-gn-list').innerHTML = h;
    });
}

function saveGrades() {
    const kls = document.getElementById('gn-kls').value;
    const mapel = document.getElementById('gn-mapel').value;
    const updates = {};
    document.querySelectorAll('#tbl-gn-list tr').forEach(row => {
        const tpInp = row.querySelector('.ni-tp');
        const id = tpInp.dataset.id;
        updates[id] = { 
            tp: tpInp.value, 
            sts1: row.querySelector('.ni-sts1').value, 
            sts2: row.querySelector('.ni-sts2').value, 
            sas: row.querySelector('.ni-sas').value,
            sat: row.querySelector('.ni-sat').value
        };
    });
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).update(updates).then(() => showInlineAlert("‚úÖ Nilai Tersinkron!"));
}

function renderReviewAgenda(data) {
    if(!curU || curU.r !== 'KEPSEK') return;
    let h = '';
    for(let uid in data) {
        let x = data[uid];
        h += `<tr><td>${x.tgl}</td><td>${x.n} / ${x.mapel}</td><td>${x.kompetensi}</td><td>${x.tp.substring(0, 40)}...</td><td><span class="badge bg-${x.st==='OK'?'ok':'pending'}">${x.st}</span></td>
        <td><button onclick="approveAgenda('${uid}')" class="btn btn-green btn-xs">‚úì Setuju</button></td></tr>`;
    }
    document.getElementById('tbl-k-rev-agenda').innerHTML = h;
}

function approveAgenda(uid) {
    const d = new Date().toISOString().split('T')[0];
    db.ref('schools/'+sch.npsn+'/agendas/'+d+'/'+uid+'/st').set('OK');
    showInlineAlert("‚úÖ Agenda CP & TP Disetujui!");
}

function renderRekap() {
    const kls = document.getElementById('kr-kls').value;
    const mapel = document.getElementById('kr-mapel').value;
    db.ref('schools/'+sch.npsn+'/grades/'+kls+'/'+mapel).once('value', s => {
        const data = s.val() || {};
        let h = '';
        for(let id in SISWA_DATA) {
            if(SISWA_DATA[id].k == kls) {
                const n = data[id] || {tp:0, sts1:0, sts2:0, sas:0, sat:0};
                const avg = (parseFloat(n.tp) + parseFloat(n.sts1) + parseFloat(n.sts2) + parseFloat(n.sas) + parseFloat(n.sat)) / 5;
                h += `<tr><td>${SISWA_DATA[id].n}</td><td>${kls}</td><td>${avg.toFixed(1)}</td>
                    <td><span class="badge ${avg >= 75 ? 'bg-ok' : 'bg-pending'}">${avg >= 75 ? 'TUNTAS' : 'REMEDIAL'}</span></td></tr>`;
            }
        }
        document.getElementById('tbl-k-rekap-body').innerHTML = h;
    });
}

function printRapor() {
    const content = document.getElementById('rekap-print-area').outerHTML;
    const printWin = window.open('', '_blank');
    printWin.document.write(`<html><head><title>Rapor</title><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background:#f0f0f0}</style></head><body>${content}</body></html>`);
    printWin.document.close();
    printWin.print();
}

function saveStaff() {
    const id = document.getElementById('ks-u').value;
    if(!id) return showInlineAlert("‚ö†Ô∏è Isi ID Akun!");
    const dat = { u: id, n: document.getElementById('ks-n').value, p: document.getElementById('ks-p').value, nip: document.getElementById('ks-nip').value, wa: document.getElementById('ks-wa').value, r: document.getElementById('ks-r').value };
    db.ref('schools/'+sch.npsn+'/staff/'+id).set(dat);
    showInlineAlert("‚úÖ Data Staf Disimpan!");
    document.getElementById('ks-n').value = '';
    document.getElementById('ks-nip').value = '';
    document.getElementById('ks-u').value = '';
    document.getElementById('ks-p').value = '';
    document.getElementById('ks-wa').value = '';
}

function renderStaffTable() {
    let h = ''; 
    for(let id in STAF_DATA) { 
        let x = STAF_DATA[id]; 
        h += `<tr><td>${x.n}</td><td>${x.u}</td><td>${x.p}</td><td>${x.wa}</td><td><button class="btn btn-red btn-xs" onclick="delStaf('${id}')">‚úï</button></td></tr>`; 
    }
    document.getElementById('tbl-ks-list').innerHTML = h;
}

function delStaf(id) { 
    if(confirm('Hapus Staf?')) db.ref('schools/'+sch.npsn+'/staff/'+id).remove(); 
}

function setRekapMapelByKelas() {
    const kls = document.getElementById('kr-kls').value;
    const sel = document.getElementById('kr-mapel');
    if(!sel) return;
    sel.innerHTML = '';
    let mapels = (kls <= 2) ? MAPEL_BY_LEVEL['GURU12'] : MAPEL_BY_LEVEL['GURU36'];
    mapels.forEach(m => { sel.innerHTML += `<option>${m}</option>`; });
}

function switchTab(id) {
    if(id.startsWith('k-') && curU.r !== 'KEPSEK') return showInlineAlert("‚ö†Ô∏è Akses Ditolak!");
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-'+id).classList.add('active');
    document.getElementById('v-title-label').innerText = id.replace('g-','').replace('k-','').toUpperCase();
    if(id === 'g-nilai') fetchSiswaNilai();
}

function sendWA(num, msg) { 
    window.open("https://wa.me/"+num+"?text="+encodeURIComponent(msg), '_blank'); 
}

function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; 
    const p1 = lat1 * Math.PI/180; 
    const p2 = lat2 * Math.PI/180;
    const dp = (lat2-lat1) * Math.PI/180; 
    const dl = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function showInlineAlert(msg) {
    const alertBox = document.createElement('div');
    alertBox.style.cssText = 'position:fixed;top:20px;right:20px;background:white;padding:15px 20px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.2);z-index:9999;font-weight:800;font-size:0.9rem;max-width:300px;animation:slideIn 0.3s ease-out';
    alertBox.innerHTML = msg;
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 3000);
}

setInterval(() => {
    const d = new Date();
    document.getElementById('d-clock-txt').innerText = d.toLocaleTimeString('id-id');
    document.getElementById('d-date-txt').innerText = d.toLocaleDateString('id-id', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('clk').innerText = d.toLocaleTimeString('id-id');
    document.querySelectorAll('.global-text-date').forEach(e => e.innerText = d.toLocaleDateString('id-id'));
    document.querySelectorAll('.global-date-inp').forEach(e => e.value = d.toLocaleDateString('id-id'));
}, 1000);

function toggleMenu() { 
    document.getElementById('sidebar').classList.toggle('show'); 
}
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cda469c941d4109',t:'MTc3MTA0ODA5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
