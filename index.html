<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #1e3a8a; --accent: #3b82f6; --success: #10b981; 
            --danger: #ef4444; --warning: #f59e0b; --dark: #1e293b; --white: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: var(--dark); display: flex; flex-direction: column; min-height: 100vh; }
        .navbar { background: var(--primary); color: white; padding: 25px; text-align: center; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; border-bottom: 4px solid var(--accent); }
        .container { padding: 30px; max-width: 1300px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .menu-card { background: var(--white); padding: 35px 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .menu-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .menu-card .icon { font-size: 50px; margin-bottom: 15px; }
        .tab-content { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; border-top: 5px solid var(--accent); }
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn-blue { background: var(--accent); } .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-orange { background: var(--warning); } .btn-dark { background: var(--dark); }
        .form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: flex-end; }
        .field { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
        label { font-size: 11px; font-weight: 800; margin-bottom: 5px; color: #64748b; }
        input, select, textarea { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .table-res { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 12px; color: var(--primary); font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .hidden-form { display: none; margin-top: 20px; padding: 15px; border: 2px dashed #3b82f6; border-radius: 12px; }
        .history-container { display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #cbd5e1; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        
        .semester-switcher { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .sem-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--accent); cursor: pointer; background: white; color: var(--accent); font-weight: bold; }
        .sem-btn.active { background: var(--accent); color: white; }

        .profile-photo-container { text-align: center; margin-bottom: 20px; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; background: #e2e8f0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--accent); }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .admin-wa-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #cbd5e1; margin-top: 15px; }

        #modalCeklok {
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
            z-index: 2000; text-align: center; width: 320px;
        }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }

        @media print {
            .navbar, .btn, .btn-group, .form-group, .dashboard-grid, .no-print, #back-area, .btn-orange, .btn-green, .semester-switcher { display: none !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            #print-footer { display: block !important; margin-top: 40px; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            body { background: white; }
            table { font-size: 10px; width: 100%; border: 1px solid #000 !important; }
            th, td { border: 1px solid #000 !important; }
            .print-footer-table { width: 100%; border: none !important; margin-top: 30px; }
            .print-footer-table td { border: none !important; text-align: center; width: 50% !important; vertical-align: top; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="overlayCeklok"></div>
<div id="modalCeklok">
    <span style="font-size: 50px;">üìç</span>
    <h4>PRESENSI GURU</h4>
    <p id="statusLokasi" style="font-size: 12px; color: #64748b;">Mendeteksi lokasi Anda...</p>
    <div id="infoWaktu" style="margin-bottom: 15px; font-weight: bold; color: var(--primary);"></div>
    <button id="btnKirimAbsen" disabled onclick="submitCeklok()" class="btn btn-green" style="width: 100%; justify-content: center; padding: 15px;">CEKLOK SEKARANG</button>
    <button onclick="submitIzinSakit()" class="btn btn-orange" style="width: 100%; justify-content: center; padding: 10px; margin-top: 5px;">LAPOR IZIN / SAKIT</button>
    <button onclick="closeModalCeklok()" style="margin-top: 15px; background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold;">TUTUP</button>
</div>

<div id="print-header" style="display:none;">
    <h1 id="pSekolah">NAMA SEKOLAH</h1>
    <h2 id="pTitle">LAPORAN CAPAIAN HASIL BELAJAR</h2>
    <hr>
</div>

<div class="navbar">
    <h2 id="main-title" style="cursor: pointer;">üöÄ ADMINISTRASI SD NEGERI MAJALENGKA WETAN VIII</h2>
</div>

<div class="container">
    <div id="tab-login" class="tab-content" style="display: block;">
        <h3 style="text-align:center">Silakan Pilih Akun:</h3>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="selectRole('GK1', 'üè´ KELAS 1', 'SITI ROKAYAH,S.Pd')"><span class="icon">üè´</span><h3>KELAS 1</h3><p>SITI ROKAYAH,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK2', 'üè´ KELAS 2', 'VIKA NURATIKA,S.Pd')"><span class="icon">üè´</span><h3>KELAS 2</h3><p>VIKA NURATIKA,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK3', 'üè´ KELAS 3', 'RISKA WIDIA ROSANA,S.PD')"><span class="icon">üè´</span><h3>KELAS 3</h3><p>RISKA WIDIA ROSANA,S.PD</p></div>
            <div class="menu-card" onclick="selectRole('GK4', 'üè´ KELAS 4', 'DEDE YUDIASTUTI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 4</h3><p>DEDE YUDIASTUTI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('GK5', 'üè´ KELAS 5', 'SILVYRA RISMAWATI,S.Pd.SD')"><span class="icon">üè´</span><h3>KELAS 5</h3><p>SILVYRA RISMAWATI,S.Pd.SD</p></div>
            <div class="menu-card" onclick="selectRole('GK6', 'üè´ KELAS 6', 'ESIH IMAWATI,S.Pd')"><span class="icon">üè´</span><h3>KELAS 6</h3><p>ESIH IMAWATI,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PJOK', 'üèÉ‚Äç‚ôÇÔ∏è GURU PJOK', 'INDRA SETIAWAN,S.Pd')"><span class="icon">üèÉ‚Äç‚ôÇÔ∏è</span><h3>GURU PJOK</h3><p>INDRA SETIAWAN,S.Pd</p></div>
            <div class="menu-card" onclick="selectRole('PAI', 'üïå GURU PAI', 'YATI NOVIYATI,S.Pd.I')"><span class="icon">üïå</span><h3>GURU PAI</h3><p>YATI NOVIYATI,S.Pd.I</p></div>
            <div class="menu-card" onclick="selectRole('KEPSEK', 'üë®‚Äçüíº KEPALA SEKOLAH', 'KARYADI, S.Pd')" style="background: #fdf2f2;"><span class="icon">üë®‚Äçüíº</span><h3>KEPALA SEKOLAH</h3><p>KARYADI, S.Pd</p></div>
        </div>
    </div>

    <div id="back-area" style="display: none; margin-bottom: 20px;">
        <button class="btn btn-dark" onclick="switchTab('tab-home')">üè† MENU UTAMA</button>
        <button class="btn btn-red" onclick="location.reload()">üö™ GANTI AKUN</button>
    </div>

    <div id="tab-home" class="tab-content">
        <div class="dashboard-grid" id="guru-menu">
            <div class="menu-card" onclick="openModalCeklok()" style="background: #f0fdf4; border: 2px solid var(--success);"><span class="icon">üìç</span><h4>CEKLOK ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>IDENTITAS</h4></div>
            <div class="menu-card" onclick="switchTab('tab-siswa')"><span class="icon">üë•</span><h4>SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-master')"><span class="icon">üéØ</span><h4>CP, TP, ATP</h4></div>
            <div class="menu-card" onclick="switchTab('tab-modul')"><span class="icon">üìñ</span><h4>MODUL AJAR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-agenda')"><span class="icon">üìù</span><h4>AGENDA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-absensi')"><span class="icon">‚úÖ</span><h4>ABSENSI SISWA</h4></div>
            <div class="menu-card" onclick="switchTab('tab-rekap-absen')"><span class="icon">üìä</span><h4>REKAP ABSEN</h4></div>
            <div class="menu-card" onclick="switchTab('tab-raport')"><span class="icon">üìú</span><h4>RAPOR & NILAI</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kegiatan')"><span class="icon">üèÜ</span><h4>EKSKUL/KOKUL</h4></div>
            <div class="menu-card" onclick="switchTab('tab-kosp')"><span class="icon">üìÇ</span><h4>KOSP & LINK</h4></div>
        </div>
        <div class="dashboard-grid" id="kepsek-menu" style="display: none;">
            <div class="menu-card" onclick="renderMonitorAgenda()"><span class="icon">üìã</span><h4>PERSETUJUAN AGENDA</h4></div>
            <div class="menu-card" onclick="renderMonitorKegiatan()"><span class="icon">üèÜ</span><h4>PERSETUJUAN KEGIATAN</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenGuru()"><span class="icon">üë®‚Äçüè´</span><h4>PRESENSI GURU</h4></div>
            <div class="menu-card" onclick="renderMonitorAbsenSiswa()"><span class="icon">üìä</span><h4>MONITOR ABSEN SISWA</h4></div>
            <div class="menu-card" onclick="renderMonitorLinkGuru()"><span class="icon">üìÇ</span><h4>DOKUMEN & CP/TP</h4></div>
            <div class="menu-card" onclick="renderMonitorNilai()"><span class="icon">üìú</span><h4>MONITOR NILAI & RAPOR</h4></div>
            <div class="menu-card" onclick="switchTab('tab-setup')"><span class="icon">‚öôÔ∏è</span><h4>PENGATURAN KEPSEK</h4></div>
            
            <div id="super-admin-only" style="display: none; grid-column: 1 / -1;">
                <div class="menu-card" onclick="superAdminResetDatabase()" style="background: #fee2e2; border: 2px solid var(--danger);">
                    <span class="icon">‚ö†Ô∏è</span>
                    <h4 style="color: var(--danger);">RESET TOTAL DATABASE</h4>
                    <p style="font-size: 11px;">Hapus seluruh data sistem (Developer Only)</p>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-setup" class="tab-content">
        <div class="card">
            <h3>‚öôÔ∏è Identitas & Foto Profil</h3>
            <div class="profile-photo-container">
                <div class="photo-preview" id="photo-preview-box">
                    <span id="photo-placeholder">üì∏ No Photo</span>
                    <img id="photo-img" src="" style="display:none;">
                </div>
                <input type="file" id="input-foto" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this)">
                <button class="btn btn-dark" onclick="document.getElementById('input-foto').click()">üì§ UPLOAD FOTO PROFIL</button>
            </div>
            <div class="form-group"><div class="field"><label>Nama Sekolah</label><input type="text" id="sSekolah"></div></div>
            <div class="form-group">
                <div class="field"><label>Nama Pengguna</label><input type="text" id="sGuru"></div>
                <div class="field"><label>NIP Pengguna</label><input type="text" id="snipGuru"></div>
                <div class="field"><label>WA Pribadi (628...)</label><input type="text" id="sWaGuru" placeholder="62812345678"></div>
            </div>
            <div id="kepsek-wa-management" class="admin-wa-box" style="display:none;">
                <h4>üõ†Ô∏è Panel Admin: Atur Nomor HP Guru</h4>
                <div id="list-wa-guru-inputs"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Nama Kepala Sekolah</label><input type="text" id="sKepsek"></div>
                <div class="field"><label>NIP Kepala Sekolah</label><input type="text" id="snipKepsek"></div>
                <div class="field"><label>WA Kepsek (628...)</label><input type="text" id="sWaKepsek" placeholder="62812345678"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="saveSetup()">üíæ SIMPAN PERUBAHAN</button>
            </div>
        </div>
    </div>

    <div id="tab-kepsek" class="tab-content">
        <div class="card">
            <h3 id="monitor-title">Monitoring</h3>
            <div id="area-monitor-kepsek"></div>
        </div>
    </div>

    <div id="tab-raport" class="tab-content">
        <div class="card">
            <h3>üìú Input Nilai & Rapor</h3>
            <div class="semester-switcher">
                <button id="btnSem1" class="sem-btn active" onclick="setSemester(1)">SEMESTER 1 (GANJIL)</button>
                <button id="btnSem2" class="sem-btn" onclick="setSemester(2)">SEMESTER 2 (GENAP)</button>
            </div>
            <div class="form-group">
                <div class="field"><label>Pilih Kelas</label><select id="rpKls" onchange="updateMapelFilter('rpMapel', this.value); renderRaport()"></select></div>
                <div class="field"><label>Pilih Mata Pelajaran</label><select id="rpMapel" onchange="renderRaport()"></select></div>
            </div>
            <button class="btn btn-green" onclick="window.print()">üñ®Ô∏è CETAK RAPOR</button>
            <div class="table-res"><table><thead id="headRaport"></thead><tbody id="bodyRaport"></tbody></table></div>
        </div>
    </div>

    <div id="tab-master" class="tab-content">
        <div class="card">
            <h3>üéØ Master CP, TP, ATP</h3>
            <div class="form-group">
                <div class="field"><label>Pilih Kelas</label><select id="masterKls" onchange="updateMapelFilter('masterMapel', this.value); renderSemuaMaster()"></select></div>
                <div class="field"><label>Pilih Mata Pelajaran</label><select id="masterMapel" onchange="renderSemuaMaster()"></select></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="showMasterForm('formCP')">‚ûï CP</button>
                <button class="btn btn-green" onclick="showMasterForm('formTP')">‚ûï TP</button>
                <button class="btn btn-orange" onclick="showMasterForm('formATP')">‚ûï ATP</button>
                <button class="btn btn-dark" onclick="toggleVisibility('history-master')">üëÅÔ∏è LIHAT RIWAYAT</button>
            </div>
            <div id="formCP" class="hidden-form">
                <h4>A. Capaian Pembelajaran (CP)</h4>
                <div class="form-group"><div class="field"><label>Elemen</label><input type="text" id="cpElemen"></div><div class="field" style="flex:2"><label>Isi CP</label><input type="text" id="cpIsi"></div><div class="field"><label>Kompetensi</label><input type="text" id="cpKompetensi"></div><div class="field"><label>Konten</label><input type="text" id="cpKonten"></div><button class="btn btn-blue" onclick="saveMaster('CP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formTP" class="hidden-form">
                <h4>B. Tujuan Pembelajaran (TP)</h4>
                <div class="form-group"><div class="field"><label>Kode TP</label><input type="text" id="tpKode"></div><div class="field" style="flex:2"><label>Isi TP</label><input type="text" id="tpIsi"></div><div class="field"><label>KKTP</label><input type="text" id="tpKktp"></div><button class="btn btn-green" onclick="saveMaster('TP')">üíæ SIMPAN</button></div>
            </div>
            <div id="formATP" class="hidden-form">
                <h4>C. Alur Tujuan Pembelajaran (ATP)</h4>
                <div class="form-group"><div class="field" style="flex:2"><label>Isi ATP</label><input type="text" id="atpIsi"></div><div class="field"><label>Waktu</label><input type="text" id="atpWaktu"></div><div class="field"><label>Dimensi PPP</label><input type="text" id="atpDimensi"></div><div class="field"><label>Asesmen</label><input type="text" id="atpAsesmen"></div><button class="btn btn-orange" onclick="saveMaster('ATP')">üíæ SIMPAN</button></div>
            </div>
            <div id="history-master" class="history-container">
                <div class="table-res"><table><thead><tr><th>Elemen</th><th>CP</th><th>Kompetensi</th><th>Konten</th><th>AKSI</th></tr></thead><tbody id="bodyCPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>Kode TP</th><th>TP</th><th>KKTP</th><th>AKSI</th></tr></thead><tbody id="bodyTPNew"></tbody></table></div>
                <div class="table-res"><table><thead><tr><th>No</th><th>ATP</th><th>Waktu</th><th>Asesmen</th><th>AKSI</th></tr></thead><tbody id="bodyATPNew"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-siswa" class="tab-content">
        <div class="card">
            <h3>üë• Data Siswa</h3>
            <div class="form-group">
                <div class="field"><label>Kelas</label><select id="swKls" onchange="renderSiswa()"></select></div>
                <div class="field"><label>NISN</label><input type="text" id="swNisn"></div>
                <div class="field"><label>NIS</label><input type="text" id="swNis"></div>
                <div class="field"><label>Nama</label><input type="text" id="swNama"></div>
                <button class="btn btn-blue" onclick="saveSiswa()">‚ûï TAMBAH</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-green" onclick="exportSiswaExcel()">üìä EKSPOR EXCEL</button>
                <button class="btn btn-dark" onclick="toggleVisibility('history-siswa')">üëÅÔ∏è LIHAT DATA</button>
            </div>
            <div id="history-siswa" class="history-container">
                <div class="table-res"><table><thead><tr><th>NO</th><th>NISN</th><th>NIS</th><th>NAMA</th><th class="no-print">AKSI</th></tr></thead><tbody id="bodySiswa"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="tab-modul" class="tab-content">
        <div class="card">
            <h3>üìñ Modul Ajar</h3>
            <div class="form-group">
                <div class="field"><label>Kelas</label><select id="mdKls" onchange="updateMapelFilter('mdMapel', this.value); updateMdTP();"></select></div>
                <div class="field"><label>Mata Pelajaran</label><select id="mdMapel" onchange="updateMdTP()"></select></div>
                <div class="field"><label>Pilih TP</label><select id="mdTP" onchange="loadModulDetail()"></select></div>
            </div>
            <div class="card" style="background: #f8fafc;">
                <div class="form-group"><div class="field"><label>Alokasi Waktu</label><input type="text" id="mdWaktu"></div><div class="field"><label>Metode</label><input type="text" id="mdMetode"></div></div>
                <div class="field"><label>Langkah-Langkah</label><textarea id="mdLangkah" rows="8"></textarea></div>
                <div class="form-group"><div class="field"><label>Media</label><input type="text" id="mdMedia"></div><div class="field"><label>Asesmen</label><input type="text" id="mdAsesmen"></div></div>
                <button class="btn btn-blue" onclick="saveModul()" style="width:100%">üíæ SIMPAN MODUL</button>
            </div>
        </div>
    </div>

    <div id="tab-agenda" class="tab-content">
        <div class="card">
            <h3>üìù Agenda Harian</h3>
            <div class="form-group">
                <div class="field"><label>Kelas</label><select id="agKls" onchange="updateMapelFilter('agMapel', this.value); updateAgTP(); renderAgenda();"></select></div>
                <div class="field"><label>Mata Pelajaran</label><select id="agMapel" onchange="updateAgTP()"></select></div>
                <div class="field"><label>Tanggal</label><input type="date" id="agTgl"></div>
                <div class="field"><label>TP</label><select id="agTP"></select></div>
                <div class="field"><label>Materi</label><input type="text" id="agMateri"></div>
                <div class="field"><label>Foto (Opsional)</label><input type="file" id="agFoto" accept="image/*" onchange="processAgendaPhoto(this)"></div>
                <button class="btn btn-blue" onclick="saveAgenda()">üíæ SIMPAN</button>
            </div>
            <div class="table-res"><table><thead><tr><th>TGL</th><th>TP</th><th>MATERI</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead><tbody id="bodyAgenda"></tbody></table></div>
        </div>
    </div>

    <div id="tab-absensi" class="tab-content">
        <div class="card">
            <h3>‚úÖ Absensi Harian Siswa</h3>
            <div class="form-group">
                <select id="abKls" onchange="renderAbsensi()"></select>
                <input type="date" id="abTgl" onchange="renderAbsensi()">
            </div>
            <div class="table-res"><table><thead><tr><th>NO</th><th>NAMA</th><th>STATUS</th></tr></thead><tbody id="bodyAbsensi"></tbody></table></div>
        </div>
    </div>

    <div id="tab-rekap-absen" class="tab-content">
        <div class="card">
            <h3>üìä Rekap Bulanan</h3>
            <div class="form-group">
                <select id="rekKls" onchange="renderRekapAbsen()"></select>
                <input type="month" id="rekBulan" onchange="renderRekapAbsen()">
            </div>
            <div class="table-res"><table><thead id="headRekap"></thead><tbody id="bodyRekap"></tbody></table></div>
        </div>
    </div>

    <div id="tab-kegiatan" class="tab-content">
        <div class="card">
            <h3>üèÜ Kegiatan Ekstrakulikuler & Kokulikuler</h3>
            <div class="form-group">
                <div class="field"><label>Jenis</label><select id="kgJenis"><option value="Ekstrakulikuler">Ekstrakulikuler</option><option value="Kokulikuler">Kokulikuler</option></select></div>
                <div class="field"><label>Nama Kegiatan</label><input type="text" id="kgNama"></div>
                <div class="field"><label>Tanggal</label><input type="date" id="kgTgl"></div>
            </div>
            <div class="form-group">
                <div class="field"><label>Deskripsi</label><textarea id="kgKet"></textarea></div>
                <div class="field"><label>Foto Kegiatan</label><input type="file" id="kgFoto" accept="image/*" onchange="processKegiatanPhoto(this)"></div>
            </div>
            <button class="btn btn-blue" onclick="saveKegiatan()">üíæ AJUKAN KE KEPSEK</button>
            <div class="table-res" style="margin-top:15px;">
                <table><thead><tr><th>JENIS</th><th>NAMA</th><th>TGL</th><th>FOTO</th><th>STATUS</th><th>AKSI</th></tr></thead>
                <tbody id="bodyKegiatan"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-kosp" class="tab-content">
        <div class="card">
            <h3>üìÇ Link Dokumen KOSP & Perangkat</h3>
            <div class="form-group">
                <div class="field"><label>Nama Dokumen</label><input type="text" id="ksNama" placeholder="KOSP / Prota / Promes"></div>
                <div class="field"><label>Link URL Drive</label><input type="text" id="ksLink"></div>
                <button class="btn btn-blue" onclick="saveKosp()">üîó SIMPAN LINK</button>
            </div>
            <div class="table-res"><table><thead><tr><th>DOKUMEN</th><th>LINK</th><th>AKSI</th></tr></thead><tbody id="bodyKosp"></tbody></table></div>
        </div>
    </div>

    <div id="print-footer" style="display:none;">
        <table class="print-footer-table">
            <tr>
                <td>Mengetahui,<br>Kepala Sekolah<br><br><br><br><b id="fKepsek">KARYADI, S.Pd</b><br>NIP. <span id="fnipKepsek"></span></td>
                <td><span id="fTanggal"></span><br><span id="fRoleLabel">Guru</span><br><br><br><br><b id="fGuru"></b><br>NIP. <span id="fnipGuru"></span></td>
            </tr>
        </table>
    </div>
</div>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBDSZ5mBwxiMHem5gNBpD8lSKYqSoCFxOQ",
        authDomain: "adminsitrasi-guru-de394.firebaseapp.com",
        databaseURL: "https://adminsitrasi-guru-de394-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "adminsitrasi-guru-de394",
        storageBucket: "adminsitrasi-guru-de394.firebasestorage.app",
        messagingSenderId: "1056567544540",
        appId: "1:1056567544540:web:d612d0c9eccb758c87c219"
    };

    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    let currentRole = '';
    let currentSemester = 1;
    let db = { cfg:{}, siswa:[], cp:[], agenda:[], absensi:{}, nilai:{}, modul:[], kegiatan:[], kosp:[] };
    let tempAgendaPhoto = "";
    let tempKegiatanPhoto = "";
    
    const SEKO_LAT = -6.8352517; 
    const SEKO_LNG = 108.2408433;
    const MAX_DISTANCE = 100;

    const mapelData = {
        rendah: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda"],
        tinggi: ["Pendidikan Pancasila", "Matematika", "B.Indonesia", "SBDP", "Bahasa Sunda", "IPAS", "B.Inggris"]
    };

    const allGurus = [
        {id: 'GK1', nama: 'SITI ROKAYAH,S.Pd', pw: '12345'},
        {id: 'GK2', nama: 'VIKA NURATIKA,S.Pd', pw: '12345'},
        {id: 'GK3', nama: 'RISKA WIDIA ROSANA,S.PD', pw: '12345'},
        {id: 'GK4', nama: 'DEDE YUDIASTUTI,S.Pd', pw: '12345'},
        {id: 'GK5', nama: 'SILVYRA RISMAWATI,S.Pd.SD', pw: '12345'},
        {id: 'GK6', nama: 'ESIH IMAWATI,S.Pd', pw: '12345'},
        {id: 'PJOK', nama: 'INDRA SETIAWAN,S.Pd', pw: '12345'},
        {id: 'PAI', nama: 'YATI NOVIYATI,S.Pd.I', pw: '12345'},
        {id: 'KEPSEK', nama: 'KARYADI, S.Pd', pw: 'admin2026'},
        {id: 'SUPER_ADMIN', nama: 'DEVELOPER / ADMIN PUSAT', pw: 'super2026'}
    ];

    function updateMapelFilter(elementId, kls) {
        const select = document.getElementById(elementId);
        if(!select) return;
        let list = [];
        if(currentRole === 'PJOK') list = ["PJOK"];
        else if(currentRole === 'PAI') list = ["PAI"];
        else list = (kls == 1 || kls == 2) ? mapelData.rendah : mapelData.tinggi;
        select.innerHTML = list.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function filterKelasBerdasarkanRole(role) {
        const listSelectKelas = ['rpKls', 'masterKls', 'swKls', 'mdKls', 'agKls', 'abKls', 'rekKls'];
        listSelectKelas.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            if (role.startsWith('GK')) {
                const klsTujuan = role.replace('GK', ''); 
                select.innerHTML = `<option value="${klsTujuan}">Kelas ${klsTujuan}</option>`;
                select.disabled = true; 
            } else {
                select.innerHTML = `<option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option>`;
                select.disabled = false;
            }
        });
    }

    function selectRole(role, title, name) {
        const guruData = allGurus.find(g => g.id === role);
        const inputPw = prompt(`Ketik Password untuk ${name}:`);
        if (inputPw !== guruData.pw) { alert("Password Salah!"); return; }

        currentRole = role;
        document.getElementById('main-title').innerText = title + " - " + name;
        
        const gMenu = document.getElementById('guru-menu');
        const kMenu = document.getElementById('kepsek-menu');
        const sBtn = document.getElementById('super-admin-only');

        if(role === 'SUPER_ADMIN') {
            gMenu.style.display = 'grid';
            kMenu.style.display = 'grid';
            sBtn.style.display = 'block';
            filterKelasBerdasarkanRole('ALL');
            loadDB("SUPER ADMIN");
        } else if(role === 'KEPSEK') {
            gMenu.style.display = 'none';
            kMenu.style.display = 'grid';
            sBtn.style.display = 'none';
            filterKelasBerdasarkanRole(role);
            loadDB(name);
        } else {
            gMenu.style.display = 'grid';
            kMenu.style.display = 'none';
            sBtn.style.display = 'none';
            filterKelasBerdasarkanRole(role);
            loadDB(name);
        }
        switchTab('tab-home');
    }

    function loadDB(name) {
        const path = 'sekolah_wetan/' + currentRole.toLowerCase();
        rtdb.ref(path).on('value', (snapshot) => {
            const data = snapshot.val();
            db = data || { cfg: { guru: name }, siswa: [], cp: [], agenda: [], absensi: {}, nilai: {}, modul: [], kegiatan:[], kosp:[] };
            fillSetupForm();
        });
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.getElementById('back-area').style.display = (id === 'tab-login' ? 'none' : 'block');
    }

    // --- FUNGSI SUPER ADMIN ---
    function superAdminResetDatabase() {
        if (currentRole !== 'SUPER_ADMIN') return;
        const konfirmasi1 = confirm("‚ö†Ô∏è PERINGATAN!\n\nAnda akan menghapus SELURUH data sistem (Siswa, Nilai, Agenda, dan Presensi).\n\nLanjutkan?");
        if (konfirmasi1) {
            const konfirmasi2 = prompt("Ketik 'HAPUS SEMUA' untuk konfirmasi:");
            if (konfirmasi2 === "HAPUS SEMUA") {
                Promise.all([
                    rtdb.ref('sekolah_wetan').remove(),
                    rtdb.ref('presensi_guru').remove()
                ]).then(() => {
                    alert("Database berhasil dikosongkan.");
                    location.reload();
                });
            }
        }
    }

    // Klik Judul 5x untuk Super Admin
    let clickCount = 0;
    document.getElementById('main-title').addEventListener('click', function() {
        clickCount++;
        if (clickCount === 5) {
            selectRole('SUPER_ADMIN', '‚ö° SUPER ADMIN', 'ADMIN PUSAT');
            clickCount = 0;
        }
    });

    // --- FUNGSI MONITORING KEPALA SEKOLAH ---

    function renderMonitorAgenda() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üìã Persetujuan Agenda Harian';
        const area = document.getElementById('area-monitor-kepsek');
        area.innerHTML = "Sedang memuat...";

        rtdb.ref('sekolah_wetan').once('value', snapshot => {
            const allData = snapshot.val();
            let html = '<div class="table-res"><table><thead><tr><th>GURU</th><th>MAPEL</th><th>TGL</th><th>MATERI</th><th>STATUS</th><th>AKSI</th></tr></thead><tbody>';
            let found = false;

            for(let key in allData) {
                if(allData[key].agenda) {
                    allData[key].agenda.forEach((a, index) => {
                        found = true;
                        const statusColor = a.status === '‚úÖ Disetujui' ? 'green' : 'orange';
                        html += `<tr>
                            <td>${allData[key].cfg.guru || key}</td>
                            <td>${a.mapel}</td>
                            <td>${a.tgl}</td>
                            <td>${a.materi}</td>
                            <td style="color:${statusColor}"><b>${a.status}</b></td>
                            <td>
                                ${a.status !== '‚úÖ Disetujui' ? `<button class="btn btn-green" onclick="approveAgenda('${key}', ${index})">Setujui</button>` : '-'}
                            </td>
                        </tr>`;
                    });
                }
            }
            if(!found) html += '<tr><td colspan="6">Belum ada agenda yang diajukan.</td></tr>';
            area.innerHTML = html + '</tbody></table></div>';
        });
    }

    function approveAgenda(guruKey, index) {
        rtdb.ref(`sekolah_wetan/${guruKey}/agenda/${index}/status`).set('‚úÖ Disetujui')
        .then(() => { alert('Agenda Disetujui!'); renderMonitorAgenda(); });
    }

    function renderMonitorKegiatan() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üèÜ Persetujuan Kegiatan Ekskul/Kokul';
        const area = document.getElementById('area-monitor-kepsek');
        
        rtdb.ref('sekolah_wetan').once('value', snapshot => {
            const allData = snapshot.val();
            let html = '<div class="table-res"><table><thead><tr><th>GURU</th><th>NAMA KEGIATAN</th><th>TGL</th><th>STATUS</th><th>AKSI</th></tr></thead><tbody>';
            for(let key in allData) {
                if(allData[key].kegiatan) {
                    allData[key].kegiatan.forEach((k, idx) => {
                        html += `<tr>
                            <td>${allData[key].cfg.guru}</td>
                            <td>${k.nama}</td>
                            <td>${k.tgl}</td>
                            <td>${k.status}</td>
                            <td><button class="btn btn-green" onclick="approveKegiatan('${key}', ${idx})">Setujui</button></td>
                        </tr>`;
                    });
                }
            }
            area.innerHTML = html + '</tbody></table></div>';
        });
    }

    function approveKegiatan(guruKey, idx) {
        rtdb.ref(`sekolah_wetan/${guruKey}/kegiatan/${idx}/status`).set('‚úÖ Disetujui')
        .then(() => { alert('Kegiatan Disetujui!'); renderMonitorKegiatan(); });
    }

    function renderMonitorAbsenGuru() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üë®‚Äçüè´ Presensi Guru Hari Ini';
        const area = document.getElementById('area-monitor-kepsek');
        const tgl = new Date().toISOString().split('T')[0];

        rtdb.ref(`presensi_guru/${tgl}`).on('value', snap => {
            const data = snap.val() || {};
            let html = '<div class="table-res"><table><thead><tr><th>GURU</th><th>STATUS</th><th>WAKTU</th><th>KET</th></tr></thead><tbody>';
            allGurus.forEach(g => {
                if(g.id === 'KEPSEK' || g.id === 'SUPER_ADMIN') return;
                const h = data[g.id] || { status: 'üî¥ Belum Hadir', waktu: '-', ket: '-' };
                html += `<tr><td>${g.nama}</td><td><b>${h.status}</b></td><td>${h.waktu}</td><td>${h.ket}</td></tr>`;
            });
            area.innerHTML = html + '</tbody></table></div>';
        });
    }

    function renderMonitorAbsenSiswa() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üìä Monitor Absen Siswa (Global)';
        const area = document.getElementById('area-monitor-kepsek');
        area.innerHTML = `<div class="card">Data detail absen siswa dapat diakses melalui rekap kelas masing-masing.</div>`;
    }

    function renderMonitorLinkGuru() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üìÇ Dokumen KOSP & Perangkat Guru';
        const area = document.getElementById('area-monitor-kepsek');
        
        rtdb.ref('sekolah_wetan').once('value', snap => {
            const all = snap.val();
            let html = '<div class="table-res"><table><thead><tr><th>GURU</th><th>NAMA DOKUMEN</th><th>AKSI</th></tr></thead><tbody>';
            for(let key in all) {
                if(all[key].kosp) {
                    all[key].kosp.forEach(k => {
                        html += `<tr><td>${all[key].cfg.guru}</td><td>${k.nama}</td><td><a href="${k.link}" target="_blank" class="btn btn-blue">Buka Drive</a></td></tr>`;
                    });
                }
            }
            area.innerHTML = html + '</tbody></table></div>';
        });
    }

    function renderMonitorNilai() {
        switchTab('tab-kepsek');
        document.getElementById('monitor-title').innerText = 'üìú Monitor Nilai & Rapor';
        const area = document.getElementById('area-monitor-kepsek');
        area.innerHTML = `<p>Monitoring input nilai secara terpusat.</p>`;
    }

    // --- FUNGSI IDENTITAS ---
    function fillSetupForm() {
        document.getElementById('sSekolah').value = db.cfg.sekolah || '';
        document.getElementById('sGuru').value = db.cfg.guru || '';
        document.getElementById('snipGuru').value = db.cfg.nipGuru || '';
        document.getElementById('sWaGuru').value = db.cfg.waGuru || '';
        document.getElementById('sKepsek').value = db.cfg.kepsek || '';
        document.getElementById('snipKepsek').value = db.cfg.nipKepsek || '';
        document.getElementById('sWaKepsek').value = db.cfg.waKepsek || '';
        if(db.cfg.foto) {
            document.getElementById('photo-img').src = db.cfg.foto;
            document.getElementById('photo-img').style.display = 'block';
            document.getElementById('photo-placeholder').style.display = 'none';
        }
    }

    function saveSetup() {
        db.cfg.sekolah = document.getElementById('sSekolah').value;
        db.cfg.guru = document.getElementById('sGuru').value;
        db.cfg.nipGuru = document.getElementById('snipGuru').value;
        db.cfg.waGuru = document.getElementById('sWaGuru').value;
        db.cfg.kepsek = document.getElementById('sKepsek').value;
        db.cfg.nipKepsek = document.getElementById('snipKepsek').value;
        db.cfg.waKepsek = document.getElementById('sWaKepsek').value;
        rtdb.ref('sekolah_wetan/' + currentRole.toLowerCase()).set(db).then(() => alert('Tersimpan!'));
    }

    function previewProfilePhoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('photo-img').src = e.target.result;
                document.getElementById('photo-img').style.display = 'block';
                document.getElementById('photo-placeholder').style.display = 'none';
                db.cfg.foto = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- FUNGSI CEKLOK ---
    function openModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'block';
        document.getElementById('modalCeklok').style.display = 'block';
        const skrg = new Date();
        document.getElementById('infoWaktu').innerText = "Waktu: " + skrg.getHours().toString().padStart(2,'0') + ":" + skrg.getMinutes().toString().padStart(2,'0');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, SEKO_LAT, SEKO_LNG);
                if(dist <= MAX_DISTANCE) {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:green">Lokasi OK (${Math.round(dist)}m)</span>`;
                    document.getElementById('btnKirimAbsen').disabled = false;
                } else {
                    document.getElementById('statusLokasi').innerHTML = `<span style="color:red">Terlalu Jauh (${Math.round(dist)}m)</span>`;
                }
            });
        }
    }

    function closeModalCeklok() {
        document.getElementById('overlayCeklok').style.display = 'none';
        document.getElementById('modalCeklok').style.display = 'none';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function submitCeklok() {
        const skrg = new Date();
        const tgl = skrg.toISOString().split('T')[0];
        let status = (skrg.getHours() > 6 || (skrg.getHours() === 6 && skrg.getMinutes() > 30)) ? "TERLAMBAT" : "HADIR";
        rtdb.ref(`presensi_guru/${tgl}/${currentRole}`).set({
            nama: db.cfg.guru, waktu: skrg.toLocaleTimeString(), status: status, ket: "-"
        }).then(() => { alert("Absen Berhasil: " + status); closeModalCeklok(); });
    }

    function submitIzinSakit() {
        const st = prompt("Ketik SAKIT atau IZIN:").toUpperCase();
        if(st !== "SAKIT" && st !== "IZIN") return;
        const ket = prompt("Alasan:");
        const tgl = new Date().toISOString().split('T')[0];
        rtdb.ref(`presensi_guru/${tgl}/${currentRole}`).set({
            nama: db.cfg.guru, waktu: new Date().toLocaleTimeString(), status: st, ket: ket
        }).then(() => { alert("Laporan terkirim!"); closeModalCeklok(); });
    }

    // --- FUNGSI GURU LAINNYA ---
    function saveAgenda() {
        if(!db.agenda) db.agenda = [];
        db.agenda.push({
            id: Date.now(), 
            kls: document.getElementById('agKls').value,
            tgl: document.getElementById('agTgl').value,
            mapel: document.getElementById('agMapel').value,
            tp: document.getElementById('agTP').value,
            materi: document.getElementById('agMateri').value,
            status: '‚è≥ Pending'
        });
        rtdb.ref('sekolah_wetan/' + currentRole.toLowerCase()).set(db).then(() => renderAgenda());
    }

    function renderAgenda() {
        const list = db.agenda || [];
        document.getElementById('bodyAgenda').innerHTML = list.map(a => `<tr><td>${a.tgl}</td><td>${a.tp}</td><td>${a.materi}</td><td>-</td><td>${a.status}</td><td><button onclick="deleteAgenda(${a.id})">üóëÔ∏è</button></td></tr>`).join('');
    }

    function updateAgTP() {
        const k = document.getElementById('agKls').value;
        const m = document.getElementById('agMapel').value;
        const tps = (db.cp || []).filter(x => x.kls == k && x.mapel == m && x.tipe == 'TP');
        document.getElementById('agTP').innerHTML = tps.map(t => `<option value="${t.isi}">${t.isi}</option>`).join('');
    }

    function toggleVisibility(id) {
        const x = document.getElementById(id);
        x.style.display = x.style.display === 'none' ? 'block' : 'none';
    }
    
    // Fungsi pembantu lainnya untuk Rapor, Siswa, Master tetap berfungsi normal sesuai struktur db yang dimuat.
</script>
</body>
</html>
